<?include('inc/include.inc.php');include('csa_function.php');echo template_header();
$q_id = intval($_GET['q_id']);$confirm_csa_dep_id = intval($_GET['confirm_csa_dep_id']);$view_year = intval($_GET['view_year']);$view_dep_id = intval($_GET['view_dep_id']);$view_id = intval($_GET['view_id']);$unlock_id = intval($_GET['unlock_id']);$submit = $_POST['submit'];
if ($submit=='confirm_unlock') {	$confirm_unlock_id = intval($_POST['confirm_unlock_id']);	$reject_reason = $_POST['reject_reason'];
	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $confirm_unlock_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$qx = true;				mysqli_autocommit($connect,FALSE);
			$to_status = 0;						$sql = "UPDATE `csa_department` SET 			`is_confirm`=0,			`csa_department_status_id`='$to_status',			`reject_reason`=?,			`reject_date` = now()				WHERE			is_confirm = 1 AND			csa_department_status_id = 1 AND			csa_department_id = ? ";						$stmt = $connect->prepare($sql);			if ($stmt) {												$stmt->bind_param('si', $reject_reason, $confirm_unlock_id);				$q = $stmt->execute();				$qx = ($qx and $q);	
				$qx = add_history($qx, $confirm_unlock_id, $to_status, 'ปลดล็อคโดยผู้อนุมัติ');				send_unlock_notification($confirm_unlock_id, $user_id, $reject_reason);
				if ($qx) {					mysqli_commit($connect);							echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';					savelog('CSA-APPROVER-UNLOCK|csa_department_id|'.$confirm_unlock_id.'|');				} else {					mysqli_rollback($connect);								echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';				}						}		}	}	} else if ($submit=='save_q') {	$update_id = intval($_POST['update_id']);
	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $update_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$csa_department_id = $row2['csa_department_id'];			$qx = true;				mysqli_autocommit($connect,FALSE);			$q_finish = 1;			$sql = "DELETE FROM csa_questionnaire_data WHERE csa_department_id=? ";			$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('i', $csa_department_id);				$q = $stmt->execute();				$qx = ($qx and $q);				}						
			$sql = "SELECT * FROM csa_questionnaire_topic WHERE parent_id = '0' AND mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			while ($row1 = mysqli_fetch_array($result1)) {				$sql = "SELECT * FROM csa_questionnaire_topic WHERE parent_id = '$row1[csa_q_topic_id]' AND mark_del = '0' ";				$result3 = mysqli_query($connect, $sql);				while ($row3 = mysqli_fetch_array($result3)) {					$topic_id = $row3['csa_q_topic_id'];					$v0 = intval($_POST['q_'.$topic_id]);					$v1 = $_POST['qc_'.$topic_id];					$sql = "INSERT INTO csa_questionnaire_data (csa_department_id, csa_q_topic_id, v, v_other) VALUES (?,?,?,?)";					$stmt = $connect->prepare($sql);					if ($stmt) {											$stmt->bind_param('iiis', $csa_department_id, $topic_id, $v0, $v1);						$q = $stmt->execute();						$qx = ($qx and $q);						}										if ($v0==0) $q_finish = 0;				}			}
			$sql = "UPDATE csa_department SET q_date = NOW(), q_finish = ? WHERE csa_department_id=? ";			$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('ii', $q_finish, $csa_department_id);				$q = $stmt->execute();				$qx = ($qx and $q);				}						if ($qx) {				mysqli_commit($connect);						echo '<div class=""><b><div class="alert alert-success">ระบบได้บันทึกข้อมูล เรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-PART1-UPDATE|csa_department_id|'.$csa_department_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class=""><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		}	}	
} else if ($submit=='save') {	$update_id = intval($_POST['update_id']);	$job_function_id = intval($_POST['job_function_id']);	$job_function_other = ($_POST['job_function_other']);	$strategy = ($_POST['strategy']);	$csa_responsibility = intval($_POST['csa_responsibility']);	$process = ($_POST['process']);	$activity_obj = ($_POST['activity_obj']);	$activity_event = ($_POST['activity_event']);	$activity_cause = ($_POST['activity_cause']);	$csa_risk_type = intval($_POST['csa_risk_type']);	$csa_risk_type_other = ($_POST['csa_risk_type_other']);	$csa_factor = intval($_POST['csa_factor']);	$csa_factor_other = ($_POST['csa_factor_other']);	$csa_control = implode(',', $_POST['csa_control']);	$csa_control_other = ($_POST['csa_control_other']);	$csa_impact_id1 = intval($_POST['csa_impact_id1']);	$csa_likelihood_id1 = intval($_POST['csa_likelihood_id1']);	$risk_level_1 = intval($_POST['risk_level_1']);	$csa_impact_id2 = intval($_POST['csa_impact_id2']);	$csa_likelihood_id2 = intval($_POST['csa_likelihood_id2']);	$risk_level_2 = intval($_POST['risk_level_2']);	$is_finish = 0;			if ($update_id>0 && $job_function_id>0) {		$qx = true;			mysqli_autocommit($connect,FALSE);		/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);  */		if ($csa_impact_id1>0 && 			$csa_likelihood_id1>0 && 			$risk_level_1>0 && 			$csa_impact_id2>0 && 			$csa_likelihood_id2>0 && 			$risk_level_2>0) {				$is_finish = 1;		}				$sql = "UPDATE `csa` SET 		`job_function_id`=?,		`job_function_other`=?,		`strategy`=?,		`csa_responsibility_id`=?,		`process`=?,		`objective`=?,		`event`=?,		`cause`=?,		`risk_type`=?,		`risk_type_other`=?,		`control`=?,		`control_other`=?,		`factor`=?,		`factor_other`=?, 		`csa_impact_id1`=?,		`csa_likelihood_id1`=?,		`csa_risk_level1`=?,		`csa_impact_id2`=?,		`csa_likelihood_id2`=?,		`csa_risk_level2`=?,		`is_finish`=?,		`last_modify` = now()			WHERE		csa_id = ? ";				$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('ississssisssisiiiiiiii', $job_function_id, $job_function_other, $strategy, $csa_responsibility, $process, $activity_obj, 				$activity_event, $activity_cause, $csa_risk_type, $csa_risk_type_other,$csa_control,$csa_control_other,$csa_factor,$csa_factor_other,				$csa_impact_id1, $csa_likelihood_id1, $risk_level_1, $csa_impact_id2, $csa_likelihood_id2, $risk_level_2, $is_finish,$update_id);			$q = $stmt->execute();			$qx = ($qx and $q);				if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-PART2-UPDATE|csa_id|'.$update_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}						$view_id = $update_id;		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}	} else if ($confirm_csa_dep_id>0) {	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $confirm_csa_dep_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {
			$qx = true;				mysqli_autocommit($connect,FALSE);
			$to_status = 2;						$sql = "UPDATE csa_department SET 			is_head1_confirm = '1',			head1_confirm_date = NOW(), 			csa_department_status_id = '$to_status' 			WHERE 			csa_department_status_id=1 AND			csa_department_id='$confirm_csa_dep_id' ";			$q = mysqli_query($connect, $sql);			$qx = ($qx and $q);				
			$qx = add_history($qx, $confirm_csa_dep_id, $to_status, 'อนุมัติ โดย ผอ.');			send_confirm_head_notification($confirm_csa_dep_id, $user_id);						if ($qx) {				mysqli_commit($connect);						echo '<div class=""><b><div class="alert alert-success">ระบบได้บันทึกข้อมูล เรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-APPROVE|csa_department_id|'.$confirm_csa_dep_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class=""><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}					}	}		} else if ($q_id>0) {	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $q_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$lock_tag = '';			$csa_department_id = $row2['csa_department_id'];			$csa_department_status_id = $row2['csa_department_status_id'];			if ($csa_department_status_id>1) {				$lock_tag = 'disabled';			}			$sql = "SELECT 				csa_q_topic_id, q_help			FROM csa_questionnaire_topic			WHERE 				parent_id <> '0' AND				mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			while ($row1 = mysqli_fetch_array($result1)) {?><input type='hidden' id='q<?=$row1['csa_q_topic_id']?>' value='<?=html2text($row1['q_help'])?>'><?			}			?><style>.csa_qtopic {	}.tr_sm tr, .tr_sm td {	padding: 2px !important;}</style><script>function show_hint(n) {	tp = '<B>'+$('#t1_'+n).html()+" "+$('#t2_'+n).html()+'</B>';	v = $('#q'+n).val();	/*$('#modal_title').html("ข้อมูลเพิ่มเติม");*/	$('#modal_title').html(tp);	$('#modal_desc').html(v);	var modal = $('#kt_modal_1');	modal.modal('show');}</script><div class="modal fade bs-modal-lg" id="kt_modal_1" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">	<div class="modal-dialog modal-lg" role="document">		<div class="modal-content">			<div class="modal-header">				<h5 class="modal-title" id="modal_title">คำแนะนำ</h5>				<button type="button" class="close" data-dismiss="modal" aria-label="Close">				</button>			</div>			<div class="modal-body" id="modal_desc">				<p></p>			</div>			<div class="modal-footer">				<button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>			</div>		</div>	</div></div><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">ตอบแบบประเมิน ส่วนที่ 1</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_id=<?=$edit_id?>&view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<form method='post' action='csa_approve.php?view_year=<?=$view_year?>' id='f1' onsubmit='return checkform()'>
<table class='table table-hover'>			<thead>			<tr>				<td width='5%'>ข้อ</td>				<td width='55%'>รายการ</td>				<td width='15%'>ประเมิน</td>				<td width='25%'>อธิบายเพิ่มเติม</td>			</tr>			</thead>			<tbody><?	$q_result = array();	$sql = "SELECT * FROM csa_questionnaire_data WHERE csa_department_id = '$csa_department_id' ";	$result2 = mysqli_query($connect, $sql);	while ($row2 = mysqli_fetch_array($result2)) {		$q_result[$row2['csa_q_topic_id']] = array($row2['v'], $row2['v_other']);	}			$i=1;		$sql = "SELECT 		*	FROM csa_questionnaire_topic	WHERE 		parent_id = '0' AND		mark_del = '0' 	ORDER BY		q_no, q_name ";	$result2 = mysqli_query($connect, $sql);	if (mysqli_num_rows($result2)>0) {		while ($row2 = mysqli_fetch_array($result2)) {?>			<tr style='font-weight: bold' bgcolor='#bbbbbb'>				<td qid='<?=$row2['csa_q_topic_id']?>' class='csa_qtopic' style='font-size: 20px;'><?=$row2['q_no']?></td>				<td qid='<?=$row2['csa_q_topic_id']?>' class='csa_qtopic' style='font-size: 20px;'><?=$row2['q_name']?></td>				<td></td>				<td></td>			</tr><?			$sql = "SELECT 				*			FROM csa_questionnaire_topic			WHERE 				parent_id = '$row2[csa_q_topic_id]' AND				mark_del = '0' 			ORDER BY				q_no, q_name ";			$result3 = mysqli_query($connect, $sql);			while ($row3 = mysqli_fetch_array($result3)) {				$v0 = $q_result[$row3['csa_q_topic_id']][0];				$v1 = $q_result[$row3['csa_q_topic_id']][1];?>			<tr class='tr_sm'>				<td qid='<?=$row3['csa_q_topic_id']?>' class='csa_qtopic' id='t1_<?=$row3['csa_q_topic_id']?>'><?=$row3['q_no']?></td>				<td qid='<?=$row3['csa_q_topic_id']?>' class='csa_qtopic' id='t2_<?=$row3['csa_q_topic_id']?>' style='cursor:pointer' onClick='show_hint("<?=$row3['csa_q_topic_id']?>")'>					<?=$row3['q_name']?>				</td>				<td><label><input type='radio' name='q_<?=$row3['csa_q_topic_id']?>' value='1' <?if ($v0==1) echo 'checked'?> <?=$lock_tag?>> ไม่มีการปฏิบัติ</label><br><label><input type='radio' name='q_<?=$row3['csa_q_topic_id']?>' value='2' <?if ($v0==2) echo 'checked'?> <?=$lock_tag?>> มีการปฏิบัติบางส่วน</label><br><label><input type='radio' name='q_<?=$row3['csa_q_topic_id']?>' value='3' <?if ($v0==3) echo 'checked'?> <?=$lock_tag?>> มีการปฏิบัติครบถ้วน</label><br>					</td>				<td><textarea class='form-control' rows='3' name='qc_<?=$row3['csa_q_topic_id']?>'><?=$v1?></textarea></td>			</tr><?							}		}	} else {		?>						<tr>				<td colspan='3'>-ยังไม่มีข้อมูล-</td>			</tr><?	}?>			</tbody>			</table>
			<br>			<br>			<input type='hidden' name='update_id' value='<?=$q_id?>'>			<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_id=<?=$edit_id?>&view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>						<button type='submit' name='submit' value='save_q' class="btn btn-success"  <?=$lock_tag?>><i class='fa fa-save'></i> บันทึก</button>			</form>		</div>	</div></div><?		}				}	echo template_footer();	exit;		
} else if ($unlock_id>0) {	/*mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */
	$sql = "SELECT 			c.*,			d1.department_name AS dep_name1,			d2.department_name AS dep_name2,			d3.department_name AS dep_name3		FROM csa_department c		LEFT JOIN department d1 ON c.department_id = d1.department_id		LEFT JOIN department d2 ON c.department_id2 = d2.department_id		LEFT JOIN department d3 ON c.department_id3 = d3.department_id		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			ca.csa_authorize_uid = ? AND 			c.mark_del = '0' ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $unlock_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$dep1 = $row2['dep_name1'];			$dep2 = $row2['dep_name2'];			$dep3 = $row2['dep_name3'];?>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">ส่งคืน รายการประเมิน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<div class='well'>			<b>				<?=$dep1?><br>				<?=$dep2?><br>				<?=$dep3?></b>			</div>			<br>						<form method='post' action='csa_approve.php?view_year=<?=$view_year?>' id='f1'>			<div class="form-group">			  <label style='font-weight: bold'>ความเห็น / เหตุผลการส่งคืน</label>				<textarea class="form-control" placeholder="โปรดระบุเหตุผล" name='reject_reason' rows='5' required><?=$row2['reject_reason']?></textarea>			</div>						
			<input type='hidden' name='confirm_unlock_id' value='<?=$unlock_id?>'>			<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_dep_id=<?=$unlock_id?>&view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type='submit' name='submit' value='confirm_unlock' class="btn btn-danger btn-sm"><i class='fa fa-unlock'></i> ยืนยันการส่งคืน</button>			</form>		</div>	</div></div><?		}				}	echo template_footer();	exit;			} else if ($view_id>0) {
	$sql = "SELECT 		c.*,		r.is_other as risk_is_other,		r.risk_type_name,		j.job_function_no,		j.job_function_name,		f.is_other as factor_is_other,		f.factor as factor_name,		rs.responsibility_desc as responsibility_desc	FROM csa c	LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'	LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'	LEFT JOIN csa_factor f ON c.factor = f.csa_factor_id AND f.mark_del = '0'	LEFT JOIN csa_responsibility rs ON c.csa_responsibility_id = rs.csa_responsibility_id AND rs.mark_del = '0'	WHERE 		csa_id = ? ";		$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $view_id);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$is_confirm = 0;			$csa_dep_id = $row2['csa_department_id'];						$sql = "SELECT 					c.*,					d1.department_name AS dep_name1,					d2.department_name AS dep_name2,					d3.department_name AS dep_name3				FROM csa_department c				LEFT JOIN department d1 ON c.department_id = d1.department_id				LEFT JOIN department d2 ON c.department_id2 = d2.department_id				LEFT JOIN department d3 ON c.department_id3 = d3.department_id				WHERE 					c.csa_department_id = '$csa_dep_id' AND 					c.mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			if ($row1 = mysqli_fetch_array($result1)) {				$dep1 = $row1['dep_name1'];				$dep2 = $row1['dep_name2'];				$dep3 = $row1['dep_name3'];				$is_confirm2 = $row1['is_confirm'];				$dep_id = $row1['department_id3']; 														$lock_tag = 'disabled';
								if ($row2['job_function_id']==999999) 					$job_function = 'อื่นๆ : '.$row2['job_function_other'];				else					$job_function = $row2['job_function_no'].' '.$row2['job_function_name'];								if ($row2['risk_is_other']==1) 					$risk_type_name = $row2['risk_type_name'].': '.$row2['risk_type_other'];				else					$risk_type_name = $row2['risk_type_name'];								if ($row2['factor_is_other']==1) 					$factor_name = $row2['factor_name'].': '.$row2['factor_other'];				else					$factor_name = $row2['factor_name'];								$control = '';				$sql="SELECT * FROM csa_control WHERE csa_control_id IN ($row2[control])";				$result1=mysqli_query($connect, $sql);				while ($row1 = mysqli_fetch_array($result1)) {						if ($row1['is_other']==1) 						$control .= '- '.$row1['control_name'].': '.$row2['control_other'].'<BR>';					else						$control .= '- '.$row1['control_name'].'<BR>';				}?>
<style>.tr_sm tr, .tr_sm td {	padding: 2px !important;}</style><script language='JavaScript'>
<?	echo "\n risk_mat = {}; \n";		$d = array();	$sql2="SELECT * FROM `csa_risk_matrix` ";	$result3=mysqli_query($connect, $sql2);	while ($row3 = mysqli_fetch_array($result3)) {		$d[$row3['csa_impact_id']][$row3['csa_likelihood_id']] = $row3['csa_risk_level']; 	}?>
risk_mat = [<?	for ($i=1; $i<=5; $i++) {		if ($i==1) 			echo '[';		else 			echo ',[';		for ($j=1; $j<=5; $j++) {			if ($j>1) echo ',';			echo $d[$i][$j];		}		echo "]\n";	}?>];
function risk_level_color(r) {	switch (r) {		case 0: return '';		case 1: return '#9dff9c';		case 2: return '#f5ff9c';		case 3: return '#ffd29c';		case 4: return '#ff9c9c';	}}function risk_level_name(r) {	switch (r) {		case 0: return '';		case 1: return 'ต่ำ';		case 2: return 'ปานกลาง';		case 3: return 'สูง';		case 4: return 'สูงมาก';	}}function risk_level_acceptable(r) {	if  (r>=3) 		return 'ไม่เพียงพอ';	else		return 'เพียงพอ';}function risk_level_acceptable_color(r) {	if  (r>=3) 		return '#ff9c9c';	else		return '#9dff9c';}
function cal_level(w) {	var i = parseInt($('#csa_impact_id'+w).val())-1;	var j = parseInt($('#csa_likelihood_id'+w).val())-1;		if (isNaN(i) || isNaN(j)) {		$('#risk_level_'+w+'_div').css('background-color', '#ffffff');		$('#risk_level_'+w+'_div').html('');		$('#risk_level_'+w+'_txt').val(0);		$('#risk_level_'+w+'_1_div').html('');		$('#risk_level_'+w+'_1_div').css('background-color', '#ffffff');	} else {		lv = risk_mat[i][j];		$('#risk_level_'+w+'_div').css('background-color', risk_level_color(lv));		$('#risk_level_'+w+'_div').html(risk_level_name(lv));		$('#risk_level_'+w+'_txt').val(lv);		$('#risk_level_'+w+'_1_div').html(risk_level_acceptable(lv));		$('#risk_level_'+w+'_1_div').css('background-color', risk_level_acceptable_color(lv));	}}
function checkform() {	var v = $('input[name=job_function_id]:checked', '#f1').val();	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		return false;	}		var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		alert('กรุณาระบุ การควบคุมที่มีอยู่');		$('input[name^=csa_control]')[0].focus();		return false;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			alert('กรุณาระบุ การควบคุมที่มีอยู่อื่นๆ');			$('#csa_control_other').focus();			return false;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		alert('ผลกระทบหลังการควบคุม ต้องไม่เกินผลกระทบก่อนการควบคุม');		$('#csa_impact_id2').focus();		$('#csa_impact_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_impact_id2').css("border","");	}	if (l2>l1) {		alert('โอกาสหลังการควบคุม ต้องไม่เกินโอกาสก่อนการควบคุม');		$('#csa_likelihood_id2').focus();		$('#csa_likelihood_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_likelihood_id2').css("border","");	}		return true;}
function check_csa_factor_other() {	var has_other = $("#csa_factor option:selected").attr("is_other");	if (has_other>0) {		$('#csa_factor_other').show();	} else {		$('#csa_factor_other').hide();	}		}
function check_csa_control_other() {	var has_other = 0;	$(".csa_control").each(function() {		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;	});			if (has_other>0) {		$('#csa_control_other_div').show();	} else {		$('#csa_control_other_div').hide();	}}
$(function () {	save_tab();		$('#csa_impact_id1, #csa_likelihood_id1').change(function() {		cal_level("1");	}).change();	$('#csa_impact_id2, #csa_likelihood_id2').change(function() {		cal_level("2");	}).change();
	var csa_factor_old = parseInt($("#csa_factor_old").val());		$('.csa_control').on('click', function() {		check_csa_control_other();	});	
	$("#csa_risk_type").change(function() {		var rt = parseInt($("#csa_risk_type").val());		$.post( "jobfunction_content.php", { action: 'risktype', parent:rt, data:csa_factor_old})		.done(function( data ) {			$("#csa_factor_div").html(data);
			$('#csa_factor').change(function() {				check_csa_factor_other();			});						});				$('#csa_factor_other').hide();	}).change();			check_csa_factor_other();	check_csa_control_other();});  
function toggle_risk_mat() {  if ( $( "#risk_mat" ).first().is( ":hidden" ) ) {    $( "#risk_mat" ).slideDown( "slow" );  } else {    $( "#risk_mat" ).slideUp();  }}
function save_tab() {	if (location.hash) {	  $('a[href=\'' + location.hash + '\']').tab('show');	}	var activeTab = localStorage.getItem('activeTab');	if (activeTab) {	  $('a[href="' + activeTab + '"]').tab('show');	}
	$('body').on('click', 'a[data-toggle=\'tab\']', function (e) {	  e.preventDefault()	  var tab_name = this.getAttribute('href')	  if (history.pushState) {		history.pushState(null, null, tab_name)	  }	  else {		location.hash = tab_name	  }	  localStorage.setItem('activeTab', tab_name)
	  $(this).tab('show');	  return false;	});	$(window).on('popstate', function () {	  var anchor = location.hash ||		$('a[data-toggle=\'tab\']').first().attr('href');	  $('a[href=\'' + anchor + '\']').tab('show');	});	}
function activaTab(tab){  $('.nav-tabs a[href="#' + tab + '"]').tab('show');};</script>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">รายการประเมิน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>&view_dep_id=<?=$csa_dep_id?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>
			<div class=''>			<b>				<?=$dep1?><br>				<?=$dep2?><br>				<?=$dep3?></b>			</div>			<br>
<div class='row'>	<div class='col-md-8'>						<div class='note note-danger' style='font-size:13px'>	<?=gen_audit_history($csa_dep_id)?>	</div>	</div>	</div>				<form method='post' action='csa_approve.php?view_id=<?=$view_id?>&view_year=<?=$view_year?>' id='f1' onsubmit='return checkform()'>
			<div class="form-group">			  <label style='font-weight: bold'>ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน</label>			  <table class='table table-hover table-sm'>			  <thead>				<tr>					<td width='5%'></td>					<td width='60%'></td>					<td width='5%'>Require</td>				</tr>				</thead>				<tbody><?	$sql2="SELECT 		d.*,		d1.department_name AS dep1,		d2.department_name AS dep2,		d3.department_name AS dep3	FROM `job_function` d	LEFT JOIN `department` d1 ON  d.department_id = d1.department_id AND d1.mark_del = '0'	LEFT JOIN `department` d2 ON  d.department_id2 = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d.department_id3 = d3.department_id AND d3.mark_del = '0'	WHERE 		d.parent_id = '0' AND		d.mark_del = '0' AND		d.department_id3 = '$dep_id'	ORDER BY 		job_function_no, job_function_id";	$result1=mysqli_query($connect, $sql2);	while ($row1 = mysqli_fetch_array($result1)) {?>			  			<tr class='tr_sm'>				<td><input type='radio' name='job_function_id' class='job_function_id' value='<?=$row1['job_function_id']?>' required <?if ($row2['job_function_id']==$row1['job_function_id']) echo 'checked'?> <?=$lock_tag?>> </td>				<td><?=$row1['job_function_no']?> <?=$row1['job_function_name']?></td>				<td><?if ($row1['is_require']==1) echo '<i class="fa fa-check"></i>'?></td>			</tr><?}?>			<tr class='tr_sm'>				<td><input type='radio' name='job_function_id' class='job_function_id' value='999999' required <?if ($row2['job_function_id']==999999) echo 'checked'?> <?=$lock_tag?>> </td>				<td><div class='row'>					<div class='col-md-2'>อื่นๆ โปรดระบุ</div>					<div class='col-md-10'><input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='job_function_other' id='job_function_other' value='<?=$row2['job_function_other']?>' <?=$lock_tag?>></div>					</div>				</td>				<td></td>				<td></td>				<td></td>			</tr>			</tbody>			</table>			</div>								<div class="form-group">			  <label style='font-weight: bold'>กลยุทธ์องค์กร</label>				<textarea class="form-control" placeholder="กลยุทธ์องค์กร" name='strategy' rows='2' required <?=$lock_tag?>><?=$row2['strategy']?></textarea>			</div>						<div class="form-group">			  <label style='font-weight: bold'>ขอบเขตหน้าที่ความรับผิดชอบของกลุ่มงาน</label>			  <select name='csa_responsibility' id='csa_responsibility' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_responsibility WHERE csa_year = '$view_year' AND department_id3 = '$dep_id' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_responsibility_id']?>' <?if ($row2['csa_responsibility_id']==$row1['csa_responsibility_id']) echo 'selected'?>><?=$row1['responsibility_desc']?></option><?}?>			  			  </select>			</div>				<div class="form-group">			  <label style='font-weight: bold'>กระบวนการปฏิบัติงาน</label>				<textarea class="form-control" placeholder="กระบวนการปฏิบัติงาน" name='process' rows='2' required <?=$lock_tag?>><?=$row2['process']?></textarea>			</div>						<div class="form-group">			  <label style='font-weight: bold'>วัตถุประสงค์</label>				<textarea class="form-control" placeholder="วัตถุประสงค์" name='activity_obj' rows='2' required <?=$lock_tag?>><?=$row2['objective']?></textarea>			</div>									<div class="form-group">			  <label style='font-weight: bold'>เหตุการณ์ความเสี่ยง</label>				<textarea class="form-control" placeholder="เหตุการณ์ความเสี่ยง" name='activity_event' rows='2' required <?=$lock_tag?>><?=$row2['event']?></textarea>			</div>									<div class="form-group">			  <label style='font-weight: bold'>สาเหตุที่ทำให้เกิดความเสี่ยง</label>				<textarea class="form-control" placeholder="สาเหตุที่ทำให้เกิดความเสี่ยง" name='activity_cause' rows='2' required <?=$lock_tag?>><?=$row2['cause']?></textarea>			</div>									<div class="form-group">			  <label style='font-weight: bold'>ประเภทความเสี่ยง</label>			  <select name='csa_risk_type' id='csa_risk_type' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_risk_type";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_risk_type_id']?>' <?if ($row2['risk_type']==$row1['csa_risk_type_id']) echo 'selected'?>><?=$row1['risk_type_name']?></option><?}?>			  			  </select>			</div>				<div class="form-group" id='csa_factor_div'>			  <label style='font-weight: bold'>ปัจจัยเสี่ยง</label>			  <select name='csa_factor' id='csa_factor' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option>			  </select>			</div>				<div class="form-group" id='csa_factor_other' style='display:none'>				<input type="text" class="form-control" placeholder="โปรดระบุปัจจัยเสี่ยงอื่นๆ" name='csa_factor_other' value='<?=$row2['factor_other']?>'>			</div>						<div class="form-group">			  <label style='font-weight: bold'>การควบคุมที่มีอยู่</label><br>			  <div class="checkbox-group require"><?$control_array = explode(',', $row2['control']);$sql="SELECT * FROM csa_control";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<label style='margin: 0px'><input type='checkbox' name='csa_control[]' class='csa_control' value='<?=$row1['csa_control_id']?>' is_other='<?=$row1['is_other']?>' <?if (in_array($row1['csa_control_id'], $control_array)) echo 'checked'?> <?=$lock_tag?>> <?=$row1['control_name']?></label><br><?}?>			  			  </select>
				</div>			</div>			<div class="form-group" id='csa_control_other_div' style='display:none'>				<input type="text" class="form-control" placeholder="โปรดระบุการควบคุมที่มีอยู่อื่นๆ" name='csa_control_other' id='csa_control_other' value='<?=$row2['control_other']?>'>			</div>						<div class='row'>			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>
				<div class="">					<b>การประเมินความเสี่ยง <u>ก่อน</u> การควบคุม</b><br><br>
				<div class="form-group">					<label>ผลกระทบ</label>					<select name='csa_impact_id1' id='csa_impact_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id1']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label>โอกาส</label>					<select name='csa_likelihood_id1' id='csa_likelihood_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id1']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_1_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>							</div>				<div class='col-md-1'></div>
			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>				<div class="">					<b>การประเมินความเสี่ยง <u>หลัง</u> การควบคุม</b><br><br>				<div class="form-group">					<label>ผลกระทบ</label>					<select name='csa_impact_id2' id='csa_impact_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id2']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label>โอกาส</label>					<select name='csa_likelihood_id2' id='csa_likelihood_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id2']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_2_div' style='background:#ffffff; padding: 10; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_2_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>										<br>			</div>			</div>
			<div id='risk_mat' style='display:none'></div>						<input type='hidden' id='csa_factor_old' value='<?=$row2['factor']?>'>			<input type='hidden' name='risk_level_1' id='risk_level_1_txt' value=''>			<input type='hidden' name='risk_level_2' id='risk_level_2_txt' value=''>			<input type='hidden' name='update_id' value='<?=$view_id?>'>			<button type='button' class="btn btn-default btn-sm" data-toggle="modal" href="#basic"><i class='fa fa-search'></i> ดู Matrix</button>
<div class="modal fade" id="basic" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">	<div class="modal-dialog">		<div class="modal-content">			<div class="modal-header">				<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>				<h4 class="modal-title">Risk Matrix</h4>			</div>			<div class="modal-body"><?=gen_risk_mat()?></div>			<div class="modal-footer">				<button type="button" class="btn dark btn-outline" data-dismiss="modal">ปิด</button>			</div>		</div>		<!-- /.modal-content -->	</div>	<!-- /.modal-dialog --></div>
						</form>		</div>		<br>
						<button type='button' class="btn btn-primary btn-sm" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>&view_dep_id=<?=$csa_dep_id?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>	</div></div>
<?						}		}	}	echo template_footer();	exit;	
} else if ($view_dep_id>0) {?>	<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">ส่วนที่ 2 แบบประเมินการควบคุมภายใน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary btn-sm" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<br><?		
	$sql = "SELECT 		c.*,		d1.department_name AS dep_name1,		d2.department_name AS dep_name2,		d3.department_name AS dep_name3	FROM csa_department c	LEFT JOIN department d1 ON c.department_id = d1.department_id	LEFT JOIN department d2 ON c.department_id2 = d2.department_id	LEFT JOIN department d3 ON c.department_id3 = d3.department_id	JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id	WHERE 		c.is_enable='1' AND		c.csa_department_id = ? AND 		ca.csa_authorize_uid = ? AND 		c.mark_del = '0' ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $view_dep_id, $user_code);		$stmt->execute();		$result1 = $stmt->get_result();		if ($row1 = mysqli_fetch_assoc($result1)) {						$is_confirm = $row1['is_confirm'];			$dep_id = $row1['department_id3'];			$csa_department_status_id = $row1['csa_department_status_id'];			if ($row1['reject_date']!='' && $row1['reject_reason']!='') {				$is_reject = 1;				$reject_reason = $row1['reject_reason'];			} else {				$is_reject = 0;				$reject_reason = '';			}						$is_finish_all = true;
			if ($is_confirm==1) {?>			<div class='row'>			<div class='col-md-1'><i class='fa fa-check-circle' style='font-size:80px; color: green'></i></div>			<div class='col-md-11'>				<b>				<?=$row1['dep_name1']?><br>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?			} else { ?>			<div class='row'>			<div class='col-md-12'>				<b>				<?=$row1['dep_name1']?><br>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?			}?>			<div class="tabbable-custom ">	<ul class="nav nav-tabs " id='myTab'>		<li class="active"><a href="#tab1" data-toggle="tab" aria-expanded="true">กิจกรรม</a></li>		<li class=""><a href="#tab2" data-toggle="tab" aria-expanded="false">Job Function ที่ต้องประเมิน</a></li>				<li class=""><a href="#tab3" data-toggle="tab" aria-expanded="false">รายงานผลการตรวจสอบ</a></li>				<li class=""><a href="#tab4" data-toggle="tab" aria-expanded="false">ประวัติการเปลี่ยนแปลง</a></li>			</ul>	<div class="tab-content">		<br>		<div class="tab-pane active" id="tab1">						<table class='table table-hover'>			<thead>			<tr>				<td width='3%'>ลำดับ</td>				<td width='50%'>Job Function</td>				<td width='25%'>ประเภทความเสี่ยง</td>				<td width='20%'>สถานะ</td>			</tr>			</thead>			<tbody><?				$j_list = array(); 				$i=1;					$sql = "SELECT 					c.*,					r.is_other as risk_is_other,					r.risk_type_name,					j.job_function_no,					j.job_function_name				FROM csa c				LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'				LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'				WHERE 					c.csa_year = '$view_year' AND 					c.mark_del = '0' AND 					c.csa_department_id = '$row1[csa_department_id]' ";				$result2 = mysqli_query($connect, $sql);				if (mysqli_num_rows($result2)>0) {					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];						if ($row2['job_function_id']==999999) 							$job_function = 'อื่นๆ : '.$row2['job_function_other'];						else							$job_function = $row2['job_function_no'].' '.$row2['job_function_name'];												if ($row2['risk_is_other']==1) 							$risk_type_name = $row2['risk_type_other'];						else							$risk_type_name = $row2['risk_type_name'];												if ($row2['is_finish']==0) $is_finish_all = false;?>			<tr onClick='document.location="csa_approve.php?view_id=<?=$row2['csa_id']?>&view_year=<?=$view_year?>"' style='cursor: pointer;'>				<td><?=$i++?></td>				<td><?=$job_function?></td>				<td><?=$risk_type_name?></td>				<td><font color='<?=csa_status_color($row2['is_finish'])?>' style='font-weight: bold'><?=csa_status($row2['is_finish'])?></font></td>			</tr><?					}				} else {		?>						<tr>				<td colspan='8'>-ยังไม่มีข้อมูล-</td>			</tr><?				}?>			</tbody>			</table>		</div>				<div class="tab-pane" id="tab2">		<?$is_pass_all = gen_job_function($dep_id, $view_dep_id, $view_year)?>		</div>
		<div class="tab-pane" id="tab3">			<?=gen_audit_history($view_dep_id)?>		</div>		<div class="tab-pane" id="tab4">			<?=gen_change_history($view_dep_id)?>				</div>			</div></div>					<? if ($is_reject==1) {?>	
		<div class='row'>		<div class='col-md-8'>							<div class='note note-danger' style='font-size:13px'>		<b>เหตุผลการส่งคืน / สิ่งที่ต้องแก้ไข</b><br>		<?=$reject_reason?>		</div>
<?}?>
		<button type='button' class="btn btn-primary btn-sm" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button><? if ($is_confirm==0) {		echo 'ยังไม่ได้ยืนยันข้อมูล ';	} else {		echo 'ยืนยันข้อมูลแล้ว ';				if ($is_confirm==1 && $csa_department_status_id<=1) { // ยังไม่อนุมัติ?>			<a href='csa_approve.php?unlock_id=<?=$view_dep_id?>&view_year=<?=$view_year?>' class="btn btn-danger btn-sm"><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a><?		} else {			echo 'รายการอนุมัติแล้วไม่สามารถส่งคืนได้';		}	}?>			<br>			<br>			<br>			<br>			<br>		</div>		</div>
<?			}		}?>
			<br>		</div>	</div></div>
<?	echo template_footer();	exit;	}

if ($view_year==0) {	$view_year=date('Y')+543;}?>
<div class='row'>	<div class='col-md-1'>เลือก ปี</div>	<div class='col-md-2'>		<select name='view_year' class="form-control" onChange='document.location="csa_approve.php?view_year="+this.value'>			<option value='<?=$view_year-2?>'><?=$view_year-2?></option>			<option value='<?=$view_year-1?>'><?=$view_year-1?></option>			<option value='<?=$view_year?>' selected><?=$view_year?></option>			<option value='<?=$view_year+1?>'><?=$view_year+1?></option>			<option value='<?=$view_year+2?>'><?=$view_year+2?></option>		<select>	</div></div><br>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">รายการประเมิน ที่รอการพิจารณา</span>					<span class="caption-helper"></span>				</div>				<div class="actions">				</div>			</div>			<br>
<?	if ($view_year>0) { 	?>							<table class='table table-hover'>			<thead>			<tr align='center'>				<td width='3%'>ลำดับ</td>				<td width='30%'>สังกัดฝ่ายงาน</td>				<td width='25%' colspan='2'>ส่วนที่ 1</td>				<td width='25%' colspan='2'>ส่วนที่ 2</td>				<td width='15%'>สถานะ</td>			</tr>			</thead>			<tbody><?				/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */		$i=1;		$sql = "SELECT 				c.*,				d1.department_name AS dep_name1,				d2.department_name AS dep_name2,				d3.department_name AS dep_name3,				st.csa_department_status_color,				st.csa_department_status_name			FROM csa_department c			LEFT JOIN department d1 ON c.department_id = d1.department_id			LEFT JOIN department d2 ON c.department_id2 = d2.department_id			LEFT JOIN department d3 ON c.department_id3 = d3.department_id			LEFT JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id			LEFT JOIN csa_department_status st ON st.csa_department_status_id = c.csa_department_status_id			WHERE 				c.is_enable='1' AND				c.csa_year = ? AND 				c.mark_del = '0' AND 				ca.csa_authorize_uid = ? ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('is', $view_year, $user_code);			$stmt->execute();			$result1 = $stmt->get_result();			if (mysqli_num_rows($result1)>0) {				while ($row1 = mysqli_fetch_assoc($result1)) {								$q_finish = $row1['q_finish'];					$is_confirm = $row1['is_confirm'];					$csa_department_status_id = $row1['csa_department_status_id'];					$is_finish_all = true;
									$j_list = array();					$j_detail_list = array();					$is_pass_all = false;					$sql = "SELECT job_function_id FROM csa WHERE mark_del = '0' AND csa_department_id = '$row1[csa_department_id]' ";					$result2 = mysqli_query($connect, $sql);					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];					}										$cnt_require = 0;					$sql = "SELECT * FROM job_function 					WHERE 						(is_require = '1') AND						mark_del = '0' AND 						department_id3 = '$row1[department_id3]' 					ORDER BY 						job_function_no, job_function_id";					$result2 = mysqli_query($connect, $sql);					if (mysqli_num_rows($result2)>0) {						$is_pass_all = true; 						while ($row2 = mysqli_fetch_array($result2)) {							if (in_array($row2['job_function_id'], $j_list)) { 								$j_detail_list[] = '<font color="green"><i class="fa fa-check"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';							} else {								$j_detail_list[] = '<font color="red"><i class="fa fa-times"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';								$is_pass_all = false;							}							$cnt_require++;						}					}
					$cnt_total = 0;					$cnt_finish = 0;					$sql = "					SELECT  						SUM(case when is_finish = 1 then 1 else 0 end) AS cnt_finish,						COUNT(*) AS cnt_total					FROM csa c					WHERE 						c.csa_year = '$view_year' AND 						c.mark_del = '0' AND 						c.csa_department_id = '$row1[csa_department_id]' ";					$result2 = mysqli_query($connect, $sql);					$row2 = mysqli_fetch_array($result2);					$cnt_finish = $row2['cnt_finish'];					$cnt_total = $row2['cnt_total'];?>			<tr>				<td style='border-right: 1px solid #eeeeee'><?=$i++?></td>				<td style='border-right: 1px solid #eeeeee'>					<?=$row1['dep_name1']?><br>					<?=$row1['dep_name2']?><br>					<?=$row1['dep_name3']?>				</td>				<td width='15%'>					<? if ($q_finish==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ประเมินครบ<br><br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> ยังประเมินไม่ครบ<br>					<? }?>				</td>				<td width='10%' style='border-right: 1px solid #eeeeee'>					<a href='csa_approve.php?q_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn btn-default btn-sm"><i class='fa fa-search'></i> ทำแบบประเมิน</a>				</td>				<td width='15%'>					<? if ($is_confirm==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ยืนยันแล้ว<br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> อยู่ระหว่างจัดทำ<br>					<? }?>					กิจกรรมทั้งหมด : <?=$cnt_total?><br>					กิจกรรมที่บังคับ : <?=$cnt_require?><br>					กิจกรรมที่เสร็จ : <?=$cnt_finish?><br><br>				</td>				<td width='10%' style='border-right: 1px solid #eeeeee'>					<a href='csa_approve.php?view_dep_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn btn-default btn-sm"><i class='fa fa-search'></i> แสดงแบบประเมิน</a><br><br>					<? if ($is_confirm==1 && $csa_department_status_id==1) {?>						<a href='csa_approve.php?unlock_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn btn-danger btn-sm"><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } else if ($csa_department_status_id>1) {?>						<a href='#' class="btn btn-default btn-sm" disabled title='รายการได้รับการอนุมัติแล้ว ไม่สามารถส่งคืนได้'><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } ?>				</td>				<td>					<font color='<?=$row1['csa_department_status_color']?>' style='font-weight: bold'><?=$row1['csa_department_status_name']?></font>					<br>					<br><?if ($q_finish==1 && $is_confirm==1 && $csa_department_status_id==1) {?>								<a href='csa_approve.php?confirm_csa_dep_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>' class="btn btn-success btn-sm" onClick='return confirm("หากยืนยันแล้วท่านจะไม่สามารถแก้ไขข้อมูลได้อีก ต้องการดำเนินการหรือไม่?")'><i class='fa fa-check'></i> อนุมัติการประเมิน</a><? }?>									</td>			</tr><?				}			} else {		?>						<tr>				<td colspan='5'>-ยังไม่มีข้อมูล-</td>			</tr><?			}?>			</tbody>			</table>
<?		}?>			<br>			<br>			<br>		</div>	</div></div>
<?	}?>	<br><br>
<?echo template_footer();?>