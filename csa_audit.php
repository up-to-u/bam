<?include('inc/include.inc.php');include('csa_function.php');echo template_header();
$action = $_GET['action'];$depid = intval($_GET['depid']);$edit_id = intval($_GET['edit_id']);$del_id = intval($_GET['del_id']);$update_id = intval($_POST['update_id']);$submit = $_POST['submit'];
$view_year = intval($_GET['view_year']);if ($view_year==0) {	$view_year=date('Y')+543;}if ($submit=='update' && $update_id>0) {	$audit_date = ($_POST['audit_date']);	$audit_desc = ($_POST['audit_desc']);	$department_id = intval($_POST['department_id']);	$department_id2 = intval($_POST['department_id2']);	$department_id3 = intval($_POST['department_id3']);	$is_require = intval($_POST['is_require']);	$auditor = intval($_POST['auditor']);	$auditor_other = ($_POST['auditor_other']);	$is_close = intval($_POST['is_close']);	$close_remark = ($_POST['close_remark']);	if ($audit_date!='' && $audit_desc!='' && $department_id>0 && $department_id2>0 && $department_id3>0) {		$qx = true;			mysqli_autocommit($connect,FALSE);				$sql = "UPDATE csa_audit SET		`audit_date` = ?, 		`audit_desc` = ?, 		`department_id` = ?, 		`department_id2` = ?, 		`department_id3` = ?,		`auditor` = ?,		`auditor_other` = ?,		`is_close` = ?,		`close_remark` = ?,		`last_modify` = now() 		WHERE csa_audit_id = ? ";		$stmt = $connect->prepare($sql);						if ($stmt) {								$stmt->bind_param('ssiiiisisi', $audit_date, $audit_desc, $department_id, $department_id2, $department_id3, $auditor, $auditor_other, $is_close, $close_remark, $update_id);			$stmt->execute();			$q = $stmt->execute();			$qx = ($qx and $q);	
			if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-ADMIN-RISK-AUDIT-UPDATE|csa_audit_id|'.$update_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}		} else if ($submit=='add') {	$audit_date = addslashes($_POST['audit_date']);	$audit_desc = addslashes($_POST['audit_desc']);	$department_id = intval($_POST['department_id']);	$department_id2 = intval($_POST['department_id2']);	$department_id3 = intval($_POST['department_id3']);	$csa_year = intval($_POST['csa_year']);	$auditor = intval($_POST['auditor']);	$auditor_other = ($_POST['auditor_other']);	$is_close = intval($_POST['is_close']);	$close_remark = ($_POST['close_remark']);		if ($audit_date!='' && $audit_desc!='' && $department_id>0 && $department_id2>0 && $department_id3>0 && $csa_year>0) {		$qx = true;			mysqli_autocommit($connect,FALSE);				$sql = "INSERT INTO `csa_audit` (`csa_year`, `audit_date`, `audit_desc`, `department_id`, `department_id2`, `department_id3`, `auditor`, `auditor_other`, `is_close`, `close_remark`, `create_date`) VALUES 		(?,?,?,?,?,?,?,?,?,?,now()) ";				$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('issiiiisis', $csa_year, $audit_date, $audit_desc, $department_id, $department_id2, $department_id3, $auditor, $auditor_other, $is_close, $close_remark);			$q = $stmt->execute();			$qx = ($qx and $q);				$insert_id = mysqli_insert_id($connect);			
			if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-ADMIN-RISK-AUDIT-ADD|csa_audit_id|'.$insert_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		}	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}		
	} else if ($del_id>0) {
	$qx = true;		mysqli_autocommit($connect,FALSE);		$sql = "UPDATE csa_audit SET `mark_del` = 1, `last_modify` = now() WHERE csa_audit_id = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $del_id);		$stmt->execute();		$q = $stmt->execute();		$qx = ($qx and $q);					if ($qx) {			mysqli_commit($connect);					echo '<div class="container"><b><div class="alert alert-success">ระบบได้ลบข้อมูลเรียบร้อยแล้ว</div></b><br></div>';			savelog('CSA-ADMIN-RISK-AUDIT-DEL|csa_audit_id|'.$del_id.'|');		} else {			mysqli_rollback($connect);						echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถลบข้อมูลได้</div></b><br></div>';		}	}	} else if ($edit_id>0) {
	$sql="SELECT * FROM `csa_audit` WHERE csa_audit_id = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $edit_id);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {?>
<link href="jquery-ui-1.12.0/jquery-ui.css" rel="stylesheet"><script src="jquery-ui-1.12.0/jquery-ui.js"></script><script language='JavaScript'>function confirm_delete() {	if (confirm("โปรดยืนยันว่าคุณแน่ใจที่จะลบ")) {		document.location = "csa_audit.php?depid=<?=$depid?>&del_id=<?=$row2['csa_audit_id']?>";	}}
function checkform() {	var v = $('input[name=auditor]:checked', '#form1').val()	if (v=='') {		alert('กรุณาระบุ ผู้ตรวจสอบ');		$('input[name^=auditor]')[0].focus();		return false;	} else {		var has_other = 0;		$(".auditor").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#auditor_other').val()=='') {			alert('กรุณาระบุ ผู้ตรวจสอบอื่นๆ');			$('#auditor_other').focus();			return false;		}			}		return true;}$(function () {	$(".datepicker-th").datepicker({ 		changeMonth: true,		changeYear: true,			yearRange: '-100:+0',		dateFormat: 'yy-mm-dd', 		dayNames: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'],		dayNamesMin: ['อา','จ','อ','พ','พฤ','ศ','ส'],		montdocames: ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'],		monthNamesShort: ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.']	});			var d1 = parseInt($("#d1").val());	var d2 = parseInt($("#d2").val());	var d3 = parseInt($("#d3").val());		$(".auditor").change(function() {		var has_other = 0;		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;		if (has_other==0) {			$('#auditor_other').val('');		}	});	$("#is_close").change(function() {		var v = $("#is_close").prop("checked");		if (v) {			$('#is_close_div').show();		} else {			$('#is_close_div').hide();			$('#close_remark').val('');		}	}).change();					$("#department_l1").change(function() {		var d = parseInt($("#department_l1").val());		$.post( "jobfunction_content.php", { action: 'audit_list', parent: d, data:d2, lv: 1 })		.done(function( data ) {			$("#d_lv2").html(data);			$("#d_lv3").html("<div class='form-group' id='d_lv3'><label>กลุ่ม</label><select name='department_id3' id='department_l3' class='form-control' disabled></select></div>");			$("#department_l2").change(function() {				var d = parseInt($("#department_l2").val());				if (d>0) {					$.post( "jobfunction_content.php", { action: 'audit_list', parent:d, data: d3, lv: 2 })					.done(function( data ) {						$("#d_lv3").html(data);					});					}			}).change();						});		}).change();	}); </script>
<section class="panel">	<header class="panel-heading">		<h2 class="panel-title">แก้ไข รายงานผลการตรวจสอบ</h2>	</header>	<div class="panel-body">	
	<form method='post' id='form1' action='csa_audit.php?depid=<?=$depid?>' onsubmit='return checkform()'>	<div class="form-group">	  <label>ปี</label>	  <input type="text" class="form-control input-sm" name='csa_year' required readonly value='<?=$row2['csa_year']?>'>	</div>		<div class="form-group">	  <label>สายงาน</label>	  <select name='department_id' id='department_l1' class="form-control" required>		<option value='1'>--- เลือก ---</option><?
$sql="SELECT * FROM department WHERE department_level_id = 3 ORDER BY department_id";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['department_id']?>' <?if ($row1['department_id']==$row2['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><?}?>		</select>	</div>	<div class="form-group">	  <label>ฝ่าย</label>	  <div id='d_lv2'><select name='department_id2' id='department_l2' class="form-control input-sm" disabled></select></div>	</div>		<div class="form-group">	  <label>กลุ่ม</label>	  <div id='d_lv3'><select name='department_id3' id='department_l3' class="form-control input-sm" disabled></select></div>	</div>
	<br>	<br>	<div class="form-group">	  <label>วันที่ตรวจ</label>	  <input type="text" class="form-control input-sm datepicker-th" name='audit_date' placeholder="คลิกเพื่อเลือก" required readonly value='<?=$row2['audit_date']?>'>	</div>	<div class="form-group">	  <label>รายละเอียด รายงานผลการตรวจสอบ</label>	  <textarea class="form-control" name='audit_desc' rows='5' required placeholder="รายงานผลการตรวจสอบ"><?=$row2['audit_desc']?></textarea>	</div>	<div class="form-group">	  <label>ผู้ตรวจสอบ</label><br>	  <div class="checkbox-group require"><? for ($i=0; $i<4; $i++) {?>	  	  <label style='margin: 0px'><input type='radio' name='auditor' class='auditor' value='<?=$i?>' required is_other='<?=($i==3)? 1:0?>' <?if ($row2['auditor']==$i) echo 'checked'?>> <?=auditor_name($i)?></label><br><? }?>	  	  </div>		  <input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='auditor_other' id='auditor_other' value='<?=$row2['auditor_other']?>'>	</div>		<hr>	<div class="form-group">	  <label></label><br>	  <label style='margin: 0px'><input type='checkbox' name='is_close' id='is_close' value='1' <?if ($row2['is_close']==1) echo 'checked'?>> ปิดประเด็นตรวจสอบแล้ว</label><br>	</div>	<div class="form-group" id='is_close_div' style='display:none'>	  <label>รายละเอียด การปิดประเด็นตรวจสอบ</label>	  <textarea class="form-control" name='close_remark' id='close_remark' rows='5' required placeholder="การปิดประเด็นตรวจสอบ"><?=$row2['close_remark']?></textarea>	</div>	<br>			<br>		<input type='hidden' id='d1' value='<?=$row2['department_id']?>'>		<input type='hidden' id='d2' value='<?=$row2['department_id2']?>'>		<input type='hidden' id='d3' value='<?=$row2['department_id3']?>'>				<input type='hidden' name='update_id' value='<?=$row2['csa_audit_id']?>'>		<button type='button' class="btn btn-primary" onClick="document.location='csa_audit.php?depid=<?=$depid?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>		<button type='submit' name='submit' value='update' class="btn btn-success"><i class='fa fa-save'></i> บันทึก</button>		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;		<button type='button' name='button' class='btn btn-danger' onClick='confirm_delete()' id='confirm_btn'><i class='fa fa-times'></i> ลบ</button>	</form>	</div></section>
		  <?		}	}	
	echo template_footer();	exit;	} else if ($action=='add') {	if ($view_year>0 && $depid>0) {				$sql="SELECT 			d3.department_id as d3_id, 			d2.department_id as d2_id,			d1.department_id as d1_id, 			d3.department_name as d3_name, 			d2.department_name as d2_name, 			d1.department_name as d1_name 		FROM `department` d1 		LEFT JOIN `department` d2 ON  d1.parent_id = d2.department_id AND d2.mark_del = '0'		LEFT JOIN `department` d3 ON  d2.parent_id = d3.department_id AND d3.mark_del = '0'				WHERE d1.department_id = ? ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('i', $depid);			$stmt->execute();			$result2 = $stmt->get_result();			if ($row2 = mysqli_fetch_assoc($result2)) {				$d3 = $row2['d3_id'];				$d2 = $row2['d2_id'];				$d1 = $row2['d1_id'];				$d3_name = $row2['d3_name'];			}		}		
?><link href="jquery-ui-1.12.0/jquery-ui.css" rel="stylesheet"><script src="jquery-ui-1.12.0/jquery-ui.js"></script><script language='JavaScript'>function checkform() {	var v = $('input[name=auditor]:checked', '#form1').val()	if (v=='') {		alert('กรุณาระบุ ผู้ตรวจสอบ');		$('input[name^=auditor]')[0].focus();		return false;	} else {		var has_other = 0;		$(".auditor").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#auditor_other').val()=='') {			alert('กรุณาระบุ ผู้ตรวจสอบอื่นๆ');			$('#auditor_other').focus();			return false;		}			}		return true;}$(function () {	$(".datepicker-th").datepicker({ 		changeMonth: true,		changeYear: true,			yearRange: '-100:+0',		dateFormat: 'yy-mm-dd', 		dayNames: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'],		dayNamesMin: ['อา','จ','อ','พ','พฤ','ศ','ส'],		montdocames: ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'],		monthNamesShort: ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.']	});	$(".auditor").change(function() {		var has_other = 0;		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;		if (has_other==0) {			$('#auditor_other').val('');		}	});	$("#is_close").change(function() {		var v = $("#is_close").prop("checked");		if (v) {			$('#is_close_div').show();		} else {			$('#is_close_div').hide();			$('#close_remark').val('');		}	});			$("#department_l1").change(function() {		var d = parseInt($("#department_l1").val());		var d2 = parseInt(<?=$d2?>);		var d3 = parseInt(<?=$d1?>);		if (d>0) {			$.post( "jobfunction_content.php", { action: 'audit_list', parent: d, data: d2, lv: 1 })			.done(function( data ) {				$("#d_lv2").html(data);				$("#d_lv3").html("<select name='department_id3' id='department_l3' class='form-control input-sm' disabled></select>");				$("#department_l2").change(function() {					var d = parseInt($("#department_l2").val());					if (d>0) {						$.post( "jobfunction_content.php", { action: 'audit_list', parent:d, data: d3, lv: 2 })						.done(function( data ) {							$("#d_lv3").html(data);														$("#department_l3").change(function() {								var d = parseInt($("#department_l3").val());								if (d>0) {									document.location='csa_audit.php?depid='+d;								}							});													});						}				}).change();				});			}	}).change();	}); </script>
<section class="panel">	<header class="panel-heading">		<h2 class="panel-title">เพิ่ม รายงานผลการตรวจสอบ</h2>	</header>	<div class="panel-body">
	<form method='post' action='csa_audit.php?depid=<?=$depid?>' id='form1' onsubmit='return checkform()'>	<div class="form-group">	  <label>ปี</label>	  <input type="text" class="form-control input-sm" name='csa_year' required readonly value='<?=$view_year?>'>	</div>		<div class="form-group">	  <label>สายงาน</label>	  <select name='department_id' id='department_l1' class="form-control input-sm" required>		<option value='0'>--- เลือก ---</option><?
$sql="SELECT * FROM department WHERE department_level_id = 3 ORDER BY department_id";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['department_id']?>' <?if ($row1['department_id']==$d3) echo 'selected'?>><?=$row1['department_name']?></option><?}?>		</select>	</div>	<div class="form-group">	  <label>ฝ่าย</label>	  <div id='d_lv2'><select name='department_id2' id='department_l2' class="form-control input-sm" disabled></select></div>	</div>		<div class="form-group">	  <label>กลุ่ม</label>	  <div id='d_lv3'><select name='department_id3' id='department_l3' class="form-control input-sm" disabled></select></div>	</div>
	<br>	<div class="form-group">	  <label>วันที่ตรวจ</label>	  <input type="text" class="form-control input-sm datepicker-th" name='audit_date' placeholder="คลิกเพื่อเลือก" required readonly>	</div>	<div class="form-group">	  <label>รายละเอียด รายงานผลการตรวจสอบ</label>	  <textarea class="form-control input-sm" name='audit_desc' rows='5' placeholder="รายงานผลการตรวจสอบ" required></textarea>	</div>	<div class="form-group">	  <label>ผู้ตรวจสอบ</label><br>	  <div class="checkbox-group require"><? for ($i=0; $i<4; $i++) {?>	  	  <label style='margin: 0px'><input type='radio' name='auditor' class='auditor' value='<?=$i?>' required is_other='<?=($i==3)? 1:0?>' <?if ($row2['auditor']==$i) echo 'checked'?>> <?=auditor_name($i)?></label><br><? }?>	  	  </div>		  <input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='auditor_other' id='auditor_other' value='<?=$row2['auditor_other']?>'>	</div>		<hr>	<div class="form-group">	  <label></label><br>	  <label style='margin: 0px'><input type='checkbox' name='is_close' id='is_close' value='1' <?if ($row2['is_close']==1) echo 'checked'?>> ปิดประเด็นตรวจสอบแล้ว</label><br>	</div>	<div class="form-group" id='is_close_div' style='display:none'>	  <label>รายละเอียด การปิดประเด็นตรวจสอบ</label>	  <textarea class="form-control" name='close_remark' id='close_remark' rows='5' required placeholder="การปิดประเด็นตรวจสอบ"><?=$row2['close_remark']?></textarea>	</div>	<br>		<br>	<br>	<input type='hidden' name='add_id' value='<?=$add_id?>'>	<button type='button' class="btn btn-primary" onClick="document.location='csa_audit.php?depid=<?=$depid?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>	<button type='submit' name='submit' value='add' class="btn btn-danger"><i class='fa fa-plus-circle'></i> เพิ่ม</button>	</form>		</div></section>		  <?
		echo template_footer();		exit;	}} 
if ($depid>0) {	$sql="SELECT 		d3.department_id as d3_id, 		d2.department_id as d2_id,		d1.department_id as d1_id, 		d3.department_name as d3_name, 		d2.department_name as d2_name, 		d1.department_name as d1_name 	FROM `department` d1 	LEFT JOIN `department` d2 ON  d1.parent_id = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d2.parent_id = d3.department_id AND d3.mark_del = '0'		WHERE d1.department_id = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $depid);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$d3 = $row2['d3_id'];			$d2 = $row2['d2_id'];			$d1 = $row2['d1_id'];			$d3_name = $row2['d3_name'];		}	}	}?>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class="icon-grid font-green"></i>					<span class="caption-subject font-green sbold uppercase">รายงานผลการตรวจสอบ</span>					<span class="caption-helper"></span>				</div>				<div class="actions">				</div>			</div><div class="row">	<div class="col-md-1"><label>ปี</label></div>		<div class="col-md-3">		<select name='view_year' class="form-control input-sm" onChange='document.location="csa_audit.php?depid=<?=$depid?>&view_year="+this.value'>			<option value='<?=$view_year-2?>'><?=$view_year-2?></option>			<option value='<?=$view_year-1?>'><?=$view_year-1?></option>			<option value='<?=$view_year?>' selected><?=$view_year?></option>			<option value='<?=$view_year+1?>'><?=$view_year+1?></option>			<option value='<?=$view_year+2?>'><?=$view_year+2?></option>		<select>	</div>			</div>						
<div class='row'>	<div class='col-md-1'><label>สายงาน</label></div>	<div class='col-md-3'>	  <select name='department_id' id='department_l1' class="form-control input-sm" required>		<option value='0'>--- เลือก ---</option><?$sql="SELECT department.*,(SELECT COUNT(*) FROM csa_audit WHERE csa_year = '$view_year' AND csa_audit.department_id = department.department_id) AS num		FROM department WHERE department_level_id = 3 AND department.mark_del = '0' ORDER BY department.department_id";
$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['department_id']?>' <?if ($row1['department_id']==$d3) echo 'selected'?>><?=$row1['department_name']?> (<?=$row1['num']?>)</option><?}?>		</select>	</div></div><div class='row'>	<div class='col-md-1'><label>ฝ่าย</label></div>	<div class='col-md-3' id='d_lv2'>	  <select name='department_id2' id='department_l2' class="form-control input-sm" disabled>	  </select>	</div>	</div><div class='row'>	<div class='col-md-1'><label>กลุ่ม</label></div>	<div class='col-md-3' id='d_lv3'>	  <select name='department_id3' id='department_l3' class="form-control input-sm" disabled>	  </select>	</div>	</div><br>
<script language='JavaScript'>$(function () {	$("#department_l1").change(function() {		var d = parseInt($("#department_l1").val());		var d2 = parseInt(<?=$d2?>);		var d3 = parseInt(<?=$d1?>);		if (d>0) {			$.post( "jobfunction_content.php", { action: 'audit_list', parent: d, data: d2, lv: 1, y: <?=$view_year?> })			.done(function( data ) {				$("#d_lv2").html(data);				$("#d_lv3").html("<select name='department_id3' id='department_l3' class='form-control input-sm' disabled></select>");
				$("#department_l2").change(function() {					var d = parseInt($("#department_l2").val());					if (d>0) {						$.post( "jobfunction_content.php", { action: 'audit_list', parent:d, data: d3, lv: 2, y: <?=$view_year?> })						.done(function( data ) {							$("#d_lv3").html(data);														$("#department_l3").change(function() {								var d = parseInt($("#department_l3").val());								if (d>0) {									document.location='csa_audit.php?depid='+d;								}							});													});						}				}).change();				});			}	}).change();	
	$('.csa_editable').on('click', function() {		var id = $(this).attr('did');		document.location="csa_audit.php?depid=<?=$depid?>&edit_id="+id;	});		});  
</script>
<style>.csa_editable {	cursor: pointer}.tr_sm tr, .tr_sm td {	padding: 2px !important;}</style><?if ($depid>0) {?> <table class='table table-hover'><thead><tr>  <th width='5%'>No.</th>  <th width='15%'>วันที่ตรวจ</th>  <th width='45%'>รายงานผลการตรวจสอบ</th>  <th width='30%'>ผู้ตรวจสอบ</th>  <th width='5%'>ปิดแล้ว</th></tr></thead><tbody><?	$i = 1;	$sql2="SELECT 		d.*,		d1.department_name AS dep1,		d2.department_name AS dep2,		d3.department_name AS dep3	FROM `csa_audit` d	LEFT JOIN `department` d1 ON  d.department_id = d1.department_id AND d1.mark_del = '0'	LEFT JOIN `department` d2 ON  d.department_id2 = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d.department_id3 = d3.department_id AND d3.mark_del = '0'	WHERE 		d.csa_year = '$view_year' AND		d.department_id3 = '$d1' AND		d.mark_del = '0' 	ORDER BY 		audit_date";	$result2=mysqli_query($connect, $sql2);	while ($row2 = mysqli_fetch_array($result2)) {		if ($row2['auditor']==3) 			$auditor = 'อื่นๆ : '.$row2['auditor_other'];		else			$auditor = auditor_name($row2['auditor']);?><tr class='tr_sm'>	<td width='3%' did='<?=$row2['csa_audit_id']?>' class='csa_editable'><?=$i++?></td>	<td width='15' did='<?=$row2['csa_audit_id']?>' class='csa_editable'><?=mysqldate2th_date($row2['audit_date'])?></td>	<td width='45' did='<?=$row2['csa_audit_id']?>' class='csa_editable'><?=$row2['audit_desc']?></td>	<td width='30%' did='<?=$row2['csa_audit_id']?>' class='csa_editable'><?=$auditor?></td>	<td width='5%' did='<?=$row2['csa_audit_id']?>' class='csa_editable'><?if ($row2['is_close']==1) echo '<i class="fa fa-check"></i>'?></td></tr><?	}	?>
</tbody></table>			                  	<br>	<button type="submit" class="btn btn-danger" onClick="document.location='csa_audit.php?action=add&depid=<?=$depid?>&view_year=<?=$view_year?>'"><i class='fa fa-plus-circle'></i> เพิ่ม</button>
<?}?>	</div>
<?echo template_footer();?>