<?include('inc/include.inc.php');include('csa_function.php');echo template_header();
$action = $_GET['action'];$view_year = intval($_GET['view_year']);$edit_id = intval($_GET['edit_id']);$view_id = intval($_GET['view_id']);$period = intval($_GET['period']);$view_dep_id = intval($_GET['view_dep_id']);$del_csa_id = intval($_GET['del_csa_id']);$confirm_id = intval($_GET['confirm_id']);$submit = $_POST['submit'];
$print_q_id = intval($_GET['print_q_id']);$print_s21_id = intval($_GET['print_s21_id']);$print_s22_id = intval($_GET['print_s22_id']);if ($confirm_id>0 && $period>0) {	$sql = "SELECT * FROM csa_department csa_dep 		LEFT JOIN csa_authorize ca ON ca.csa_department_id = csa_dep.csa_department_id		WHERE 			csa_dep.csa_department_id = ? AND 			csa_dep.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $confirm_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {
			$to_status = $row2['csa_department_status_id'];			$is_confirm = $row2['is_confirm'];			$is_confirm2 = $row2['is_confirm2'];			$is_finish_all = true;			$sql = "SELECT * FROM csa c			WHERE 				c.mark_del = '0' AND 				c.csa_department_id = '$row2[csa_department_id]' AND 				c.csa_period = '$period' ";			$result3 = mysqli_query($connect, $sql);			while ($row3 = mysqli_fetch_array($result3)) {				if ($row3['is_finish']==0) $is_finish_all = false;			}
			if ($is_finish_all) {				$qx = true;					mysqli_autocommit($connect,FALSE);				
				if (($period==1 && $is_confirm2==1) || ($period==2 && $is_confirm==1)) {					$to_status = 1;				}				if ($period==1) {					$sql = "UPDATE `csa_department` SET 					`is_confirm`=1,					`csa_department_status_id`='$to_status',					`confirm_date` = now()						WHERE					csa_department_id = ? ";									} else if ($period==2) {					$sql = "UPDATE `csa_department` SET 					`is_confirm2`=1,					`csa_department_status_id`='$to_status',					`confirm_date2` = now()						WHERE					csa_department_id = ? ";				}								$stmt = $connect->prepare($sql);				if ($stmt) {														$stmt->bind_param('i', $row2['csa_department_id']);					$q = $stmt->execute();					$qx = ($qx and $q);											$qx = add_history($qx, $row2['csa_department_id'], $to_status, 'ยืนยันครั้งที่ '.$period.' โดยผู้ประเมิน');					send_confirm_notification($row2['csa_department_id'], $user_id, $period);					
					if ($qx) {						mysqli_commit($connect);								echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';						savelog('CSA-USER-CONFIRM|csa_department_id|'.$row2['csa_department_id'].'|');					} else {						mysqli_rollback($connect);									echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';					}							}			} else {				echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ท่านยังทำประเมินไม่ครบสมบูรณ์ ระบบไม่สามารถยืนยันแบบประเมินได้</div></b><br></div>';			}		}				}	} else if ($del_csa_id>0) {	$sql = "SELECT * FROM csa 		LEFT JOIN csa_authorize ca ON ca.csa_department_id = csa.csa_department_id		WHERE 			csa.csa_id = ? AND 			csa.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $del_csa_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {							$qx = true;				mysqli_autocommit($connect,FALSE);						$sql = "UPDATE `csa` SET 			`mark_del`=1,			`last_modify` = now()				WHERE			csa_id = ? ";						$stmt = $connect->prepare($sql);			if ($stmt) {												$stmt->bind_param('i', $row2['csa_id']);				$q = $stmt->execute();				$qx = ($qx and $q);	
				if ($qx) {					mysqli_commit($connect);							echo '<div class="container"><b><div class="alert alert-success">ระบบได้ลบข้อมูลเรียบร้อยแล้ว</div></b><br></div>';					savelog('CSA-USER-DELETE-JOBFUNCTION|csa_id|'.$row2['csa_id'].'|');				} else {					mysqli_rollback($connect);								echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถลบข้อมูลได้</div></b><br></div>';				}						}		}				}	} else if ($submit=='add_copy_submit') {	$add_id = intval($_POST['add_id']);	$add_year = intval($_POST['add_year']);	$add_period = intval($_POST['add_period']);		if ($add_id>0 && $add_period>0 && isset($_POST['source_csa_id'])) {		$source_csa_id = implode(',', $_POST['source_csa_id']);				if ($source_csa_id!='') {			$qx = true;				mysqli_autocommit($connect,FALSE);			/*mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);*/						$sql = "INSERT INTO `csa` (`csa_year`,`csa_period`,`csa_department_id`,`job_function_id`,`job_function_other`,`strategy`,`csa_responsibility_id`,`process`,`objective`,			`event`,`cause`,`risk_type`,`risk_type_other`,`control`,`control_other`,`factor`,`factor_other`, 			`csa_impact_id1`,`csa_likelihood_id1`,`csa_risk_level1`,`csa_impact_id2`,`csa_likelihood_id2`,`csa_risk_level2`,			`action_plan_type`,`action_plan_activity1`,`action_plan_owner_position1`,`action_plan_dep_id1`,`action_plan_process1`,`action_plan_begin_date1`,`action_plan_end_date1`,			`action_plan_budget2`,`action_plan_activity2`,`action_plan_dep_id2`,`action_plan_process2`,`action_plan_begin_date2`,`action_plan_end_date2`,			`is_finish`,`create_date`) 						SELECT ?,?,? ,`job_function_id`,`job_function_other`,`strategy`,`csa_responsibility_id`,`process`,`objective`,			`event`,`cause`,`risk_type`,`risk_type_other`,`control`,`control_other`,`factor`,`factor_other`, 			`csa_impact_id1`,`csa_likelihood_id1`,`csa_risk_level1`,`csa_impact_id2`,`csa_likelihood_id2`,`csa_risk_level2`,			`action_plan_type`,`action_plan_activity1`,`action_plan_owner_position1`,`action_plan_dep_id1`,`action_plan_process1`,`action_plan_begin_date1`,`action_plan_end_date1`,			`action_plan_budget2`,`action_plan_activity2`,`action_plan_dep_id2`,`action_plan_process2`,`action_plan_begin_date2`,`action_plan_end_date2`,			`is_finish`,`create_date`			FROM csa WHERE csa_id IN ($source_csa_id)";						$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('iii', $add_year, $add_period, $add_id);				$q = $stmt->execute();				$qx = ($qx and $q);					if ($qx) {					mysqli_commit($connect);							echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';					savelog('CSA-USER-ADD-FROM_COPY|csa_id|'.$source_csa_id.'|');				} else {					mysqli_rollback($connect);								echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';				}			} 				} else {			echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ท่านไม่ได้เลือกกิจกรรมต้นฉบับ ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';		}	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ท่านไม่ได้เลือกกิจกรรมต้นฉบับ ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}	} else if ($submit=='save') {	$update_id = intval($_POST['update_id']);	$job_function_id = intval($_POST['job_function_id']);	$job_function_other = ($_POST['job_function_other']);	$strategy = ($_POST['strategy']);	$csa_responsibility = intval($_POST['csa_responsibility']);	$process = ($_POST['process']);	$activity_obj = ($_POST['activity_obj']);	$activity_event = ($_POST['activity_event']);	$activity_cause = ($_POST['activity_cause']);	$csa_risk_type = intval($_POST['csa_risk_type']);	$csa_risk_type_other = ($_POST['csa_risk_type_other']);	$csa_factor = intval($_POST['csa_factor']);	$csa_factor_other = ($_POST['csa_factor_other']);		if (isset($_POST['csa_control'])) {		$csa_control = implode(',', $_POST['csa_control']);	}		$csa_control_other = ($_POST['csa_control_other']);	$csa_impact_id1 = intval($_POST['csa_impact_id1']);	$csa_likelihood_id1 = intval($_POST['csa_likelihood_id1']);	$risk_level_1 = intval($_POST['risk_level_1']);	$csa_impact_id2 = intval($_POST['csa_impact_id2']);	$csa_likelihood_id2 = intval($_POST['csa_likelihood_id2']);	$risk_level_2 = intval($_POST['risk_level_2']);	if (isset($_POST['action_plan_type'])) {		$action_plan_type = implode(',', $_POST['action_plan_type']);	}	$activity_type = intval($_POST['activity_type']);	$csa_audit_id = intval($_POST['csa_audit_id']);	$activity_audit_require = intval($_POST['activity_audit_require']);		$action_plan_activity1 = ($_POST['action_plan_activity1']);	$action_plan_owner_position1 = intval($_POST['action_plan_owner_position1']);	$action_plan_dep_id1 = ($_POST['action_plan_dep_id1']);	$action_plan_process1 = ($_POST['action_plan_process1']);	$action_plan_begin_date1 = ($_POST['action_plan_begin_date1']);	$action_plan_end_date1 = ($_POST['action_plan_end_date1']);	$action_plan_budget2 = doubleval(str_replace(',', '', $_POST['action_plan_budget2']));	$action_plan_activity2 = ($_POST['action_plan_activity2']);	$action_plan_dep_id2 = intval($_POST['action_plan_dep_id2']);	$action_plan_process2 = ($_POST['action_plan_process2']);	$action_plan_begin_date2 = ($_POST['action_plan_begin_date2']);	$action_plan_end_date2 = ($_POST['action_plan_end_date2']);	$is_finish = intval($_POST['is_finish']);		 	if ($update_id>0 && $job_function_id!='') {		$qx = true;			mysqli_autocommit($connect,FALSE);		/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);  */
		if ($csa_impact_id1==0 || 			$csa_likelihood_id1==0 || 			$risk_level_1==0 || 			$csa_impact_id2==0 || 			$csa_likelihood_id2==0 || 			$risk_level_2==0) {				$is_finish = 0;		}				$action_plan_dep_id1_array = json_decode($action_plan_dep_id1, true);		$d1_array = array();		foreach ($action_plan_dep_id1_array as $d1) {			$d1_array[] = intval($d1['id']);		}		$d1_list = implode(',', $d1_array);				$sql = "UPDATE `csa` SET 		`job_function_id`=?,		`job_function_other`=?,		`activity_type`=?,		`csa_audit_id`=?,		`strategy`=?,		`csa_responsibility_id`=?,		`process`=?,		`objective`=?,		`event`=?,		`cause`=?,		`risk_type`=?,		`risk_type_other`=?,		`control`=?,		`control_other`=?,		`factor`=?,		`factor_other`=?, 		`csa_impact_id1`=?,		`csa_likelihood_id1`=?,		`csa_risk_level1`=?,		`csa_impact_id2`=?,		`csa_likelihood_id2`=?,		`csa_risk_level2`=?,		`action_plan_type`=?,		`action_plan_activity1`=?,		`action_plan_owner_position1`=?,		`action_plan_dep_id1`=?,		`action_plan_process1`=?,		`action_plan_begin_date1`=?,		`action_plan_end_date1`=?,		`action_plan_budget2`=?,		`action_plan_activity2`=?,		`action_plan_dep_id2`=?,		`action_plan_process2`=?,		`action_plan_begin_date2`=?,		`action_plan_end_date2`=?,		`is_finish`=?,		`last_modify` = now()			WHERE		csa_id = ? ";			$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('isiisissssisssisiiiiiississssdsisssii', $job_function_id, $job_function_other, $activity_type, $csa_audit_id, $strategy, $csa_responsibility, $process, $activity_obj, 				$activity_event, $activity_cause, $csa_risk_type, $csa_risk_type_other,$csa_control,$csa_control_other,$csa_factor,$csa_factor_other,				$csa_impact_id1, $csa_likelihood_id1, $risk_level_1, $csa_impact_id2, $csa_likelihood_id2, $risk_level_2,				$action_plan_type,$action_plan_activity1,$action_plan_owner_position1,$d1_list,$action_plan_process1,$action_plan_begin_date1,$action_plan_end_date1,				$action_plan_budget2,$action_plan_activity2,$action_plan_dep_id2,$action_plan_process2,$action_plan_begin_date2,$action_plan_end_date2,				$is_finish,$update_id);			$q = $stmt->execute();			$qx = ($qx and $q);	
			if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-USER-UPDATE-JOBFUNCTION|csa_id|'.$row2['update_id'].'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}						$view_id = $update_id;		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}	} else if ($submit=='add') {	$csa_year = intval($_POST['csa_year']);	$csa_period = intval($_POST['csa_period']);	$csa_department_id = intval($_POST['csa_department_id']);	$job_function_id = intval($_POST['job_function_id']);	$job_function_other = ($_POST['job_function_other']);	$strategy = ($_POST['strategy']);	$csa_responsibility = intval($_POST['csa_responsibility']);	$process = ($_POST['process']);	$activity_obj = ($_POST['activity_obj']);	$activity_event = ($_POST['activity_event']);	$activity_cause = ($_POST['activity_cause']);	$csa_risk_type = intval($_POST['csa_risk_type']);	$csa_risk_type_other = ($_POST['csa_risk_type_other']);	$csa_factor = intval($_POST['csa_factor']);	$csa_factor_other = ($_POST['csa_factor_other']);		if (isset($_POST['csa_control'])) {		$csa_control = implode(',', $_POST['csa_control']);	}		$csa_control_other = ($_POST['csa_control_other']);	$csa_impact_id1 = intval($_POST['csa_impact_id1']);	$csa_likelihood_id1 = intval($_POST['csa_likelihood_id1']);	$risk_level_1 = intval($_POST['risk_level_1']);	$csa_impact_id2 = intval($_POST['csa_impact_id2']);	$csa_likelihood_id2 = intval($_POST['csa_likelihood_id2']);	$risk_level_2 = intval($_POST['risk_level_2']);		$activity_type = intval($_POST['activity_type']);	$csa_audit_id = intval($_POST['csa_audit_id']);	$activity_audit_require = intval($_POST['activity_audit_require']);		if (isset($_POST['action_plan_type'])) {		$action_plan_type = implode(',', $_POST['action_plan_type']);	}	$action_plan_activity1 = ($_POST['action_plan_activity1']);	$action_plan_owner_position1 = intval($_POST['action_plan_owner_position1']);	$action_plan_dep_id1 = ($_POST['action_plan_dep_id1']);	$action_plan_process1 = ($_POST['action_plan_process1']);	$action_plan_begin_date1 = ($_POST['action_plan_begin_date1']);	$action_plan_end_date1 = ($_POST['action_plan_end_date1']);	$action_plan_budget2 = doubleval(str_replace(',', '', $_POST['action_plan_budget2']));	$action_plan_activity2 = ($_POST['action_plan_activity2']);	$action_plan_dep_id2 = intval($_POST['action_plan_dep_id2']);	$action_plan_process2 = ($_POST['action_plan_process2']);	$action_plan_begin_date2 = ($_POST['action_plan_begin_date2']);	$action_plan_end_date2 = ($_POST['action_plan_end_date2']);		$is_finish = intval($_POST['is_finish']);
	if ($csa_year>0 && $csa_department_id>0 && $csa_period>0) {		$qx = true;			mysqli_autocommit($connect,FALSE);		 mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);  
		if ($csa_impact_id1==0 || 			$csa_likelihood_id1==0 || 			$risk_level_1==0 || 			$csa_impact_id2==0 || 			$csa_likelihood_id2==0 || 			$risk_level_2==0) {				$is_finish = 0;		}
		$action_plan_dep_id1_array = json_decode($action_plan_dep_id1, true);		$d1_array = array();		foreach ($action_plan_dep_id1_array as $d1) {			$d1_array[] = intval($d1['id']);		}		$d1_list = implode(',', $d1_array);				$sql = "INSERT INTO `csa` (`csa_year`,`csa_period`,`csa_department_id`,`job_function_id`,`job_function_other`,`activity_type`,`csa_audit_id`,`strategy`,`csa_responsibility_id`,		`process`,`objective`,`event`,`cause`,`risk_type`,`risk_type_other`,`control`,`control_other`,`factor`,`factor_other`, 		`csa_impact_id1`,`csa_likelihood_id1`,`csa_risk_level1`,`csa_impact_id2`,`csa_likelihood_id2`,`csa_risk_level2`,		`action_plan_type`,`action_plan_activity1`,`action_plan_owner_position1`,`action_plan_dep_id1`,`action_plan_process1`,`action_plan_begin_date1`,`action_plan_end_date1`,		`action_plan_budget2`,`action_plan_activity2`,`action_plan_dep_id2`,`action_plan_process2`,`action_plan_begin_date2`,`action_plan_end_date2`,		`is_finish`,`create_date`) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,now()) ";				$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('iiiisiisissssisssisiiiiiississssdsisssi',$csa_year, $csa_period, $csa_department_id, $job_function_id, $job_function_other, $activity_type, $csa_audit_id, $strategy, $csa_responsibility, 				$process, $activity_obj, $activity_event, $activity_cause, $csa_risk_type, $csa_risk_type_other,$csa_control,$csa_control_other,$csa_factor,$csa_factor_other,				$csa_impact_id1, $csa_likelihood_id1, $risk_level_1, $csa_impact_id2, $csa_likelihood_id2, $risk_level_2, 				$action_plan_type,$action_plan_activity1,$action_plan_owner_position1,$d1_list,$action_plan_process1,$action_plan_begin_date1,$action_plan_end_date1,				$action_plan_budget2,$action_plan_activity2,$action_plan_dep_id2,$action_plan_process2,$action_plan_begin_date2,$action_plan_end_date2,								$is_finish);			$q = $stmt->execute();			$qx = ($qx and $q);	
			$insert_id = mysqli_insert_id($connect);			if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-USER-ADD-JOBFUNCTION|csa_id|'.$insert_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}			$view_dep_id = $csa_department_id;		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}
} else if ($action=='add_copy2') {	$add_year = intval($_GET['add_year']);	$add_id = intval($_GET['add_id']);		if ($add_year>0 && $add_id>0 && $period>0) {		$sql = "SELECT * FROM csa_department WHERE mark_del = '0' AND csa_department_id = '$add_id' ";		$result = mysqli_query($connect, $sql);		if ($row = mysqli_fetch_array($result)) {					$dep_id = $row['department_id3']; ?><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">เพิ่ม กิจกรรม โดยคัดลอกจาก ครั้งที่ 1 ของปี <?=$add_year?></span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>						<form method='post' action='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>' id='f1' onsubmit='return checkform()'>			<div class="form-group">			  <label class='label1' style='font-weight: bold'>เลือก กิจกรรม ที่ต้องการคัดลอก</label><br><?	$sql2="SELECT 		c.csa_id,		c.csa_period,		c.job_function_id,		c.job_function_other,		j.job_function_name	FROM `csa` c	JOIN csa_department csa_dep ON 		c.csa_department_id = csa_dep.csa_department_id AND		csa_dep.mark_del = '0'	LEFT JOIN job_function j ON c.job_function_id = j.job_function_id	WHERE 		c.mark_del = '0' AND		csa_dep.department_id3 = '$dep_id' AND		csa_dep.csa_year = '$add_year' AND		c.csa_period = '1' ";	$result1=mysqli_query($connect, $sql2);	if (mysqli_num_rows($result1)>0) {		while ($row1 = mysqli_fetch_array($result1)) {			if ($row1['job_function_id']==999999) {				$display_jname = 'อื่นๆ : '.$row1['job_function_other'];			} else {				$display_jname = $row1['job_function_name'];			}?>			  				<label><input type='checkbox' name='source_csa_id[]' value='<?=$row1['csa_id']?>' checked> <?=$display_jname?></label><br><?		} ?>			  </select>			</div>							<?	} else { ?>			<br><font color='red'>เกิดข้อผิดพลาด ไม่พบ กิจกรรม ในรายการประเมินที่เลือก</font><br><?	} ?>						<input type='hidden' name='add_id' value='<?=$add_id?>'>			<input type='hidden' name='add_year' value='<?=$add_year?>'>			<input type='hidden' name='add_period' value='<?=$period?>'>			<br>			<br>						<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type='submit' name='submit' value='add_copy_submit' class="btn btn-success"><i class='fa fa-copy'></i> ยืนยันการคัดลอก</button>			</form>		</div>	</div></div><?		}	}	echo template_footer();	exit;			} else if ($action=='add_copy') {	$add_year = intval($_GET['add_year']);	$add_id = intval($_GET['add_id']);	$cp_from_year = intval($_GET['cp_from_year']);		if ($add_year>0 && $add_id>0 && $period>0) {		$sql = "SELECT * FROM csa_department WHERE mark_del = '0' AND csa_department_id = '$add_id' ";		$result = mysqli_query($connect, $sql);		if ($row = mysqli_fetch_array($result)) {					$dep_id = $row['department_id3']; ?><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">เพิ่ม กิจกรรม โดยคัดลอกจากปีก่อน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>						<form method='post' action='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>' id='f1' onsubmit='return checkform()'><?	$seq = 1;	$sql2="SELECT 		*	FROM `csa_department` 	WHERE 		mark_del = '0' AND		department_id3 = '$dep_id' AND		csa_year < '$add_year'	ORDER BY 		csa_year";	$result1=mysqli_query($connect, $sql2);	if (mysqli_num_rows($result1)>0) {?>			<div class="form-group">			  <label class='label1' style='font-weight: bold'>เลือกปี ต้นฉบับ</label>			  <select name='cp_from_year' id='cp_from_year' class="form-control" onchange='document.location="csa_user.php?action=add_copy&add_id=<?=$add_id?>&add_year=<?=$add_year?>&cp_from_year="+this.value'>				<option value=''>--- เลือก ---</option><?	while ($row1 = mysqli_fetch_array($result1)) {?>			  				<option value='<?=$row1['csa_year']?>' <?if ($cp_from_year==$row1['csa_year']) echo 'selected'?>><?=$row1['csa_year']?></option><?	} ?>			  </select>			</div>	<? 		if ($cp_from_year>0) {?>				<br>			<div class="form-group">			  <label class='label1' style='font-weight: bold'>เลือก กิจกรรม ที่ต้องการคัดลอก</label><br><?	$sql2="SELECT 		c.csa_id,		c.csa_period,		c.job_function_id,		c.job_function_other,		j.job_function_name	FROM `csa` c	JOIN csa_department csa_dep ON 		c.csa_department_id = csa_dep.csa_department_id AND		csa_dep.mark_del = '0'	LEFT JOIN job_function j ON c.job_function_id = j.job_function_id	WHERE 		c.mark_del = '0' AND		csa_dep.department_id3 = '$dep_id' AND		csa_dep.csa_year = '$cp_from_year'	ORDER BY		c.csa_period";	$result1=mysqli_query($connect, $sql2);	if (mysqli_num_rows($result1)>0) {		while ($row1 = mysqli_fetch_array($result1)) {			if ($row1['job_function_id']==999999) {				$display_jname = 'อื่นๆ : '.$row1['job_function_other'];			} else {				$display_jname = $row1['job_function_name'];			}?>			  				<label><input type='checkbox' name='source_csa_id[]' value='<?=$row1['csa_id']?>'> [รอบ<?=$row1['csa_period']?>] <?=$display_jname?></label><br><?		} ?>			  </select>			</div>							<?	} else { ?>			<br><font color='red'>เกิดข้อผิดพลาด ไม่พบ กิจกรรม ในรายการประเมินที่เลือก</font><br><?	} ?>						<?		}	} else {?>			<br><font color='red'>เกิดข้อผิดพลาด ไม่พบต้นฉบับรายการประเมิน ในปีก่อนหน้า</font><br><?	} ?>						<br>			<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button><?	if ($cp_from_year>0) {?>			<input type='hidden' name='add_id' value='<?=$add_id?>'>			<input type='hidden' name='add_year' value='<?=$add_year?>'>			<input type='hidden' name='add_period' value='<?=$period?>'>			<button type='submit' name='submit' value='add_copy_submit' class="btn btn-success"><i class='fa fa-copy'></i> ยืนยันการคัดลอก</button><?	} ?>			</form>			<br>			<br>					</div>	</div></div><?		}	}			echo template_footer();	exit;		} else if ($action=='add') {	$add_year = intval($_GET['add_year']);	$add_id = intval($_GET['add_id']);		if ($add_year>0 && $add_id>0 && $period>0) {		$sql = "SELECT * FROM csa_department WHERE mark_del = '0' AND csa_department_id = '$add_id' ";		$result = mysqli_query($connect, $sql);		if ($row = mysqli_fetch_array($result)) {					$dep_id = $row['department_id3']; ?>	<style>.table-sm tbody tr td{	padding: 5px;}.tr_sm tr, .tr_sm td {	padding: 2px !important;}.label1 {	/* background-color : #fee404;*/	background-color : #fbe0c4;	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}.label2 {	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}</style>

<link href="jquery-ui-1.12.0/jquery-ui.css" rel="stylesheet"><script src="jquery-ui-1.12.0/jquery-ui.js"></script><script language='JavaScript'>
var maxc = 1000000000;<?	echo "\n risk_mat = {}; \n";		$d = array();	$sql2="SELECT * FROM `csa_risk_matrix` ";	$result3=mysqli_query($connect, $sql2);	while ($row3 = mysqli_fetch_array($result3)) {		$d[$row3['csa_impact_id']][$row3['csa_likelihood_id']] = $row3['csa_risk_level']; 	}?>
risk_mat = [<?	for ($i=1; $i<=5; $i++) {		if ($i==1) 			echo '[';		else 			echo ',[';		for ($j=1; $j<=5; $j++) {			if ($j>1) echo ',';			echo $d[$i][$j];		}		echo "]\n";	}?>];
function risk_level_color(r) {	switch (r) {		case 0: return '';		case 1: return '#00ff00';		case 2: return '#ffff00';		case 3: return '#ff9900';		case 4: return '#ff0000';	}}function risk_level_name(r) {	switch (r) {		case 0: return '';		case 1: return 'ต่ำ';		case 2: return 'ปานกลาง';		case 3: return 'สูง';		case 4: return 'สูงมาก';	}}function risk_level_acceptable(r) {	if  (r>=3) 		return 'ไม่เพียงพอ';	else		return 'เพียงพอ';}function risk_level_acceptable_color(r) {	if  (r>=3) 		return '#ff0000';	else		return '#00ff00';}
function cal_level(w) {	var i = parseInt($('#csa_impact_id'+w).val())-1;	var j = parseInt($('#csa_likelihood_id'+w).val())-1;	var lv = 0;		if (isNaN(i) || isNaN(j)) {		$('#risk_level_'+w+'_div').css('background-color', '#ffffff');		$('#risk_level_'+w+'_div').html('');		$('#risk_level_'+w+'_txt').val(0);		$('#risk_level_'+w+'_1_div').html('');		$('#risk_level_'+w+'_1_div').css('background-color', '#ffffff');	} else {		lv = risk_mat[i][j];		$('#risk_level_'+w+'_div').css('background-color', risk_level_color(lv));		$('#risk_level_'+w+'_div').html(risk_level_name(lv));		$('#risk_level_'+w+'_txt').val(lv);		$('#risk_level_'+w+'_1_div').html(risk_level_acceptable(lv));		$('#risk_level_'+w+'_1_div').css('background-color', risk_level_acceptable_color(lv));	}	check_action_plan_div();}function check_action_plan_div() {	var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			$('#action_plan_div').show();		} else {			$('#action_plan_div').hide();		}	}}
function form_validate() {	var err_code = 0;		var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		err_code = 1;		return err_code;	}	var v = $('#activity_type').is(':checked');	var v1 = $('#activity_audit_require').val();	var v2 = $('#csa_audit_id').val();	if (v1==1) {		if (v && (v2=='' || v2==0)) {			err_code = 2;			return err_code;		}	}	var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		err_code = 3;		return err_code;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			err_code = 4;			return err_code;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		err_code = 5;		return err_code;	}	if (l2>l1) {		err_code = 6;		return err_code;	}		var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			var ar = $.map($('.action_plan_type:checked'), function(c){return c.value; });			if (ar.length==0) {				err_code = 7;				return err_code;			}			if (ar.includes("1")) {				if ($('#action_plan_dep_id1').val()=='' || $('#action_plan_dep_id1').val()=='[]') {					err_code = 8;					return err_code;				}				if ($('#action_plan_activity1').val()=='') {					err_code = 9;					return err_code;				}				if ($('#action_plan_owner_position1').val()=='') {					err_code = 10;					return err_code;				}				if ($('#action_plan_process1').val()=='') {					err_code = 11;					return err_code;				}				if ($('#action_plan_begin_date1').val()=='') {					err_code = 12;					return err_code;				}				if ($('#action_plan_end_date1').val()=='') {					err_code = 13;					return err_code;				}			}			if (ar.includes("2")) {				if ($('#action_plan_budget2').val()=='') {					err_code = 14;					return err_code;				}				if ($('#action_plan_activity2').val()=='') {					err_code = 15;					return err_code;				}				if ($('#action_plan_budget2').val()=='') {					err_code = 16;					return err_code;				}				if ($('#action_plan_dep_id2').val()=='') {					err_code = 17;					return err_code;				}				if ($('#action_plan_process2').val()=='') {					err_code = 18;					return err_code;				}				if ($('#action_plan_begin_date2').val()=='') {					err_code = 19;					return err_code;				}				if ($('#action_plan_end_date2').val()=='') {					err_code = 20;					return err_code;				}			}		}	}	/*	if ($('#strategy').val()=='') {		err_code = 21;		return err_code;	}*/	if ($('#process').val()=='') {		err_code = 22;		return err_code;	}	if ($('#activity_obj').val()=='') {		err_code = 23;		return err_code;	}		if ($('#activity_event').val()=='') {		err_code = 24;		return err_code;	}	if ($('#activity_cause').val()=='') {		err_code = 25;		return err_code;	}		if ($("#csa_risk_type").val()=='' || $("#csa_risk_type").val()=='0') {		err_code = 26;		return err_code;	}	if ($("#csa_factor1").val()=='' || $("#csa_factor1").val()=='0') {		err_code = 27;		return err_code;	}	if ($("#csa_factor2").val()=='' || $("#csa_factor2").val()=='0') {		err_code = 27;		return err_code;	}	if ($("#csa_likelihood_id1").val()=='' || $("#csa_likelihood_id1").val()=='0') {		err_code = 28;		return err_code;	}	if ($("#csa_impact_id1").val()=='' || $("#csa_impact_id1").val()=='0') {		err_code = 29;		return err_code;	}	if ($("#csa_likelihood_id2").val()=='' || $("#csa_likelihood_id2").val()=='0') {		err_code = 30;		return err_code;	}	if ($("#csa_impact_id2").val()=='' || $("#csa_impact_id2").val()=='0') {		err_code = 31;		return err_code;	}		return 0;}function validate_btn_check() {		if ($('#job_function_id').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน');		$('#job_function_id').focus();		return false;	}	var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		return false;	}			var v = $('#activity_type').is(':checked');	var v1 = $('#activity_audit_require').val();	var v2 = $('#csa_audit_id').val();	if (v1==1) {		if (v && (v2=='' || v2==0)) {			alert('กรุณาระบุ ประเด็นที่ตรวจพบ');			$('#csa_audit_id').focus();		}	}	var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		alert('กรุณาระบุ การควบคุมที่มีอยู่');		$('input[name^=csa_control]')[0].focus();		return false;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			alert('กรุณาระบุ การควบคุมที่มีอยู่อื่นๆ');			$('#csa_control_other').focus();			return false;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		alert('ผลกระทบหลังการควบคุม ต้องไม่เกินผลกระทบก่อนการควบคุม');		$('#csa_impact_id2').focus();		$('#csa_impact_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_impact_id2').css("border","");	}	if (l2>l1) {		alert('โอกาสหลังการควบคุม ต้องไม่เกินโอกาสก่อนการควบคุม');		$('#csa_likelihood_id2').focus();		$('#csa_likelihood_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_likelihood_id2').css("border","");	}	var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			var ar = $.map($('.action_plan_type:checked'), function(c){return c.value; });			if (ar.length==0) {				alert('กรุณาระบุการตอบสนองหรือจัดการความเสี่ยง');				$('.action_plan_type').focus();				return false;			}			if (ar.includes("1")) {				if ($('#action_plan_dep_id1').val()=='' || $('#action_plan_dep_id1').val()=='[]') {					alert('กรุณาระบุฝ่ายงานผู้รับผิดชอบ');					$('#action_plan_dep_id0').focus();					return false;				}				if ($('#action_plan_activity1').val()=='') {					alert('กรุณาระบุชื่อแผนปฏิบัติการ');					$('#action_plan_activity1').focus();					return false;				}				if ($('#action_plan_owner_position1').val()=='') {					alert('กรุณาระบุตำแหน่งผู้รับผิดชอบ');					$('#action_plan_owner_position1').focus();					return false;				}				if ($('#action_plan_process1').val()=='') {					alert('กรุณาระบุกิจกรรม / ขั้นตอน');					$('#action_plan_process1').focus();					return false;				}				if ($('#action_plan_begin_date1').val()=='') {					alert('กรุณาระบุวันที่เริ่มต้น');					$('#action_plan_begin_date1').focus();					return false;				}				if ($('#action_plan_end_date1').val()=='') {					alert('กรุณาระบุวันที่สิ้นสุด');					$('#action_plan_end_date1').focus();					return false;				}			}			if (ar.includes("2")) {				if ($('#action_plan_budget2').val()=='') {					alert('กรุณาระบุงบประมาณ');					$('#action_plan_budget2').focus();					return false;				}				if ($('#action_plan_activity2').val()=='') {					alert('กรุณาระบุชื่อแผนปฏิบัติการ');					$('#action_plan_activity2').focus();					return false;				}				if ($('#action_plan_budget2').val()=='') {					alert('กรุณาระบุฝ่ายงานผู้ว่าจ้าง');					$('#action_plan_budget2').focus();					return false;				}				if ($('#action_plan_dep_id2').val()=='') {					alert('กรุณาระบุฝ่ายงานผู้ว่าจ้าง');					$('#action_plan_dep_id2').focus();					return false;				}				if ($('#action_plan_process2').val()=='') {					alert('กรุณาระบุกิจกรรม / ขั้นตอน');					$('#action_plan_process2').focus();					return false;				}				if ($('#action_plan_begin_date2').val()=='') {					alert('กรุณาระบุวันที่เริ่มต้น');					$('#action_plan_begin_date2').focus();					return false;				}				if ($('#action_plan_end_date2').val()=='') {					alert('กรุณาระบุวันที่สิ้นสุด');					$('#action_plan_end_date2').focus();					return false;				}			}		}	}/*	if ($('#strategy').val()=='') {		alert('กรุณาระบุกลยุทธ์องค์กร');		$('#strategy').focus();		return false;	}*/	if ($('#process').val()=='') {		alert('กรุณาระบุกระบวนการปฏิบัติงาน');		$('#process').focus();		return false;	}	if ($('#activity_obj').val()=='') {		alert('กรุณาระบุวัตถุประสงค์');		$('#activity_obj').focus();		return false;	}		if ($('#activity_event').val()=='') {		alert('กรุณาระบุเหตุการณ์ความเสี่ยง');		$('#activity_event').focus();		return false;	}	if ($('#activity_cause').val()=='') {		alert('กรุณาระบุสาเหตุที่ทำให้เกิดความเสี่ยง');		$('#activity_cause').focus();		return false;	}			if ($("#csa_risk_type").val()=='' || $("#csa_risk_type").val()=='0') {		alert('กรุณาระบุประเภทความเสี่ยง');		$('#csa_risk_type').focus();		return false;	}	if ($("#csa_factor1").val()=='' || $("#csa_factor1").val()=='0') {		alert('กรุณาระบุปัจจัยเสี่ยง');		$('#csa_factor1').focus();		return false;	}	if ($("#csa_factor2").val()=='' || $("#csa_factor2").val()=='0') {		alert('กรุณาระบุปัจจัยเสี่ยง');		$('#csa_factor2').focus();		return false;	}	if ($("#csa_likelihood_id1").val()=='' || $("#csa_likelihood_id1").val()=='0') {		alert('กรุณาระบุโอกาส ก่อนการควบคุม');		$('#csa_likelihood_id1').focus();		return false;	}	if ($("#csa_impact_id1").val()=='' || $("#csa_impact_id1").val()=='0') {		alert('กรุณาระบุผลกระทบ ก่อนการควบคุม');		$('#csa_impact_id1').focus();		return false;	}	if ($("#csa_likelihood_id2").val()=='' || $("#csa_likelihood_id2").val()=='0') {		alert('กรุณาระบุโอกาส หลังการควบคุม');		$('#csa_likelihood_id2').focus();		return false;	}	if ($("#csa_impact_id2").val()=='' || $("#csa_impact_id2").val()=='0') {		alert('กรุณาระบุผลกระทบ หลังการควบคุม');		$('#csa_impact_id2').focus();		return false;	}		var err_code = form_validate();	if (err_code>0) {		$('#is_finish').val('0');		} else {		$('#is_finish').val('1');		}		alert('แบบประเมินครบสมบูรณ์');	return true;}	function checkform() {	var is_finish = 1;		var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		set_finish('0');		return false;	}		var err_code = form_validate();	if (err_code>0) {		$('#is_finish').val('0');		} else {		$('#is_finish').val('1');		}	return true;}function check_csa_factor_other() {	var has_other = $("#csa_factor2 option:selected").attr("is_other");	if (has_other>0) {		$('#csa_factor_other').show();	} else {		$('#csa_factor_other').hide();	}		}function check_csa_control_other() {	var has_other = 0;	$(".csa_control").each(function() {		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;	});			if (has_other>0) {		$('#csa_control_other_div').show();		$("textarea").keyup();	} else {		$('#csa_control_other_div').hide();	}}function month_name(m) {	switch (parseInt(m)) {		case 1: return 'ม.ค.';		case 2: return 'ก.พ.';		case 3: return 'มี.ค.';		case 4: return 'เม.ย.';		case 5: return 'พ.ค.';		case 6: return 'มิ.ย.';		case 7: return 'ก.ค.';		case 8: return 'ส.ค.';		case 9: return 'ก.ย.';		case 10: return 'ต.ค.';		case 11: return 'พ.ย.';		case 12: return 'ธ.ค.';	}}$(function () {	$('#job_function_id').change(function() {		var j = $(this).val();		if (j==999999) {			$('#job_function_other_div').show();		} else {			$('#job_function_other_div').hide();		}	}).change();		$('#activity_type').change(function() {		var v = $(this).is(':checked');		if (v) {			$('#csa_audit_div').show();		} else {			$('#csa_audit_div').hide();			$('#csa_audit_id').val('');		}	}).change();			$('#csa_impact_id1, #csa_likelihood_id1').change(function() {		cal_level("1");	}).change();	$('#csa_impact_id2, #csa_likelihood_id2').change(function() {		cal_level("2");	}).change();	$('.csa_control').on('click', function() {		check_csa_control_other();	});		var csa_factor_old1 = 0;	var csa_factor_old2 = 0;		$("#csa_risk_type").change(function() {		$("#csa_factor_div1").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');		$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');				var rt = parseInt($("#csa_risk_type").val());		$.post( "jobfunction_content.php", { action: 'risktype', parent:rt, data:csa_factor_old1, lv: 1})		.done(function( data ) {			$("#csa_factor_div1").html(data);			$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');						$("#csa_factor1").change(function() {				$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');				var d = parseInt($("#csa_factor1").val());				$.post( "jobfunction_content.php", { action: 'risktype', parent:d, data:csa_factor_old2, lv: 2})				.done(function( data ) {					$("#csa_factor_div2").html(data);					$('#csa_factor2').change(function() {						check_csa_factor_other();					}).change();					});			}).change();		});		$('#csa_factor_other').hide();	}).change();				$("textarea").keyup(function(e) {		if ($(this).val()!='') {			while($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {				$(this).height($(this).height()+1);			};		}	}).keyup();			$(".datepicker-th").datepicker({ 		changeMonth: true,		changeYear: true,			yearRange: '-10:+10',		dateFormat: 'yy-mm-dd', 		dayNames: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'],		dayNamesMin: ['อา','จ','อ','พ','พฤ','ศ','ส'],		montdocames: ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'],		monthNamesShort: ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.']	});		$('.key-numeric').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		if (this.value>maxc) this.value=maxc;		$(this).val(function(index, value) {			/*return value			.replace(/\D/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");*/			return value			.replace(/[^\d.]+/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");		});			});		$('.key-numeric2').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric2').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric2').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		$(this).val(function(index, value) {			return value			.replace(/\D/g, "");		});			});	    $('#action_plan_begin_date1, #action_plan_end_date1').change(function () {			if ($("#action_plan_begin_date1").val()!='' && $("#action_plan_end_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var d2 = $("#action_plan_end_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date1").val('');				$("#action_plan_end_date1_div").html('');							}		}				if ($("#action_plan_begin_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date1_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date1").val()!='') {			var d2 = $("#action_plan_end_date1").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date1_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}	}).change();	    $('#action_plan_begin_date2, #action_plan_end_date2').change(function () {			if ($("#action_plan_begin_date2").val()!='' && $("#action_plan_end_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var d2 = $("#action_plan_end_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date2").val('');				$("#action_plan_end_date2_div").html('');			}		}				if ($("#action_plan_begin_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date2_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date2").val()!='') {			var d2 = $("#action_plan_end_date2").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date2_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}			}).change();		$('.action_plan_type').change(function() {		$('#action_plan_div_1').hide();		$('#action_plan_div_2').hide();		$(".action_plan_type").each(function() {			var v = 0;			if($(this).is(':checked'))				v = $(this).val();				if (v==1) {					$('#action_plan_div_1').show();					init_dep();					refresh_dep();				} 				if (v==2) {					$('#action_plan_div_2').show();				}					});		}).change();	});  var dep_data = [];function is_exist_dep(id_) {	for(let i=0;i<dep_data.length;i++){		if(dep_data[i].id===id_){			return true;		}	}	return false;}	function init_dep() {	var v = $('#action_plan_dep_id1').val();	dep_data = JSON.parse(v);}function refresh_dep() {	$('#action_plan_dep_id1_div ul').empty();	$.each(dep_data, function(i, obj) {		$("#action_plan_dep_id1_div ul").append('<li><a href="JavaScript:del_dep('+obj.id+')">'+obj.name+'</a></li>');	});		$('#action_plan_dep_id1').val(JSON.stringify(dep_data));}function del_dep(i) {	jQuery(dep_data).each(function (index){			if(dep_data[index].id == i){				dep_data.splice(index,1); 				return false; 			}	});	refresh_dep();}function add_dep() {	var v = $('#action_plan_dep_id0').val();	if (v!='') {		if (!is_exist_dep(v)) {			var t = $("#action_plan_dep_id0 option:selected").text();			dep_data.push(				{id: v, name: t}			);					refresh_dep();			$('#action_plan_dep_id0').val('');		} else {			alert('เกิดข้อผิดพลาด ท่านเพิ่มฝ่ายงานซ้ำ');			$('#action_plan_dep_id0').focus();			return false;		}	} else {		alert('กรุณาระบุเลือกฝ่ายงานก่อน');		$('#action_plan_dep_id0').focus();		return false;	}}</script>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">เพิ่ม กิจกรรม</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>
						<form method='post' action='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>' id='f1' onsubmit='return checkform()'>
<?	if (is_has_audit_history($add_id)) { ?><div class='row'>	<div class='col-md-8'>						<div class='note note-danger' style='font-size:13px'>	<?=gen_audit_history($add_id, false)?>	</div>	</div>	</div>	
<?	}?><?//gen_job_function($dep_id, $add_id, $add_year)?>	<?	$j_list = array();	$sql = "SELECT 		job_function_id 	FROM csa 	WHERE 		csa_year = '$add_year' AND 		csa_period = '$period' AND 		mark_del = '0' AND 		csa_department_id = '$add_id' ";	$result2 = mysqli_query($connect, $sql);	while ($row2 = mysqli_fetch_array($result2)) {		$j_list[] = $row2['job_function_id'];	}
	$sql = "SELECT 		* 	FROM		job_function 	WHERE 		(is_require = '1') AND		mark_del = '0' AND 		department_id3 = '$dep_id' 	ORDER BY 		job_function_no, job_function_id";	$result2 = mysqli_query($connect, $sql);	if (mysqli_num_rows($result2)>0) {		$is_pass_all = true; 		while ($row2 = mysqli_fetch_array($result2)) {			if (in_array($row2['job_function_id'], $j_list)) { 				$j_detail_list[] = '<font color="green"><i class="fa fa-check"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';			} else {				$j_detail_list[] = '<font color="red"><i class="fa fa-times"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';				$is_pass_all = false;				$j_id_list[] = $row2['job_function_id'];			}		}	}?>									<div class="form-group">			  <label  class='label1'>ขอบเขตหน้าที่ความรับผิดชอบของกลุ่มงาน</label>			  <select name='job_function_id' id='job_function_id' class="form-control" required>				<option value=''>--- เลือก ---</option><?	$seq = 1;	$sql2="SELECT 		d.*,		d1.department_name AS dep1,		d2.department_name AS dep2,		d3.department_name AS dep3	FROM `job_function` d	LEFT JOIN `department` d1 ON  d.department_id = d1.department_id AND d1.mark_del = '0'	LEFT JOIN `department` d2 ON  d.department_id2 = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d.department_id3 = d3.department_id AND d3.mark_del = '0'	WHERE 		d.parent_id = '0' AND		d.mark_del = '0' AND		d.department_id3 = '$dep_id' AND		d.is_require = 1	ORDER BY 		job_function_no, job_function_id";	$result1=mysqli_query($connect, $sql2);	while ($row1 = mysqli_fetch_array($result1)) {		if (!in_array($row1['job_function_id'], $j_list)) {?>			  			<option value='<?=$row1['job_function_id']?>'><?=$seq++?> <?=$row1['job_function_name']?></option><?		}	}?>			<option value='999999'><?=$seq++?> อื่นๆ โปรดระบุ</option>			  </select>			</div>				<div class="form-group" id='job_function_other_div' style='display:none'>				<input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='job_function_other' id='job_function_other' value='<?=$row2['job_function_other']?>'>			</div>			<div class="form-group">			  <label  class='label1'>ประเด็นที่ตรวจพบ </label><?	$a_list = array();	$sql = "SELECT 		csa_audit_id	FROM csa 	WHERE 		csa_year = '$add_year' AND 		mark_del = '0' AND 		csa_department_id = '$add_id'  AND		csa_period = '$period' ";	$result2 = mysqli_query($connect, $sql);	while ($row2 = mysqli_fetch_array($result2)) {		$a_list[] = $row2['csa_audit_id'];	}	$sql="SELECT * FROM csa_audit WHERE csa_year = '$add_year' AND department_id3='$dep_id' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);if (mysqli_num_rows($result1)>0) {?>								<input type='checkbox' name='activity_type' id='activity_type' value='1' <?if ($row2['activity_type']==1) echo 'checked'?>  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='1'>				<div id='csa_audit_div'>				<select name='csa_audit_id' id='csa_audit_id' class="form-control"  <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?	while ($row1 = mysqli_fetch_array($result1)) {		if (!in_array($row1['csa_audit_id'], $a_list)) {?>			<option value='<?=$row1['csa_audit_id']?>' <?if ($row1['csa_audit_id']==$row2['csa_audit_id']) echo 'selected'?>><?=$row1['audit_desc']?></option><?			}	} ?>				</select>								</div><?} else {?>				<input type='checkbox' name='activity_type' id='activity_type' value='1' disabled  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='0'><?} ?>			</div>			<div class="form-group">			  <label  class='label1'>กลยุทธ์องค์กร (ถ้ามี) </label>				<textarea class="form-control" placeholder="กลยุทธ์องค์กร (ถ้ามี) " name='strategy' rows='2'><?=$row2['strategy']?></textarea>			</div>			<div class="form-group">			  <label  class='label1'>กระบวนการปฏิบัติงาน</label>				<textarea class="form-control" placeholder="กระบวนการปฏิบัติงาน" name='process' rows='2'><?=$row2['process']?></textarea>			</div>							<div class="form-group">			  <label  class='label1'>วัตถุประสงค์</label>				<textarea class="form-control" placeholder="วัตถุประสงค์" name='activity_obj' rows='2'><?=$row2['activity_obj']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>เหตุการณ์ความเสี่ยง</label>				<textarea class="form-control" placeholder="เหตุการณ์ความเสี่ยง" name='activity_event' rows='2'><?=$row2['activity_event']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>สาเหตุที่ทำให้เกิดความเสี่ยง</label>				<textarea class="form-control" placeholder="สาเหตุที่ทำให้เกิดความเสี่ยง" name='activity_cause' rows='2'><?=$row2['activity_cause']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>ประเภทความเสี่ยง</label>			  <select name='csa_risk_type' id='csa_risk_type' class="form-control">				<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_risk_type WHERE mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_risk_type_id']?>'><?=$row1['risk_type_name']?></option><?}?>			  			  </select>			</div>				<div class="form-group">			  <label  class='label1'>ปัจจัยเสี่ยง</label>			  <div id='csa_factor_div1'>			  <select name='csa_factor' id='csa_factor' class="form-control">				<option value=''>--- เลือก ---</option>			  </select>			  </div>			  <div id='csa_factor_div2'>			  <select name='csa_factor' id='csa_factor' class="form-control">				<option value=''>--- เลือก ---</option>			  </select>			  </div>			</div>				<div class="form-group" id='csa_factor_other' style='display:none'>				<input type="text" class="form-control" placeholder="โปรดระบุปัจจัยเสี่ยงอื่นๆ" name='csa_factor_other' value=''>			</div>						<div class="form-group">			  <label  class='label1'>การควบคุมที่มีอยู่</label><br>			  <div class="checkbox-group require"><?$sql="SELECT * FROM csa_control WHERE mark_del = '0' ORDER BY is_other, csa_control_id ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<label style='margin: 0px'><input type='checkbox' name='csa_control[]' class='csa_control' value='<?=$row1['csa_control_id']?>' is_other='<?=$row1['is_other']?>'> <?=$row1['control_name']?></label><br><?}?>			  			  </select>
				</div>			</div>			<div class="form-group" id='csa_control_other_div' style='display:none'>				<textarea class="form-control" placeholder="โปรดระบุการควบคุมที่มีอยู่อื่นๆ" name='csa_control_other' id='csa_control_other'></textarea>			</div>			<br>			<br>			<div class='row'>			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>
				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>ก่อน</u> การควบคุม</b><br><br>				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id1' id='csa_likelihood_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id1']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id1' id='csa_impact_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id1']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_1_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>							</div>				<div class='col-md-1'></div>
			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>หลัง</u> การควบคุม</b><br><br>				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id2' id='csa_likelihood_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id2']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id2' id='csa_impact_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id2']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_2_div' style='background:#ffffff; padding: 10; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_2_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>										<br>			<br>			</div>			</div>			
			<button type='button' class="btn btn-default" data-toggle="modal" href="#basic"><i class='fa fa-search'></i> ดู Matrix</button>			<br>			<br><?$action_plan_type_array = array();$json1 = array();?>						<div id='action_plan_div' style='display:none'>				<hr>				<div style='background: #dddddd; padding: 15px; font-size: 20px'><b>แผนปฏิบัติการ (Action Plan)</b></div><br><br>				<div class="form-group">				  <label  class='label1'>การตอบสนองหรือจัดการความเสี่ยง</label><br>				</div>								<div class='row'>					<div class='col-md-4' style=''>					<div class='bg-blue bg-font-blue margin-bottom-10' style='padding: 10px; '>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='1' <?if (in_array(1, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ดำเนินการโดยฝ่ายงาน</label><br>					</div>					<div id='action_plan_div_1' class='border-blue margin-bottom-10' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">						<div class="row">							<div class="col-md-12"><label class='label1'>ฝ่ายงานผู้รับผิดชอบ</label></div>						</div>						<div class="row">							<div class="col-md-12">								<div id="action_plan_dep_id1_div">									<ul>									</ul>								</div>															<input type='hidden' id='action_plan_dep_id1' name='action_plan_dep_id1' value='<?=json_encode($json1)?>'>							</div>						</div>						<div class="row">						<div class="col-md-10">							<select name='action_plan_dep_id0' id='action_plan_dep_id0' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id1']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>											<div class="col-md-1"><button type='button' class='btn btn-icon-only red' onClick='add_dep()' <?=$lock_tag?>><i class='fa fa-plus'></i></button></div>											</div>											</div>											<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity1' id='action_plan_activity1' rows='3' <?=$lock_tag?>><?=$row2['action_plan_activity1']?></textarea>						</div>										<div class="form-group">						  <label  class='label1'>ตำแหน่งผู้รับผิดชอบ</label>						  <select name='action_plan_owner_position1' id='action_plan_owner_position1' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option>							<option value='1' <?if ($row2['action_plan_owner_position1']==1) echo 'selected'?>>ผู้จัดการ</option>							<option value='2' <?if ($row2['action_plan_owner_position1']==2) echo 'selected'?>>ผู้อำนวยการ</option>							<option value='3' <?if ($row2['action_plan_owner_position1']==3) echo 'selected'?>>สายงาน</option>						  </select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process1' id='action_plan_process1' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process1']?></textarea>						</div>											<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date1' id='action_plan_begin_date1' value='<?=$row2['action_plan_begin_date1']?>' <?=$lock_tag?>></div>							</div>						</div>										<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date1' id='action_plan_end_date1' value='<?=$row2['action_plan_end_date1']?>' <?=$lock_tag?>></div>							</div>						</div>														</div>					</div>					<div class='col-md-1'></div>					<div class='col-md-4'>					<div class='bg-yellow-lemon bg-font-yellow-lemon margin-bottom-10' style='padding: 10px; '>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='2' <?if (in_array(2, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ว่าจ้าง Outsource</label><br>					</div>					<div id='action_plan_div_2' class='border-yellow-lemon' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">							<label  class='label1'>งบประมาณ</label>							<input type="text" class="form-control key-numeric" placeholder="งบประมาณ" name='action_plan_budget2' id='action_plan_budget2' value='<?=number_filter2($row2['action_plan_budget2'])?>' <?=$lock_tag?>>						</div>										<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity2' id='action_plan_activity2' rows='3' <?=$lock_tag?>><?=$row2['action_plan_activity2']?></textarea>						</div>								<div class="form-group">						  <label  class='label1'>ฝ่ายงานผู้ว่าจ้าง</label>							<select name='action_plan_dep_id2' id='action_plan_dep_id2' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id2']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process2' id='action_plan_process2' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process2']?></textarea>						</div>						<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date2' id='action_plan_begin_date2' value='<?=$row2['action_plan_begin_date2']?>' <?=$lock_tag?>></div>							</div>						</div>						<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date2' id='action_plan_end_date2' value='<?=$row2['action_plan_end_date2']?>' <?=$lock_tag?>></div>							</div>						</div>					</div>					</div>				</div>											<br>				<br>			</div>						<script language='JavaScript'>function getCellCenter(table, row, column) {  var tableRow = $(table).find('tr')[row];  var tableCell = $(tableRow).find('td')[column];  var offset = $(tableCell).offset();  var width = $(tableCell).innerWidth();  var height = $(tableCell).innerHeight();  return {    x: offset.left + width / 2,    y: offset.top + height / 2  }}function drawArrow(start, end) {  /*var canvas = document.createElement('canvas');*/  var canvas = document.getElementById('canvas1');  canvas.width = $('body').innerWidth();  canvas.height = $('body').innerHeight();  $(canvas).css('position', 'absolute');  $(canvas).css('z-index', '99999');  $(canvas).css('pointer-events', 'none');  $(canvas).css('top', '0');  $(canvas).css('left', '0');  $(canvas).css('opacity', '1');  $('body').append(canvas);    var ctx = canvas.getContext('2d');  ctx.fillStyle = 'white';  ctx.strokeStyle = 'white';    ctx.beginPath();  ctx.moveTo(start.x, start.y);  ctx.lineTo(end.x, end.y);  ctx.lineWidth = 6;  ctx.stroke();    ctx.beginPath();    ctx.arc(start.x, start.y, 8, 0, Math.PI * 2, false);  ctx.lineWidth = 6;  ctx.fill();  /*ctx.stroke();*/  ctx.beginPath();    var angle = Math.atan2(end.y - start.y, end.x - start.x);  ctx.translate(end.x, end.y);  ctx.rotate(angle);  ctx.moveTo(0, 0);  ctx.lineTo(-20, -10);  ctx.lineTo(-20, 10);  ctx.lineTo(0, 0);  ctx.fill();  ctx.setTransform(1, 0, 0, 1, 0, 0);    return canvas;}function drawArrowOnTable(table, startRow, startColumn, endRow, endColumn) {  drawArrow(    getCellCenter($(table), startRow, startColumn),    getCellCenter($(table), endRow, endColumn)  );}function draw_arrow_matrix(y1, x1, y2, x2) {	var start_x = 0;	var start_y = 2;	drawArrowOnTable('#table_mat', start_y+y1, start_x+x1, start_y+y2, start_x+x2);}$(function () {	$('#basic').on('shown.bs.modal', function (e) {		var i1 = parseInt($('#csa_impact_id1').val());		var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());		var l2 = parseInt($('#csa_likelihood_id2').val());		if (i1>0 && l1>0 && i2>0 && l2>0) {			draw_arrow_matrix(5-i1,l1,5-i2,l2);			$('#canvas1').show();		}	});	$('#basic').on('hide.bs.modal', function (e) {		$('#canvas1').hide();	});});  	</script>	<div class="modal fade" id="basic" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">	<div class="modal-dialog">		<div class="modal-content">			<div class="modal-header">				<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>				<h4 class="modal-title">Risk Matrix</h4>			</div>			<canvas id="canvas1" style='position:absolute'></canvas>						<div class="modal-body"><?=gen_risk_mat()?></div>			<div class="modal-footer">				<button type="button" class="btn dark btn-outline" data-dismiss="modal">ปิด</button>			</div>		</div>	</div></div>									<br>			<br>			<br>			<input type='hidden' name='risk_level_1' id='risk_level_1_txt' value=''>			<input type='hidden' name='risk_level_2' id='risk_level_2_txt' value=''>			<input type='hidden' name='csa_period' value='<?=$period?>'>			<input type='hidden' name='csa_year' value='<?=$add_year?>'>			<input type='hidden' name='csa_department_id' value='<?=$add_id?>'>			<input type='hidden' name='is_finish' id='is_finish' value='0'>			<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$add_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type='submit' name='submit' value='add' class="btn btn-success"><i class='fa fa-save'></i> บันทึก</button>			<button type='button' name='validate' class="btn btn-default" onClick='validate_btn_check()'><i class='fa fa-search'></i> ตรวจสอบความครบถ้วน</button>			<br>			<br>			</form>		</div>	</div></div>

<?		}	}	echo template_footer();	exit;	} else if ($print_q_id>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_q_id?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part1($print_q_id)?><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_q_id?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><?	echo template_footer();	exit;		} else if ($print_s21_id>0 && $period>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_s21_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part2_1($print_s21_id, $period)?><br><br><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_s21_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a>			<?	echo template_footer();	exit;		} else if ($print_s22_id>0 && $period>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s22_id=<?=$print_s22_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part2_2($print_s22_id, $period)?><br><br><button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s22_id=<?=$print_s22_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a>			<?	echo template_footer();	exit;		}
if ($view_id>0 && $period>0) {
	$sql = "SELECT 		c.*,		r.is_other as risk_is_other,		r.risk_type_name,		j.job_function_no,		j.job_function_name,		f1.csa_factor_id AS csa_factor_id1,		f2.csa_factor_id AS csa_factor_id2,		f2.is_other as factor_is_other,		f2.factor as factor_name,		rs.responsibility_desc as responsibility_desc	FROM csa c	LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'	LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'	LEFT JOIN csa_factor f1 ON c.factor = f1.csa_factor_id AND f1.mark_del = '0'	LEFT JOIN csa_factor f2 ON f1.parent_id = f2.csa_factor_id  AND f2.mark_del = '0'	LEFT JOIN csa_responsibility rs ON c.csa_responsibility_id = rs.csa_responsibility_id AND rs.mark_del = '0'	WHERE 		c.csa_id = ? AND		c.mark_del = '0' ";		$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $view_id);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$is_confirm = 0;			$csa_dep_id = $row2['csa_department_id'];			$csa_year = $row2['csa_year'];						$factor1 = $row2['csa_factor_id2'];			$factor2 = $row2['csa_factor_id1'];						$sql = "SELECT 					c.*,					d1.department_name AS dep_name1,					d2.department_name AS dep_name2,					d3.department_name AS dep_name3				FROM csa_department c				LEFT JOIN department d1 ON c.department_id = d1.department_id				LEFT JOIN department d2 ON c.department_id2 = d2.department_id				LEFT JOIN department d3 ON c.department_id3 = d3.department_id				WHERE 					c.csa_department_id = '$csa_dep_id' AND 					c.mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			if ($row1 = mysqli_fetch_array($result1)) {				$dep1 = $row1['dep_name1'];				$dep2 = $row1['dep_name2'];				$dep3 = $row1['dep_name3'];				$dep_id = $row1['department_id3']; 											if ($period==1) {					$is_confirm = $row1['is_confirm'];				} else if ($period==2) {					$is_confirm = $row1['is_confirm2'];				}				$lock_tag = '';				if ($is_confirm==1){					$lock_tag = 'disabled';				}
								if ($row2['job_function_id']==999999) 					$job_function = 'อื่นๆ : '.$row2['job_function_other'];				else					$job_function = $row2['job_function_no'].' '.$row2['job_function_name'];								if ($row2['risk_is_other']==1) 					$risk_type_name = $row2['risk_type_name'].': '.$row2['risk_type_other'];				else					$risk_type_name = $row2['risk_type_name'];								if ($row2['factor_is_other']==1) 					$factor_name = $row2['factor_name'].': '.$row2['factor_other'];				else					$factor_name = $row2['factor_name'];								$control = '';				if ($row2['control']!='') {					$sql="SELECT * FROM csa_control WHERE mark_del = '0' AND csa_control_id IN ($row2[control])";					$result1=mysqli_query($connect, $sql);					while ($row1 = mysqli_fetch_array($result1)) {							if ($row1['is_other']==1) 							$control .= '- '.$row1['control_name'].': '.$row2['control_other'].'<BR>';						else							$control .= '- '.$row1['control_name'].'<BR>';					}				}?>
<style>.tr_sm tr, .tr_sm td {	padding: 2px !important;}.label1 {	background-color : #fbe0c4;	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}.label2 {	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}</style><link href="jquery-ui-1.12.0/jquery-ui.css" rel="stylesheet"><script src="jquery-ui-1.12.0/jquery-ui.js"></script><script language='JavaScript'>
var maxc = 1000000000;<?	echo "\n risk_mat = {}; \n";		$d = array();	$sql2="SELECT * FROM `csa_risk_matrix` ";	$result3=mysqli_query($connect, $sql2);	while ($row3 = mysqli_fetch_array($result3)) {		$d[$row3['csa_impact_id']][$row3['csa_likelihood_id']] = $row3['csa_risk_level']; 	}?>
risk_mat = [<?	for ($i=1; $i<=5; $i++) {		if ($i==1) 			echo '[';		else 			echo ',[';		for ($j=1; $j<=5; $j++) {			if ($j>1) echo ',';			echo $d[$i][$j];		}		echo "]\n";	}?>
];

function risk_level_color(r) {
	switch (r) {
		case 0: return '';
		case 1: return '#00ff00';		case 2: return '#ffff00';		case 3: return '#ff9900';		case 4: return '#ff0000';
	}
}
function risk_level_name(r) {
	switch (r) {
		case 0: return '';
		case 1: return 'ต่ำ';
		case 2: return 'ปานกลาง';
		case 3: return 'สูง';
		case 4: return 'สูงมาก';
	}
}
function risk_level_acceptable(r) {	if  (r>=3) 		return 'ไม่เพียงพอ';	else		return 'เพียงพอ';
}
function risk_level_acceptable_color(r) {	if  (r>=3) 		return '#ff0000';	else		return '#00ff00';}

function cal_level(w) {
	var i = parseInt($('#csa_impact_id'+w).val())-1;
	var j = parseInt($('#csa_likelihood_id'+w).val())-1;	var lv = 0;		if (isNaN(i) || isNaN(j)) {		$('#risk_level_'+w+'_div').css('background-color', '#ffffff');		$('#risk_level_'+w+'_div').html('');		$('#risk_level_'+w+'_txt').val(0);		$('#risk_level_'+w+'_1_div').html('');		$('#risk_level_'+w+'_1_div').css('background-color', '#ffffff');	} else {		lv = risk_mat[i][j];
		$('#risk_level_'+w+'_div').css('background-color', risk_level_color(lv));
		$('#risk_level_'+w+'_div').html(risk_level_name(lv));
		$('#risk_level_'+w+'_txt').val(lv);		$('#risk_level_'+w+'_1_div').html(risk_level_acceptable(lv));		$('#risk_level_'+w+'_1_div').css('background-color', risk_level_acceptable_color(lv));	}	check_action_plan_div();}
function check_action_plan_div() {	var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			$('#action_plan_div').show();		} else {			$('#action_plan_div').hide();		}	}}function form_validate() {	var err_code = 0;	if ($('#job_function_id').val()=='') {		err_code = 1;		return err_code;	}		var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		err_code = 1;		return err_code;	}	var v = $('#activity_type').is(':checked');	var v1 = $('#activity_audit_require').val();	var v2 = $('#csa_audit_id').val();	if (v1==1) {		if (v && (v2=='' || v2==0)) {			err_code = 2;			return err_code;		}	}	var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		err_code = 3;		return err_code;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			err_code = 4;			return err_code;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		err_code = 5;		return err_code;	}	if (l2>l1) {		err_code = 6;		return err_code;	}		var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			var ar = $.map($('.action_plan_type:checked'), function(c){return c.value; });			if (ar.length==0) {				err_code = 7;				return err_code;			}			if (ar.includes("1")) {				if ($('#action_plan_dep_id1').val()=='' || $('#action_plan_dep_id1').val()=='[]') {					err_code = 8;					return err_code;				}				if ($('#action_plan_activity1').val()=='') {					err_code = 9;					return err_code;				}				if ($('#action_plan_owner_position1').val()=='') {					err_code = 10;					return err_code;				}				if ($('#action_plan_process1').val()=='') {					err_code = 11;					return err_code;				}				if ($('#action_plan_begin_date1').val()=='') {					err_code = 12;					return err_code;				}				if ($('#action_plan_end_date1').val()=='') {					err_code = 13;					return err_code;				}			}			if (ar.includes("2")) {				if ($('#action_plan_budget2').val()=='') {					err_code = 14;					return err_code;				}				if ($('#action_plan_activity2').val()=='') {					err_code = 15;					return err_code;				}				if ($('#action_plan_budget2').val()=='') {					err_code = 16;					return err_code;				}				if ($('#action_plan_dep_id2').val()=='') {					err_code = 17;					return err_code;				}				if ($('#action_plan_process2').val()=='') {					err_code = 18;					return err_code;				}				if ($('#action_plan_begin_date2').val()=='') {					err_code = 19;					return err_code;				}				if ($('#action_plan_end_date2').val()=='') {					err_code = 20;					return err_code;				}			}		}	}	/*	if ($('#strategy').val()=='') {		err_code = 21;		return err_code;	}*/	if ($('#process').val()=='') {		err_code = 22;		return err_code;	}	if ($('#activity_obj').val()=='') {		err_code = 23;		return err_code;	}		if ($('#activity_event').val()=='') {		err_code = 24;		return err_code;	}	if ($('#activity_cause').val()=='') {		err_code = 25;		return err_code;	}		if ($("#csa_risk_type").val()=='' || $("#csa_risk_type").val()=='0') {		err_code = 26;		return err_code;	}	if ($("#csa_factor1").val()=='' || $("#csa_factor1").val()=='0') {		err_code = 27;		return err_code;	}	if ($("#csa_factor2").val()=='' || $("#csa_factor2").val()=='0') {		err_code = 27;		return err_code;	}	if ($("#csa_likelihood_id1").val()=='' || $("#csa_likelihood_id1").val()=='0') {		err_code = 28;		return err_code;	}	if ($("#csa_impact_id1").val()=='' || $("#csa_impact_id1").val()=='0') {		err_code = 29;		return err_code;	}	if ($("#csa_likelihood_id2").val()=='' || $("#csa_likelihood_id2").val()=='0') {		err_code = 30;		return err_code;	}	if ($("#csa_impact_id2").val()=='' || $("#csa_impact_id2").val()=='0') {		err_code = 31;		return err_code;	}		return 0;}function validate_btn_check() {	if ($('#job_function_id').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน');		$('#job_function_id').focus();		return false;	}	var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		return false;	}	var v = $('#activity_type').is(':checked');	var v1 = $('#activity_audit_require').val();	var v2 = $('#csa_audit_id').val();	if (v1==1) {		if (v && (v2=='' || v2==0)) {			alert('กรุณาระบุ ประเด็นที่ตรวจพบ');			$('#csa_audit_id').focus();		}	}	var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		alert('กรุณาระบุ การควบคุมที่มีอยู่');		$('input[name^=csa_control]')[0].focus();		return false;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			alert('กรุณาระบุ การควบคุมที่มีอยู่อื่นๆ');			$('#csa_control_other').focus();			return false;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		alert('ผลกระทบหลังการควบคุม ต้องไม่เกินผลกระทบก่อนการควบคุม');		$('#csa_impact_id2').focus();		$('#csa_impact_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_impact_id2').css("border","");	}	if (l2>l1) {		alert('โอกาสหลังการควบคุม ต้องไม่เกินโอกาสก่อนการควบคุม');		$('#csa_likelihood_id2').focus();		$('#csa_likelihood_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_likelihood_id2').css("border","");	}	var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			var ar = $.map($('.action_plan_type:checked'), function(c){return c.value; });			if (ar.length==0) {				alert('กรุณาระบุการตอบสนองหรือจัดการความเสี่ยง');				$('.action_plan_type').focus();				return false;			}			if (ar.includes("1")) {				if ($('#action_plan_dep_id1').val()=='' || $('#action_plan_dep_id1').val()=='[]') {					alert('กรุณาระบุฝ่ายงานผู้รับผิดชอบ');					$('#action_plan_dep_id0').focus();					return false;				}				if ($('#action_plan_activity1').val()=='') {					alert('กรุณาระบุชื่อแผนปฏิบัติการ');					$('#action_plan_activity1').focus();					return false;				}				if ($('#action_plan_owner_position1').val()=='') {					alert('กรุณาระบุตำแหน่งผู้รับผิดชอบ');					$('#action_plan_owner_position1').focus();					return false;				}				if ($('#action_plan_process1').val()=='') {					alert('กรุณาระบุกิจกรรม / ขั้นตอน');					$('#action_plan_process1').focus();					return false;				}				if ($('#action_plan_begin_date1').val()=='') {					alert('กรุณาระบุวันที่เริ่มต้น');					$('#action_plan_begin_date1').focus();					return false;				}				if ($('#action_plan_end_date1').val()=='') {					alert('กรุณาระบุวันที่สิ้นสุด');					$('#action_plan_end_date1').focus();					return false;				}			}			if (ar.includes("2")) {				if ($('#action_plan_budget2').val()=='') {					alert('กรุณาระบุงบประมาณ');					$('#action_plan_budget2').focus();					return false;				}				if ($('#action_plan_activity2').val()=='') {					alert('กรุณาระบุชื่อแผนปฏิบัติการ');					$('#action_plan_activity2').focus();					return false;				}				if ($('#action_plan_budget2').val()=='') {					alert('กรุณาระบุฝ่ายงานผู้ว่าจ้าง');					$('#action_plan_budget2').focus();					return false;				}				if ($('#action_plan_dep_id2').val()=='') {					alert('กรุณาระบุฝ่ายงานผู้ว่าจ้าง');					$('#action_plan_dep_id2').focus();					return false;				}				if ($('#action_plan_process2').val()=='') {					alert('กรุณาระบุกิจกรรม / ขั้นตอน');					$('#action_plan_process2').focus();					return false;				}				if ($('#action_plan_begin_date2').val()=='') {					alert('กรุณาระบุวันที่เริ่มต้น');					$('#action_plan_begin_date2').focus();					return false;				}				if ($('#action_plan_end_date2').val()=='') {					alert('กรุณาระบุวันที่สิ้นสุด');					$('#action_plan_end_date2').focus();					return false;				}			}		}	}/*	if ($('#strategy').val()=='') {		alert('กรุณาระบุกลยุทธ์องค์กร');		$('#strategy').focus();		return false;	}*/	if ($('#process').val()=='') {		alert('กรุณาระบุกระบวนการปฏิบัติงาน');		$('#process').focus();		return false;	}	if ($('#activity_obj').val()=='') {		alert('กรุณาระบุวัตถุประสงค์');		$('#activity_obj').focus();		return false;	}		if ($('#activity_event').val()=='') {		alert('กรุณาระบุเหตุการณ์ความเสี่ยง');		$('#activity_event').focus();		return false;	}	if ($('#activity_cause').val()=='') {		alert('กรุณาระบุสาเหตุที่ทำให้เกิดความเสี่ยง');		$('#activity_cause').focus();		return false;	}			if ($("#csa_risk_type").val()=='' || $("#csa_risk_type").val()=='0') {		alert('กรุณาระบุประเภทความเสี่ยง');		$('#csa_risk_type').focus();		return false;	}	if ($("#csa_factor1").val()=='' || $("#csa_factor1").val()=='0') {		alert('กรุณาระบุปัจจัยเสี่ยง');		$('#csa_factor1').focus();		return false;	}	if ($("#csa_factor2").val()=='' || $("#csa_factor2").val()=='0') {		alert('กรุณาระบุปัจจัยเสี่ยง');		$('#csa_factor2').focus();		return false;	}	if ($("#csa_likelihood_id1").val()=='' || $("#csa_likelihood_id1").val()=='0') {		alert('กรุณาระบุโอกาส ก่อนการควบคุม');		$('#csa_likelihood_id1').focus();		return false;	}	if ($("#csa_impact_id1").val()=='' || $("#csa_impact_id1").val()=='0') {		alert('กรุณาระบุผลกระทบ ก่อนการควบคุม');		$('#csa_impact_id1').focus();		return false;	}	if ($("#csa_likelihood_id2").val()=='' || $("#csa_likelihood_id2").val()=='0') {		alert('กรุณาระบุโอกาส หลังการควบคุม');		$('#csa_likelihood_id2').focus();		return false;	}	if ($("#csa_impact_id2").val()=='' || $("#csa_impact_id2").val()=='0') {		alert('กรุณาระบุผลกระทบ หลังการควบคุม');		$('#csa_impact_id2').focus();		return false;	}		var err_code = form_validate();	if (err_code>0) {		$('#is_finish').val('0');		} else {		$('#is_finish').val('1');		}		alert('แบบประเมินครบสมบูรณ์');	return true;}	function checkform() {	var is_finish = 1;		var v = parseInt($('#job_function_id').val());	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		set_finish('0');		return false;	}		var err_code = form_validate();	if (err_code>0) {		$('#is_finish').val('0');		} else {		$('#is_finish').val('1');		}	return true;}
function check_csa_factor_other() {	var has_other = $("#csa_factor2 option:selected").attr("is_other");	if (has_other>0) {		$('#csa_factor_other').show();	} else {		$('#csa_factor_other').hide();	}		}
function check_csa_control_other() {	var has_other = 0;	$(".csa_control").each(function() {		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;	});			if (has_other>0) {		$('#csa_control_other_div').show();		$("textarea").keyup();	} else {		$('#csa_control_other_div').hide();	}}
function month_name(m) {	switch (parseInt(m)) {		case 1: return 'ม.ค.';		case 2: return 'ก.พ.';		case 3: return 'มี.ค.';		case 4: return 'เม.ย.';		case 5: return 'พ.ค.';		case 6: return 'มิ.ย.';		case 7: return 'ก.ค.';		case 8: return 'ส.ค.';		case 9: return 'ก.ย.';		case 10: return 'ต.ค.';		case 11: return 'พ.ย.';		case 12: return 'ธ.ค.';	}}
$(function () {
	save_tab();
	$('#job_function_id').change(function() {		var j = $(this).val();		if (j==999999) {			$('#job_function_other_div').show();		} else {			$('#job_function_other_div').hide();		}			}).change();		$('#activity_type').change(function() {		var v = $(this).is(':checked');		if (v) {			$('#csa_audit_div').show();		} else {			$('#csa_audit_div').hide();			$('#csa_audit_id').val('');		}	}).change();		
	$('#csa_impact_id1, #csa_likelihood_id1').change(function() {
		cal_level("1");
	}).change();
	$('#csa_impact_id2, #csa_likelihood_id2').change(function() {
		cal_level("2");
	}).change();

	$('.csa_control').on('click', function() {		check_csa_control_other();	});	
/*	$("#csa_risk_type").change(function() {		var rt = parseInt($("#csa_risk_type").val());		$.post( "jobfunction_content.php", { action: 'risktype', parent:rt, data:csa_factor_old, is_disable: '<?=$lock_tag?>'})		.done(function( data ) {			$("#csa_factor_div").html(data);
			$('#csa_factor').change(function() {				check_csa_factor_other();			});						});				$('#csa_factor_other').hide();	}).change();*/		var csa_factor_old1 = parseInt($("#csa_factor_old1").val());	var csa_factor_old2 = parseInt($("#csa_factor_old2").val());	$("#csa_risk_type").change(function() {		$("#csa_factor_div1").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');		$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');				var rt = parseInt($("#csa_risk_type").val());		$.post( "jobfunction_content.php", { action: 'risktype', parent:rt, data:csa_factor_old1, lv: 1})		.done(function( data ) {			$("#csa_factor_div1").html(data);			$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');						$("#csa_factor1").change(function() {				$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');				var d = parseInt($("#csa_factor1").val());				$.post( "jobfunction_content.php", { action: 'risktype', parent:d, data:csa_factor_old2, lv: 2})				.done(function( data ) {					$("#csa_factor_div2").html(data);					$('#csa_factor2').change(function() {						check_csa_factor_other();					}).change();					});			}).change();		});		$('#csa_factor_other').hide();	}).change();			check_csa_factor_other();	check_csa_control_other();			$("textarea").keyup(function(e) {		if ($(this).val()!='') {			while($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {				$(this).height($(this).height()+1);			};		}	}).keyup();		$(".datepicker-th").datepicker({ 		changeMonth: true,		changeYear: true,			yearRange: '-10:+10',		dateFormat: 'yy-mm-dd', 		dayNames: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'],		dayNamesMin: ['อา','จ','อ','พ','พฤ','ศ','ส'],		montdocames: ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'],		monthNamesShort: ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.']	});		$('.key-numeric').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9.]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		if (this.value>maxc) this.value=maxc;		$(this).val(function(index, value) {			/*return value			.replace(/\D/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");*/			return value			.replace(/[^\d.]+/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");		});			});		$('.key-numeric2').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric2').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric2').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		$(this).val(function(index, value) {			return value			.replace(/\D/g, "");		});			});		    $('#action_plan_begin_date1, #action_plan_end_date1').change(function () {			if ($("#action_plan_begin_date1").val()!='' && $("#action_plan_end_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var d2 = $("#action_plan_end_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date1").val('');				$("#action_plan_end_date1_div").html('');							}		}				if ($("#action_plan_begin_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date1_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date1").val()!='') {			var d2 = $("#action_plan_end_date1").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date1_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}	}).change();	    $('#action_plan_begin_date2, #action_plan_end_date2').change(function () {			if ($("#action_plan_begin_date2").val()!='' && $("#action_plan_end_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var d2 = $("#action_plan_end_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date2").val('');				$("#action_plan_end_date2_div").html('');			}		}				if ($("#action_plan_begin_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date2_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date2").val()!='') {			var d2 = $("#action_plan_end_date2").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date2_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}			}).change();		$('.action_plan_type').change(function() {		$('#action_plan_div_1').hide();		$('#action_plan_div_2').hide();		$(".action_plan_type").each(function() {			var v = 0;			if($(this).is(':checked'))				v = $(this).val();				if (v==1) {					$('#action_plan_div_1').show();					init_dep();					refresh_dep();				} 				if (v==2) {					$('#action_plan_div_2').show();				}					});		}).change();});  
var dep_data = [];function is_exist_dep(id_) {	for(let i=0;i<dep_data.length;i++){		if(dep_data[i].id===id_){			return true;		}	}	return false;}	function init_dep() {	var v = $('#action_plan_dep_id1').val();	dep_data = JSON.parse(v);}function refresh_dep() {	$('#action_plan_dep_id1_div ul').empty();	$.each(dep_data, function(i, obj) {		$("#action_plan_dep_id1_div ul").append('<li><a href="JavaScript:del_dep('+obj.id+')">'+obj.name+'</a></li>');	});		$('#action_plan_dep_id1').val(JSON.stringify(dep_data));}function del_dep(i) {<? if ($lock_tag=='disabled') echo 'return false;'?> 		jQuery(dep_data).each(function (index){			if(dep_data[index].id == i){				dep_data.splice(index,1); 				return false; 			}	});	refresh_dep();}function add_dep() {	var v = $('#action_plan_dep_id0').val();	if (v!='') {		if (!is_exist_dep(v)) {			var t = $("#action_plan_dep_id0 option:selected").text();			dep_data.push(				{id: v, name: t}			);					refresh_dep();			$('#action_plan_dep_id0').val('');		} else {			alert('เกิดข้อผิดพลาด ท่านเพิ่มฝ่ายงานซ้ำ');			$('#action_plan_dep_id0').focus();			return false;		}	} else {		alert('กรุณาระบุเลือกฝ่ายงานก่อน');		$('#action_plan_dep_id0').focus();		return false;	}}
function toggle_risk_mat() {  if ( $( "#risk_mat" ).first().is( ":hidden" ) ) {    $( "#risk_mat" ).slideDown( "slow" );  } else {    $( "#risk_mat" ).slideUp();  }}

function save_tab() {	if (location.hash) {	  $('a[href=\'' + location.hash + '\']').tab('show');	}	var activeTab = localStorage.getItem('activeTab');	if (activeTab) {	  $('a[href="' + activeTab + '"]').tab('show');	}	$('body').on('click', 'a[data-toggle=\'tab\']', function (e) {	  e.preventDefault();	  var tab_name = this.getAttribute('href');	  if (history.pushState) {		history.pushState(null, null, tab_name);	  }	  else {		location.hash = tab_name;	  }	  localStorage.setItem('activeTab', tab_name);	  $(this).tab('show');	  return false;	});	$(window).on('popstate', function () {	  var anchor = location.hash ||		$('a[data-toggle=\'tab\']').first().attr('href');	  $('a[href=\'' + anchor + '\']').tab('show');	});	}
function activaTab(tab){  $('.nav-tabs a[href="#' + tab + '"]').tab('show');};</script>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">กิจกรรม</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$csa_year?>&view_dep_id=<?=$csa_dep_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>
			<div class=''>			<b>				<?=$dep1?><br>				<?=$dep2?><br>				<?=$dep3?></b>			</div>			<br>
<?	if (is_has_audit_history($csa_dep_id)) { ?><div class='row'>	<div class='col-md-8'>						<div class='note note-danger' style='font-size:13px'>	<?=gen_audit_history($csa_dep_id)?>	</div>	</div>	</div>	<?	}?>				<form method='post' action='csa_user.php?view_id=<?=$view_id?>&view_year=<?=$view_year?>&period=<?=$period?>' id='f1' onsubmit='return checkform()'>
<?//gen_job_function($dep_id, $csa_dep_id, $csa_year)?>				<div class="form-group">			  <label class='label1'>ขอบเขตหน้าที่ความรับผิดชอบของกลุ่มงาน</label>			  <select name='job_function_id' id='job_function_id' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?	$seq = 1;	$sql2="SELECT 		d.*,		d1.department_name AS dep1,		d2.department_name AS dep2,		d3.department_name AS dep3	FROM `job_function` d	LEFT JOIN `department` d1 ON  d.department_id = d1.department_id AND d1.mark_del = '0'	LEFT JOIN `department` d2 ON  d.department_id2 = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d.department_id3 = d3.department_id AND d3.mark_del = '0'	WHERE 		d.parent_id = '0' AND		d.mark_del = '0' AND		d.department_id3 = '$dep_id' AND		d.is_require = 1	ORDER BY 		job_function_no, job_function_id";	$result1=mysqli_query($connect, $sql2);	while ($row1 = mysqli_fetch_array($result1)) {?>			  			<option value='<?=$row1['job_function_id']?>' <?if ($row2['job_function_id']==$row1['job_function_id']) echo 'selected'?>><?=$seq++?> <?=$row1['job_function_name']?></option><?	} ?>			<option value='999999' <?if ($row2['job_function_id']==999999) echo 'selected'?>><?=$seq++?> อื่นๆ โปรดระบุ</option>			  </select>			</div>				<div class="form-group" id='job_function_other_div' style='display:none'>				<input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='job_function_other' id='job_function_other' value='<?=$row2['job_function_other']?>' <?=$lock_tag?>>			</div>			<div class="form-group">			  <label  class='label1'>ประเด็นที่ตรวจพบ </label><?$sql="SELECT * FROM csa_audit WHERE csa_year = '$csa_year' AND department_id3='$dep_id' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);if (mysqli_num_rows($result1)>0) {?>								<input type='checkbox' name='activity_type' id='activity_type' value='1' <?if ($row2['activity_type']==1) echo 'checked'?>  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='1'>				<div id='csa_audit_div'>				<select name='csa_audit_id' id='csa_audit_id' class="form-control"  <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_audit_id']?>' <?if ($row1['csa_audit_id']==$row2['csa_audit_id']) echo 'selected'?>><?=$row1['audit_desc']?></option><?} ?>				</select>								</div><?} else {?>				<input type='checkbox' name='activity_type' id='activity_type' value='1' disabled  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='0'><?} ?>			</div>			<div class="form-group">			  <label  class='label1'>กลยุทธ์องค์กร (ถ้ามี) </label>				<textarea class="form-control" placeholder="กลยุทธ์องค์กร (ถ้ามี) " name='strategy' id='strategy' rows='2' <?=$lock_tag?>><?=$row2['strategy']?></textarea>			</div>						<div class="form-group">			  <label  class='label1'>กระบวนการปฏิบัติงาน</label>				<textarea class="form-control " placeholder="กระบวนการปฏิบัติงาน" name='process' id='process' rows='2' <?=$lock_tag?>><?=$row2['process']?></textarea>			</div>						<div class="form-group">			  <label  class='label1'>วัตถุประสงค์</label>				<textarea class="form-control" placeholder="วัตถุประสงค์" name='activity_obj' id='activity_obj' rows='2' <?=$lock_tag?>><?=$row2['objective']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>เหตุการณ์ความเสี่ยง</label>				<textarea class="form-control" placeholder="เหตุการณ์ความเสี่ยง" name='activity_event' id='activity_event' rows='2' <?=$lock_tag?>><?=$row2['event']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>สาเหตุที่ทำให้เกิดความเสี่ยง</label>				<textarea class="form-control" placeholder="สาเหตุที่ทำให้เกิดความเสี่ยง" name='activity_cause' id='activity_cause' rows='2' <?=$lock_tag?>><?=$row2['cause']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>ประเภทความเสี่ยง</label>			  <select name='csa_risk_type' id='csa_risk_type' class="form-control" <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_risk_type WHERE mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_risk_type_id']?>' <?if ($row2['risk_type']==$row1['csa_risk_type_id']) echo 'selected'?>><?=$row1['risk_type_name']?></option><?}?>			  			  </select>			</div>				<div class="form-group">			  <label  class='label1'>ปัจจัยเสี่ยง</label>			<input type='hidden' id='csa_factor_old1' value='<?=$factor1?>'>			<input type='hidden' id='csa_factor_old2' value='<?=$factor2?>'>			  			  <div id='csa_factor_div1'>			  <select name='csa_factor' id='csa_factor' class="form-control">				<option value=''>--- เลือก ---</option>			  </select>			  </div>			  <div id='csa_factor_div2'>			  <select name='csa_factor' id='csa_factor' class="form-control">				<option value=''>--- เลือก ---</option>			  </select>			  </div>			</div>					<div class="form-group" id='csa_factor_other' style='display:none'>				<input type="text" class="form-control" placeholder="โปรดระบุปัจจัยเสี่ยงอื่นๆ" name='csa_factor_other' value='<?=$row2['factor_other']?>' <?=$lock_tag?>>			</div>						<div class="form-group">			  <label  class='label1'>การควบคุมที่มีอยู่</label><br>			  <div class="checkbox-group require"><?$control_array = explode(',', $row2['control']);$sql="SELECT * FROM csa_control WHERE mark_del = '0' ORDER BY is_other, csa_control_id ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<label style='margin: 0px'><input type='checkbox' name='csa_control[]' class='csa_control' value='<?=$row1['csa_control_id']?>' is_other='<?=$row1['is_other']?>' <?if (in_array($row1['csa_control_id'], $control_array)) echo 'checked'?> <?=$lock_tag?>> <?=$row1['control_name']?></label><br><?}?>			  				</div>			</div>			<div class="form-group" id='csa_control_other_div' style='display:none'>				<textarea class="form-control" placeholder="โปรดระบุการควบคุมที่มีอยู่อื่นๆ" name='csa_control_other' id='csa_control_other' <?=$lock_tag?>><?=$row2['control_other']?></textarea>			</div>						<br>			<br>			<div class='row'>			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>
				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>ก่อน</u> การควบคุม</b><br><br>
				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id1' id='csa_likelihood_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id1']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id1' id='csa_impact_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id1']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_1_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>							</div>				<div class='col-md-1'></div>
			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>หลัง</u> การควบคุม</b><br><br>				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id2' id='csa_likelihood_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id2']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id2' id='csa_impact_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id2']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_2_div' style='background:#ffffff; padding: 10; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_2_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>										<br>			<br>			</div>			</div>			<button type='button' class="btn btn-default" data-toggle="modal" href="#basic"><i class='fa fa-search'></i> ดู Matrix</button>			<br>			<br>						<?$action_plan_type_array = explode(',', $row2['action_plan_type']);$json1 = array();if ($row2['action_plan_dep_id1']!='') {	$sql="SELECT department_id, department_name FROM department WHERE department_level_id = '4' AND mark_del = '0' AND department_id IN (".$row2['action_plan_dep_id1'].")";	$result1=mysqli_query($connect, $sql);	while ($row1 = mysqli_fetch_array($result1)) {		$json1[] = array(			'id'=> $row1['department_id'],			'name'=> $row1['department_name']		);	}}?>						<div id='action_plan_div' style='display:none'>				<hr>				<div style='background: #dddddd; padding: 15px; font-size: 20px'><b>แผนปฏิบัติการ (Action Plan)</b></div><br><br>				<div class="form-group">				  <label  class='label1'>การตอบสนองหรือจัดการความเสี่ยง</label><br>				</div>								<div class='row'>					<div class='col-md-4' style=''>					<div class='bg-blue bg-font-blue margin-bottom-10' style='padding: 10px;'>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='1' <?if (in_array(1, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ดำเนินการโดยฝ่ายงาน</label><br>					</div>					<div id='action_plan_div_1' class='border-blue margin-bottom-10' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">						<div class="row">							<div class="col-md-12"><label class='label1'>ฝ่ายงานผู้รับผิดชอบ</label></div>						</div>						<div class="row">							<div class="col-md-12">								<div id="action_plan_dep_id1_div">									<ul>									</ul>								</div>															<input type='hidden' id='action_plan_dep_id1' name='action_plan_dep_id1' value='<?=json_encode($json1)?>'>							</div>						</div>						<div class="row">						<div class="col-md-10">							<select name='action_plan_dep_id0' id='action_plan_dep_id0' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id1']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>											<div class="col-md-1"><button type='button' class='btn btn-icon-only red' onClick='add_dep()' <?=$lock_tag?>><i class='fa fa-plus'></i></button></div>											</div>											</div>											<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity1' id='action_plan_activity1' <?=$lock_tag?> rows='3'><?=$row2['action_plan_activity1']?></textarea>						</div>										<div class="form-group">						  <label  class='label1'>ตำแหน่งผู้รับผิดชอบ</label>						  <select name='action_plan_owner_position1' id='action_plan_owner_position1' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option>							<option value='1' <?if ($row2['action_plan_owner_position1']==1) echo 'selected'?>>ผู้จัดการ</option>							<option value='2' <?if ($row2['action_plan_owner_position1']==2) echo 'selected'?>>ผู้อำนวยการ</option>							<option value='3' <?if ($row2['action_plan_owner_position1']==3) echo 'selected'?>>สายงาน</option>						  </select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process1' id='action_plan_process1' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process1']?></textarea>						</div>											<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date1' id='action_plan_begin_date1' value='<?=$row2['action_plan_begin_date1']?>' <?=$lock_tag?>></div>							</div>						</div>										<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date1' id='action_plan_end_date1' value='<?=$row2['action_plan_end_date1']?>' <?=$lock_tag?>></div>							</div>						</div>														</div>					</div>					<div class='col-md-1'></div>					<div class='col-md-4'>					<div class='bg-yellow-lemon bg-font-yellow-lemon margin-bottom-10' style='padding: 10px; '>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='2' <?if (in_array(2, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ว่าจ้าง Outsource</label><br>					</div>					<div id='action_plan_div_2' class='border-yellow-lemon' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">							<label  class='label1'>งบประมาณ</label>							<input type="text" class="form-control key-numeric" placeholder="งบประมาณ" name='action_plan_budget2' id='action_plan_budget2' value='<?=number_filter2($row2['action_plan_budget2'])?>' <?=$lock_tag?>>						</div>										<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity2' id='action_plan_activity2' <?=$lock_tag?>><?=$row2['action_plan_activity1']?></textarea>						</div>								<div class="form-group">						  <label  class='label1'>ฝ่ายงานผู้ว่าจ้าง</label>							<select name='action_plan_dep_id2' id='action_plan_dep_id2' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id2']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process2' id='action_plan_process2' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process2']?></textarea>						</div>						<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date2' id='action_plan_begin_date2' value='<?=$row2['action_plan_begin_date2']?>' <?=$lock_tag?>></div>							</div>						</div>						<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date2' id='action_plan_end_date2' value='<?=$row2['action_plan_end_date2']?>' <?=$lock_tag?>></div>							</div>						</div>					</div>					</div>				</div>											<br>				<br>			</div>						<input type='hidden' name='risk_level_1' id='risk_level_1_txt' value=''>			<input type='hidden' name='risk_level_2' id='risk_level_2_txt' value=''>			<input type='hidden' name='update_id' value='<?=$view_id?>'>			<input type='hidden' name='is_finish' id='is_finish' value='0'><?if ($is_confirm==0){?>						<button type='submit' name='submit' value='save' class="btn btn-success"><i class='fa fa-save'></i> บันทึกข้อมูล</button>			<button type='button' name='validate' class="btn btn-default" onClick='validate_btn_check()'><i class='fa fa-search'></i> ตรวจสอบความครบถ้วน</button><?}?><script language='JavaScript'>function getCellCenter(table, row, column) {  var tableRow = $(table).find('tr')[row];  var tableCell = $(tableRow).find('td')[column];  var offset = $(tableCell).offset();  var width = $(tableCell).innerWidth();  var height = $(tableCell).innerHeight();  return {    x: offset.left + width / 2,    y: offset.top + height / 2  }}function drawArrow(start, end) {  /*var canvas = document.createElement('canvas');*/  var canvas = document.getElementById('canvas1');  canvas.width = $('body').innerWidth();  canvas.height = $('body').innerHeight();  $(canvas).css('position', 'absolute');  $(canvas).css('z-index', '99999');  $(canvas).css('pointer-events', 'none');  $(canvas).css('top', '0');  $(canvas).css('left', '0');  $(canvas).css('opacity', '1');  $('body').append(canvas);    var ctx = canvas.getContext('2d');  ctx.fillStyle = 'white';  ctx.strokeStyle = 'white';    ctx.beginPath();  ctx.moveTo(start.x, start.y);  ctx.lineTo(end.x, end.y);  ctx.lineWidth = 6;  ctx.stroke();    ctx.beginPath();    ctx.arc(start.x, start.y, 8, 0, Math.PI * 2, false);  ctx.lineWidth = 6;  ctx.fill();  /*ctx.stroke();*/  ctx.beginPath();    var angle = Math.atan2(end.y - start.y, end.x - start.x);  ctx.translate(end.x, end.y);  ctx.rotate(angle);  ctx.moveTo(0, 0);  ctx.lineTo(-20, -10);  ctx.lineTo(-20, 10);  ctx.lineTo(0, 0);  ctx.fill();  ctx.setTransform(1, 0, 0, 1, 0, 0);    return canvas;}function drawArrowOnTable(table, startRow, startColumn, endRow, endColumn) {  drawArrow(    getCellCenter($(table), startRow, startColumn),    getCellCenter($(table), endRow, endColumn)  );}function draw_arrow_matrix(y1, x1, y2, x2) {	var start_x = 0;	var start_y = 2;	drawArrowOnTable('#table_mat', start_y+y1, start_x+x1, start_y+y2, start_x+x2);}$(function () {	$('#basic').on('shown.bs.modal', function (e) {		var i1 = parseInt($('#csa_impact_id1').val());		var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());		var l2 = parseInt($('#csa_likelihood_id2').val());		if (i1>0 && l1>0 && i2>0 && l2>0) {			draw_arrow_matrix(5-i1,l1,5-i2,l2);			$('#canvas1').show();		}	});	$('#basic').on('hide.bs.modal', function (e) {		$('#canvas1').hide();	});});  	</script>	<div class="modal fade" id="basic" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">	<div class="modal-dialog">		<div class="modal-content">			<div class="modal-header">				<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>				<h4 class="modal-title">Risk Matrix</h4>			</div>			<canvas id="canvas1" style='position:absolute'></canvas>			<div class="modal-body"><?=gen_risk_mat()?></div>			<div class="modal-footer">				<button type="button" class="btn dark btn-outline" data-dismiss="modal">ปิด</button>			</div>		</div>	</div></div>
						</form>		</div>		<br>
						<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$add_year?>&view_dep_id=<?=$csa_dep_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button><?if ($is_confirm==0){?>						<a href="csa_user.php?view_year=<?=$view_year?>&del_csa_id=<?=$view_id?>&view_dep_id=<?=$csa_dep_id?>&period=<?=$period?>" class="btn btn-danger"  onClick='return confirm("โปรดยืนยันว่าต้องการลบกิจกรรม?")' class="delete-row"><i class='fa fa-trash'></i> ลบกิจกรรม</a><?}?>					</div>	</div></div>
<?						}		}	}	echo template_footer();	exit;		} else {
	if ($view_year==0) {		$view_year=date('Y')+543;	}?>
<div class='row'>	<div class='col-md-1'>เลือก ปี</div>	<div class='col-md-2'>		<select name='view_year' class="form-control" onChange='document.location="csa_user.php?view_year="+this.value'>			<option value='<?=$view_year-2?>'><?=$view_year-2?></option>			<option value='<?=$view_year-1?>'><?=$view_year-1?></option>			<option value='<?=$view_year?>' selected><?=$view_year?></option>			<option value='<?=$view_year+1?>'><?=$view_year+1?></option>			<option value='<?=$view_year+2?>'><?=$view_year+2?></option>		<select>	</div></div><br>
<?if ($view_year>0) { 	if ($view_dep_id==0 || $period==0) { ?><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">แบบประเมินการควบคุมภายใน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">				</div>			</div>			<br>
			<table class='table table-hover'>			<thead>			<tr align='center' style='font-weight: bold; color:#ffffff' bgcolor='#20689f'>				<td width='3%'>ลำดับ</td>				<td width='30%'>สังกัดฝ่ายงาน</td>				<td width='2%'></td>				<td width='50%' colspan='2'>ส่วนที่ 2 แบบประเมิน CSA</td>				<td width='15%'>สถานะ</td>			</tr>			</thead>			<tbody><?				/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */		$i=1;		$sql = "SELECT 				c.*,				d1.department_name AS dep_name1,				d2.department_name AS dep_name2,				d3.department_name AS dep_name3,				st.csa_department_status_color,				st.csa_department_status_name			FROM csa_department c			LEFT JOIN department d1 ON c.department_id = d1.department_id			LEFT JOIN department d2 ON c.department_id2 = d2.department_id			LEFT JOIN department d3 ON c.department_id3 = d3.department_id			LEFT JOIN csa_authorize ca ON c.csa_department_id = ca.csa_department_id			LEFT JOIN csa_department_status st ON st.csa_department_status_id = c.csa_department_status_id			WHERE 				c.is_enable='1' AND				c.csa_year = ? AND 				c.mark_del = '0' AND 				ca.csa_authorize_uid = ? ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('is', $view_year, $user_code);			$stmt->execute();			$result1 = $stmt->get_result();			if (mysqli_num_rows($result1)>0) {				while ($row1 = mysqli_fetch_assoc($result1)) {								$q_finish = $row1['q_finish'];					$is_enable_period1 = $row1['is_enable_period1'];					$is_enable_period2 = $row1['is_enable_period2'];					$is_confirm = $row1['is_confirm'];					$is_confirm2 = $row1['is_confirm2'];					$csa_department_status_id = $row1['csa_department_status_id'];					$is_finish_all = true;
									$j_list = array();					$j_detail_list = array();					$is_pass_all = false;					$sql = "SELECT job_function_id FROM csa WHERE mark_del = '0' AND csa_department_id = '$row1[csa_department_id]' ";					$result2 = mysqli_query($connect, $sql);					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];					}										$cnt_require = 0;					$sql = "SELECT * FROM job_function 					WHERE 						(is_require = '1') AND						mark_del = '0' AND 						department_id3 = '$row1[department_id3]' 					ORDER BY 						job_function_no, job_function_id";					$result2 = mysqli_query($connect, $sql);					if (mysqli_num_rows($result2)>0) {						$is_pass_all = true; 						while ($row2 = mysqli_fetch_array($result2)) {							if (in_array($row2['job_function_id'], $j_list)) { 								$j_detail_list[] = '<font color="green"><i class="fa fa-check"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';							} else {								$j_detail_list[] = '<font color="red"><i class="fa fa-times"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';								$is_pass_all = false;							}							$cnt_require++;						}					}
					$cnt_total = array();					$cnt_finish = array();					$sql = "					SELECT  						SUM(case when is_finish = 1 then 1 else 0 end) AS cnt_finish,						COUNT(*) AS cnt_total,						csa_period					FROM csa c					WHERE 						c.csa_year = '$view_year' AND 						c.mark_del = '0' AND 						c.csa_department_id = '$row1[csa_department_id]' 					GROUP BY 						c.csa_period ";					$result2 = mysqli_query($connect, $sql);					while ($row2 = mysqli_fetch_array($result2)) {						$p = $row2['csa_period'];						$cnt_finish[$p] = $row2['cnt_finish'];						$cnt_total[$p] = $row2['cnt_total'];					}															$u_approve = '';					$u_approve_id = get_user_profile(get_head_csa_uid($row1['csa_department_id']));					if (count($u_approve_id)>0) {						$u_approve = '('.$u_approve_id[0].')';					}										/*$u_user = '';					$u_user_id = get_user_profile_array(get_user_csa_uid($row1[csa_department_id]));					if (count($u_user_id)>0) {						print_r($u_user_id);						$u_user = implode(', ', $u_user_id);					}*/?>			<tr>				<td style='border-right: 1px solid #eeeeee' rowspan='2'><?=$i++?></td>				<td style='border-right: 1px solid #eeeeee' rowspan='2'>					<?=$row1['dep_name2']?><br>					<?=$row1['dep_name3']?>				</td><? if ($is_enable_period1==1){?>								<td width='2%' bgcolor='#20689f' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 1</b></font></td>				<td width='25%'>					<? if ($is_confirm==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ยืนยันแล้ว<br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> อยู่ระหว่างจัดทำ<br>					<? }?>					กิจกรรมทั้งหมด : <?=intval($cnt_total[1])?><br>					กิจกรรมที่บังคับ : <?=$cnt_require?><br>					กิจกรรมที่เสร็จ : <?=intval($cnt_finish[1])?><br><br>					<?=$u_user?>				</td>				<td width='23%' style='border-right: 1px solid #eeeeee'>					<a href='csa_user.php?view_dep_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn blue btn-default"><i class='fa fa-search'></i> แสดงแบบประเมิน</a><br>					<br>					<br>					<? if ($csa_department_status_id>1) {?>					<a href='csa_user.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน</a><br>					<a href='csa_user.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ</a><br>					<? } else if ($is_confirm==1) {?>					<a href='csa_user.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน ฉบับร่าง</a><br>					<a href='csa_user.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ ฉบับร่าง</a><br>					<? }?>				</td><?} else {?>								<td width='2%' bgcolor='#aaaaaa' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 1</b></font></td>				<td width='15%'><br>ยังไม่เปิดให้ทำประเมิน<br><br><br></td>				<td width='10%' style='border-right: 1px solid #eeeeee'></td><?}?>								<td rowspan='2'>					<font color='<?=$row1['csa_department_status_color']?>' style='font-weight: bold'><?=$row1['csa_department_status_name']?></font>					<br><?=$u_approve?>				</td>			</tr>				<tr>	<? if ($is_enable_period2==1){?>								<td width='2%' bgcolor='#20689f' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 2</b></font></td>				<td width='25%'>					<? if ($is_confirm2==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ยืนยันแล้ว<br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> อยู่ระหว่างจัดทำ<br>					<? }?>					กิจกรรมทั้งหมด : <?=intval($cnt_total[2])?><br>					กิจกรรมที่บังคับ : <?=$cnt_require?><br>					กิจกรรมที่เสร็จ : <?=intval($cnt_finish[2])?><br><br>					<?=$u_user?>				</td>				<td width='23%' style='border-right: 1px solid #eeeeee'>					<a href='csa_user.php?view_dep_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn blue btn-default"><i class='fa fa-search'></i> แสดงแบบประเมิน</a><br>					<? if ($csa_department_status_id>1) {?>					<br>					<br>					<a href='csa_user.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน</a><br>					<a href='csa_user.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ</a><br>					<? } else if ($is_confirm2==1) {?>					<a href='csa_user.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน ฉบับร่าง</a><br>					<a href='csa_user.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ ฉบับร่าง</a><br>					<? }?>									</td><?} else {?>								<td width='2%' bgcolor='#aaaaaa' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 2</b></font></td>				<td width='15%'><br>ยังไม่เปิดให้ทำประเมิน<br><br><br></td>				<td width='10%' style='border-right: 1px solid #eeeeee'></td><?}?>							</tr><?				}			} else {		?>						<tr>				<td colspan='5'>-ยังไม่มีข้อมูล-</td>			</tr><?			}?>			</tbody>			</table>						<br>			<br>			<br>		</div>	</div></div>			
<?		}	} else if ($view_dep_id>0 && $period>0) {?>	<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">ส่วนที่ 2 แบบประเมินการควบคุมภายใน ครั้งที่ <?=$period?></span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<br><?				/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */$sql = "SELECT 			c.*,			d1.department_name AS dep_name1,			d2.department_name AS dep_name2,			d3.department_name AS dep_name3		FROM csa_department c		LEFT JOIN department d1 ON c.department_id = d1.department_id		LEFT JOIN department d2 ON c.department_id2 = d2.department_id		LEFT JOIN department d3 ON c.department_id3 = d3.department_id		JOIN csa_authorize ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.is_enable='1' AND			c.csa_department_id = ? AND 			ca.csa_authorize_uid = ? AND 			c.mark_del = '0' ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('is', $view_dep_id, $user_code);			$stmt->execute();			$result1 = $stmt->get_result();			if ($row1 = mysqli_fetch_assoc($result1)) {						$dep_id = $row1['department_id3'];				if ($period==1) {					$is_confirm = $row1['is_confirm'];					$rj_date = $row1['reject_date'];					$rj_reason = $row1['reject_reason'];				} else if ($period==2) {					$is_confirm = $row1['is_confirm2'];					$rj_date = $row1['reject_date2'];					$rj_reason = $row1['reject_reason2'];				} 				if ($rj_date!='' && $rj_date!='0000-00-00 00:00:00' && $rj_reason!='') {					$is_reject = 1;					$reject_reason = $rj_reason;				} else {					$is_reject = 0;					$reject_reason = '';				}								$is_finish_all = true;
				if ($is_confirm==1) {?>			<div class='row'>			<div class='col-md-1'><i class='fa fa-check-circle' style='font-size:80px; color: green'></i></div>			<div class='col-md-11'>				<b>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?				} else {?>			<div class='row'>			<div class='col-md-12'>				<b>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?				}?>				
			<div class="tabbable-custom ">	<ul class="nav nav-tabs " id='myTab'>		<li class="active"><a href="#tab2" data-toggle="tab" aria-expanded="false">กิจกรรมที่ต้องประเมินความเสี่ยง</a></li>				<li class=""><a href="#tab1" data-toggle="tab" aria-expanded="true">กิจกรรม</a></li>		<li class=""><a href="#tab3" data-toggle="tab" aria-expanded="false">ประเด็นที่ตรวจพบ</a></li>				<li class=""><a href="#tab4" data-toggle="tab" aria-expanded="false">ประวัติการเปลี่ยนแปลง</a></li>			</ul>	<div class="tab-content">		<br>		<div class="tab-pane" id="tab1">			<table class='table table-hover'>			<thead>			<tr style='font-weight: bold'>				<td width='3%'>ลำดับ</td>				<td width='52%'>กิจกรรม</td>				<td width='20%'>ประเภทความเสี่ยง</td>				<td width='10%'>ระดับ<br>ความเสี่ยง</td>				<td width='15%'>สถานะ</td>			</tr>			</thead>			<tbody><?				$j_list = array(); 				$i=1;					$sql = "SELECT 					c.*,					r.is_other as risk_is_other,					r.risk_type_name,					j.job_function_no,					j.job_function_name,					a.audit_desc				FROM csa c				LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'				LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'				LEFT JOIN csa_audit a ON c.activity_type=1 AND c.csa_audit_id = a.csa_audit_id AND a.mark_del = '0'				WHERE 					c.csa_year = '$view_year' AND 					c.csa_period = '$period' AND 					c.mark_del = '0' AND 					c.csa_department_id = '$row1[csa_department_id]' 				ORDER BY 					c.csa_id";				$result2 = mysqli_query($connect, $sql);				if (mysqli_num_rows($result2)>0) {					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];						if ($row2['job_function_id']==999999) 							$job_function = 'อื่นๆ : '.$row2['job_function_other'];						else							$job_function = $row2['job_function_name'];												if ($row2['risk_is_other']==1) 							$risk_type_name = $row2['risk_type_other'];						else							$risk_type_name = $row2['risk_type_name'];												if ($row2['is_finish']==0) $is_finish_all = false;												if ($row2['activity_type']==1) {							$css = 'bgcolor="#ffdddd"';							$job_function.='<BR>('.$row2['audit_desc'].')';						} else							$css = '';												$risk_level = risk_level_name($row2['csa_risk_level2']);						$risk_level_bg = risk_level_color($row2['csa_risk_level2']);?>			<tr onClick='document.location="csa_user.php?view_id=<?=$row2['csa_id']?>&view_year=<?=$view_year?>&period=<?=$period?>"' style='cursor: pointer;' <?=$css?>>				<td><?=$i++?></td>				<td><?=$job_function?></td>				<td><?=$risk_type_name?></td>				<td bgcolor='<?=$risk_level_bg?>' align='center'><?=$risk_level?></td>				<td><font color='<?=csa_status_color($row2['is_finish'])?>' style='font-weight: bold'><?=csa_status($row2['is_finish'])?></font></td>			</tr><?					}				} else {		?>						<tr>				<td colspan='8'>-ยังไม่มีข้อมูล-</td>			</tr><?				}?>			</tbody>			</table>			<div>			<span style='background: #ffdddd; border: 1px solid #000000; width: 20px; display:inline-block;'>&nbsp;</span> = รายการประเมินตามประเด็นที่ตรวจพบ			</div>			<br>			<br><? if ($is_confirm==0) {?>						<a href='csa_user.php?action=add&add_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>&period=<?=$period?>' class="btn blue btn-default"><i class='fa fa-plus-circle'></i> เพิ่มกิจกรรม </a><? 		if ($period==1) {?>						<a href='csa_user.php?action=add_copy&add_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>&period=<?=$period?>' class="btn blue btn-default"><i class='fa fa-copy'></i> เพิ่มกิจกรรม โดยคัดลอกจากปีก่อน</a><?		} else if ($period==2) {?>			<a href='csa_user.php?action=add_copy2&add_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>&period=<?=$period?>' class="btn blue btn-default"><i class='fa fa-copy'></i> เพิ่มกิจกรรม โดยคัดลอกจากครั้งที่ 1</a><?		}?><?}?>			<br>			<br>			<br>			<?=gen_comment_history_part($view_dep_id, 2)?>			<br>				</div>				<div class="tab-pane active" id="tab2">		<?$is_pass_all = gen_job_function($dep_id, $view_dep_id, $view_year, $period)?>		<?$is_pass_all2 = gen_audit_table($dep_id, $view_dep_id, $view_year, $period)?><br>				</div>
		<div class="tab-pane" id="tab3">			<br>			<?=gen_audit_history($view_dep_id)?>			<br>		</div>		<div class="tab-pane" id="tab4">			<br>			<?=gen_change_history($view_dep_id)?>					<br>		</div>			</div></div>			
					<? if ($is_reject==1) {?>	
		<div class='row'>		<div class='col-md-8'>							<div class='note note-danger' style='font-size:13px'>		<b>เหตุผลการส่งคืน / สิ่งที่ต้องแก้ไข</b><br>		<?=$reject_reason?>		</div>
<?}?>
		<button type='button' class="btn btn-primary" onClick="document.location='csa_user.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button><? if ($is_confirm==0) {		if ($is_pass_all && $is_pass_all2 && $is_finish_all && count($j_list)>0) {?>			<a href='csa_user.php?confirm_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>&period=<?=$period?>' class="btn btn-success" onClick='return confirm("หากยืนยันแล้วท่านจะไม่สามารถแก้ไขข้อมูลได้อีก ต้องการดำเนินการหรือไม่?")'><i class='fa fa-check'></i> ยืนยันผลประเมิน <?=$row1['dep_name3']?></a><? 		} else {?>			<button class="btn btn-default" disabled><i class='fa fa-check'></i> ยืนยันผลประเมิน <?=$row1['dep_name3']?></button><?			 		}	} else {?> ยืนยันข้อมูลแล้ว<?	}?>			<br>			<br>			<br>			<br>			<br>		</div>		</div>
<?			}		}?>
			<br>		</div>	</div></div>
<?		}	}}echo template_footer();
?>