<?include('inc/include.inc.php');include('csa_function.php');echo template_header();
$q_id = intval($_GET['q_id']);$confirm_csa_dep_id = intval($_GET['confirm_csa_dep_id']);$view_year = intval($_GET['view_year']);$view_dep_id = intval($_GET['view_dep_id']);$view_id = intval($_GET['view_id']);$unlock_id = intval($_GET['unlock_id']);$submit = $_POST['submit'];$print_q_id = intval($_GET['print_q_id']);$print_s21_id = intval($_GET['print_s21_id']);$print_s22_id = intval($_GET['print_s22_id']);$period = intval($_GET['period']);
if ($submit=='confirm_unlock') {	$confirm_unlock_id = intval($_POST['confirm_unlock_id']);	$confirm_unlock_period = intval($_POST['confirm_unlock_period']);		if ($confirm_unlock_id>0 && $confirm_unlock_period>0) {				if ($confirm_unlock_period==1) {			$reject_reason = $_POST['reject_reason'];		} else if ($confirm_unlock_period==2) {			$reject_reason = $_POST['reject_reason2'];		}
		$sql = "SELECT * 			FROM csa_department c			JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id			WHERE 				c.csa_department_id = ? AND 				c.mark_del = '0' AND 				ca.csa_authorize_uid = ? ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('is', $confirm_unlock_id, $user_code);			$stmt->execute();			$result2 = $stmt->get_result();			if ($row2 = mysqli_fetch_assoc($result2)) {				$qx = true;					mysqli_autocommit($connect,FALSE);
				$to_status = 0;				if ($confirm_unlock_period==1) {					$sql = "UPDATE `csa_department` SET 					`is_confirm`=0,					`csa_department_status_id`=?,					`reject_reason`=?,					`reject_date` = now()						WHERE					csa_department_id = ? ";				} else if ($confirm_unlock_period==2) {					$sql = "UPDATE `csa_department` SET 					`is_confirm2`=0,					`csa_department_status_id`=?,					`reject_reason2`=?,					`reject_date2` = now()						WHERE					csa_department_id = ? ";				}												$stmt = $connect->prepare($sql);				if ($stmt) {														$stmt->bind_param('isi', $to_status, $reject_reason, $confirm_unlock_id);					$q = $stmt->execute();					$qx = ($qx and $q);	
					$qx = add_history($qx, $confirm_unlock_id, $to_status, 'ส่งคืน ครั้งที่ '.$confirm_unlock_period.' โดยผู้อนุมัติ');					send_unlock_notification($confirm_unlock_id, $user_id, $reject_reason, $confirm_unlock_period);
					if ($qx) {						mysqli_commit($connect);								echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';						savelog('CSA-APPROVER-UNLOCK|csa_department_id|'.$confirm_unlock_id.'|');					} else {						mysqli_rollback($connect);									echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';					}							}			} else {				echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ไม่พบรายการประเมินที่ขอปลดล็อค</div></b><br></div>';			}		}	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ไม่พบรายการประเมินที่ขอปลดล็อค</div></b><br></div>';	}	} else if ($submit=='save_q') {	$update_id = intval($_POST['update_id']);
	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $update_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$csa_department_id = $row2['csa_department_id'];			$qx = true;				mysqli_autocommit($connect,FALSE);			$q_finish = 1;			$sql = "DELETE FROM csa_questionnaire_data WHERE csa_department_id=? ";			$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('i', $csa_department_id);				$q = $stmt->execute();				$qx = ($qx and $q);				}									$qc_0 = $_POST['qc_0'];			$sql = "INSERT INTO csa_questionnaire_data (csa_department_id, csa_q_topic_id, v_other) VALUES (?,'0',?)";			$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('is', $csa_department_id, $qc_0);				$q = $stmt->execute();				$qx = ($qx and $q);				}			
			$sql = "SELECT * FROM csa_questionnaire_topic WHERE parent_id = '0' AND mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			while ($row1 = mysqli_fetch_array($result1)) {				$sql = "SELECT * FROM csa_questionnaire_topic WHERE parent_id = '$row1[csa_q_topic_id]' AND mark_del = '0' ";				$result3 = mysqli_query($connect, $sql);				while ($row3 = mysqli_fetch_array($result3)) {					$topic_id = $row3['csa_q_topic_id'];					$v0 = intval($_POST['q_'.$topic_id]);					$v1 = $_POST['qc_'.$topic_id];					$sql = "INSERT INTO csa_questionnaire_data (csa_department_id, csa_q_topic_id, v, v_other) VALUES (?,?,?,?)";					$stmt = $connect->prepare($sql);					if ($stmt) {											$stmt->bind_param('iiis', $csa_department_id, $topic_id, $v0, $v1);						$q = $stmt->execute();						$qx = ($qx and $q);						}										if ($v0==0) $q_finish = 0;				}			}
			$sql = "UPDATE csa_department SET q_date = NOW(), q_finish = ? WHERE csa_department_id=? ";			$stmt = $connect->prepare($sql);			if ($stmt) {									$stmt->bind_param('ii', $q_finish, $csa_department_id);				$q = $stmt->execute();				$qx = ($qx and $q);				}						if ($qx) {				mysqli_commit($connect);						echo '<div class=""><b><div class="alert alert-success">ระบบได้บันทึกข้อมูล เรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-PART1-UPDATE|csa_department_id|'.$csa_department_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class=""><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		}	}	
} else if ($submit=='save') {	$update_id = intval($_POST['update_id']);	$job_function_id = intval($_POST['job_function_id']);	$job_function_other = ($_POST['job_function_other']);	$strategy = ($_POST['strategy']);	$csa_responsibility = intval($_POST['csa_responsibility']);	$process = ($_POST['process']);	$activity_obj = ($_POST['activity_obj']);	$activity_event = ($_POST['activity_event']);	$activity_cause = ($_POST['activity_cause']);	$csa_risk_type = intval($_POST['csa_risk_type']);	$csa_risk_type_other = ($_POST['csa_risk_type_other']);	$csa_factor = intval($_POST['csa_factor']);	$csa_factor_other = ($_POST['csa_factor_other']);	$csa_control = implode(',', $_POST['csa_control']);	$csa_control_other = ($_POST['csa_control_other']);	$csa_impact_id1 = intval($_POST['csa_impact_id1']);	$csa_likelihood_id1 = intval($_POST['csa_likelihood_id1']);	$risk_level_1 = intval($_POST['risk_level_1']);	$csa_impact_id2 = intval($_POST['csa_impact_id2']);	$csa_likelihood_id2 = intval($_POST['csa_likelihood_id2']);	$risk_level_2 = intval($_POST['risk_level_2']);	if (isset($_POST['action_plan_type'])) {		$action_plan_type = implode(',', $_POST['action_plan_type']);	}	$action_plan_activity1 = ($_POST['action_plan_activity1']);	$action_plan_owner_position1 = intval($_POST['action_plan_owner_position1']);	$action_plan_dep_id1 = ($_POST['action_plan_dep_id1']);	$action_plan_process1 = ($_POST['action_plan_process1']);	$action_plan_begin_date1 = ($_POST['action_plan_begin_date1']);	$action_plan_end_date1 = ($_POST['action_plan_end_date1']);	$action_plan_budget2 = doubleval(str_replace(',', '', $_POST['action_plan_budget2']));	$action_plan_activity2 = ($_POST['action_plan_activity2']);	$action_plan_dep_id2 = intval($_POST['action_plan_dep_id2']);	$action_plan_process2 = ($_POST['action_plan_process2']);	$action_plan_begin_date2 = ($_POST['action_plan_begin_date2']);	$action_plan_end_date2 = ($_POST['action_plan_end_date2']);		$is_finish = 0;			if ($update_id>0 && $job_function_id>0) {		$qx = true;			mysqli_autocommit($connect,FALSE);		/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);  */		if ($csa_impact_id1>0 && 			$csa_likelihood_id1>0 && 			$risk_level_1>0 && 			$csa_impact_id2>0 && 			$csa_likelihood_id2>0 && 			$risk_level_2>0) {				$is_finish = 1;		}				$sql = "UPDATE `csa` SET 		`job_function_id`=?,		`job_function_other`=?,		`strategy`=?,		`csa_responsibility_id`=?,		`process`=?,		`objective`=?,		`event`=?,		`cause`=?,		`risk_type`=?,		`risk_type_other`=?,		`control`=?,		`control_other`=?,		`factor`=?,		`factor_other`=?, 		`csa_impact_id1`=?,		`csa_likelihood_id1`=?,		`csa_risk_level1`=?,		`csa_impact_id2`=?,		`csa_likelihood_id2`=?,		`csa_risk_level2`=?,		`is_finish`=?,		`last_modify` = now()			WHERE		csa_id = ? ";				$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('ississssisssisiiiiiiii', $job_function_id, $job_function_other, $strategy, $csa_responsibility, $process, $activity_obj, 				$activity_event, $activity_cause, $csa_risk_type, $csa_risk_type_other,$csa_control,$csa_control_other,$csa_factor,$csa_factor_other,				$csa_impact_id1, $csa_likelihood_id1, $risk_level_1, $csa_impact_id2, $csa_likelihood_id2, $risk_level_2, $is_finish,$update_id);			$q = $stmt->execute();			$qx = ($qx and $q);				if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-PART2-UPDATE|csa_id|'.$update_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}						$view_id = $update_id;		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}	} else if ($confirm_csa_dep_id>0) {	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $confirm_csa_dep_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {
			$qx = true;				mysqli_autocommit($connect,FALSE);
			$to_status = 2;						$sql = "UPDATE csa_department SET 			is_head1_confirm = '1',			head1_confirm_date = NOW(), 			csa_department_status_id = '$to_status' 			WHERE 			csa_department_status_id=1 AND			csa_department_id='$confirm_csa_dep_id' ";			$q = mysqli_query($connect, $sql);			$qx = ($qx and $q);				
			$qx = add_history($qx, $confirm_csa_dep_id, $to_status, 'อนุมัติ โดย ผอ.');			send_confirm_head_notification($confirm_csa_dep_id, $user_id);						if ($qx) {				mysqli_commit($connect);						echo '<div class=""><b><div class="alert alert-success">ระบบได้บันทึกข้อมูล เรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-APPROVER-APPROVE|csa_department_id|'.$confirm_csa_dep_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class=""><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}					}	}		} else if ($q_id>0) {	$sql = "SELECT * 		FROM csa_department c		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			c.mark_del = '0' AND 			ca.csa_authorize_uid = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $q_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$lock_tag = '';			$csa_department_id = $row2['csa_department_id'];			$csa_department_status_id = $row2['csa_department_status_id'];			if ($csa_department_status_id>1) {				$lock_tag = 'disabled';			}			$sql = "SELECT 				csa_q_topic_id, q_help			FROM csa_questionnaire_topic			WHERE 				parent_id <> '0' AND				mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			while ($row1 = mysqli_fetch_array($result1)) {?><input type='hidden' id='q<?=$row1['csa_q_topic_id']?>' value='<?=html2text($row1['q_help'])?>'><?			}			?><style>.csa_qtopic {	}.tr_sm tr, .tr_sm td {	padding: 2px !important;}input[type=radio] {    border: 0px;    width: 100%;    height: 20px;}</style><script>function show_hint(n) {	tp = '<B>'+$('#t1_'+n).html()+" "+$('#t2_'+n).html()+'</B>';	v = $('#q'+n).val();	/*$('#modal_title').html("ข้อมูลเพิ่มเติม");*/	$('#modal_title').html(tp);	$('#modal_desc').html(v);	var modal = $('#kt_modal_1');	modal.modal('show');}$(function () {	$("textarea").keyup(function(e) {		while($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {			$(this).height($(this).height()+1);		};	}).keyup();	$(".r1").mousedown(function () {		$(this).attr('previous-value', $(this).prop('checked'));	});	$(".r1").click(function () {		var previousValue = $(this).attr('previous-value');		if (previousValue == 'true')			$(this).prop('checked', false);	});});  </script><div class="modal fade bs-modal-lg" id="kt_modal_1" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">	<div class="modal-dialog modal-lg" role="document">		<div class="modal-content">			<div class="modal-header">				<h5 class="modal-title" id="modal_title">คำแนะนำ</h5>				<button type="button" class="close" data-dismiss="modal" aria-label="Close">				</button>			</div>			<div class="modal-body" id="modal_desc">				<p></p>			</div>			<div class="modal-footer">				<button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>			</div>		</div>	</div></div><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">ตอบแบบประเมิน ส่วนที่ 1</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_id=<?=$edit_id?>&view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<form method='post' action='csa_approve.php?view_year=<?=$view_year?>' id='f1' onsubmit='return checkform()'>
			<table class='table table-hover'>			<thead>			<tr align='center' style='font-weight: bold; color:#ffffff' bgcolor='#20689f'>				<td width='5%'>ข้อ</td>				<td width='60%'>รายการ</td>				<td width='5%'></td>				<td width='10%'>มีการปฏิบัติครบถ้วน</td>				<td width='10%'>มีการปฏิบัติบางส่วน</td>				<td width='10%'>ไม่มีการปฏิบัติ</td>			</tr>			</thead>			<tbody><?	$q_result = array();	$sql = "SELECT * FROM csa_questionnaire_data WHERE csa_department_id = '$csa_department_id' ";	$result2 = mysqli_query($connect, $sql);	while ($row2 = mysqli_fetch_array($result2)) {		$q_result[$row2['csa_q_topic_id']] = array($row2['v'], $row2['v_other']);	}			$i=1;		$sql = "SELECT 		*	FROM csa_questionnaire_topic	WHERE 		parent_id = '0' AND		mark_del = '0' 	ORDER BY		q_no, q_name ";	$result2 = mysqli_query($connect, $sql);	if (mysqli_num_rows($result2)>0) {		while ($row2 = mysqli_fetch_array($result2)) {?>			<tr style='font-weight: bold' bgcolor='#fee404'>				<td qid='<?=$row2['csa_q_topic_id']?>' class='csa_qtopic' style='font-size: 20px;'><?=$row2['q_no']?></td>				<td qid='<?=$row2['csa_q_topic_id']?>' class='csa_qtopic' style='font-size: 20px;'><?=$row2['q_name']?></td>				<td></td>				<td></td>				<td></td>				<td></td>			</tr><?			$sql = "SELECT 				*			FROM csa_questionnaire_topic			WHERE 				parent_id = '$row2[csa_q_topic_id]' AND				mark_del = '0' 			ORDER BY				q_no, q_name ";			$result3 = mysqli_query($connect, $sql);			while ($row3 = mysqli_fetch_array($result3)) {				$v0 = $q_result[$row3['csa_q_topic_id']][0];				$v1 = $q_result[$row3['csa_q_topic_id']][1];?>			<tr class='tr_sm'>				<td qid='<?=$row3['csa_q_topic_id']?>' class='csa_qtopic' id='t1_<?=$row3['csa_q_topic_id']?>'><?=$row3['q_no']?></td>				<td qid='<?=$row3['csa_q_topic_id']?>' class='csa_qtopic' id='t2_<?=$row3['csa_q_topic_id']?>' style='cursor:pointer' onClick='show_hint("<?=$row3['csa_q_topic_id']?>")'>					<?=$row3['q_name']?>				</td>				<td style='cursor:pointer' onClick='show_hint("<?=$row3['csa_q_topic_id']?>")'><button type='button' class='btn btn-default'><i class='fa fa-search'></i></button></td>				<td align='center'><input type='radio' class='r1' name='q_<?=$row3['csa_q_topic_id']?>' value='3' <?if ($v0==3) echo 'checked'?> <?=$lock_tag?>></td>				<td align='center'><input type='radio' class='r1' name='q_<?=$row3['csa_q_topic_id']?>' value='2' <?if ($v0==2) echo 'checked'?> <?=$lock_tag?>></td>				<td align='center'><input type='radio' class='r1' name='q_<?=$row3['csa_q_topic_id']?>' value='1' <?if ($v0==1) echo 'checked'?> <?=$lock_tag?>></td>			</tr><?							}		}	} else {		?>						<tr>				<td colspan='3'>-ยังไม่มีข้อมูล-</td>			</tr><?	}?>			</tbody>			</table>			<br>					<b>อธิบายเพิ่มเติม </b><br>			<textarea class='form-control' rows='3' name='qc_0'><?=$q_result[0][1]?></textarea>
			<br>			<br>			หมายเหตุ : ชุดคำถามอ้างอิงจาก สำนักงานคณะกรรมการกำกับหลักทรัพย์และตลาดหลักทรัพย์ (ก.ล.ต.)			<br>			<br>			<br>			<br>			<?=gen_comment_history_part($csa_department_id, 1)?>			<br>						<br>			<input type='hidden' name='update_id' value='<?=$q_id?>'>			<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_id=<?=$edit_id?>&view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>						<button type='submit' name='submit' value='save_q' class="btn btn-success"  <?=$lock_tag?>><i class='fa fa-save'></i> บันทึก</button>			</form>		</div>	</div></div><?		}				}	echo template_footer();	exit;		
} else if ($unlock_id>0 && $period>0) {	/*mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */
	$sql = "SELECT 			c.*,			d1.department_name AS dep_name1,			d2.department_name AS dep_name2,			d3.department_name AS dep_name3		FROM csa_department c		LEFT JOIN department d1 ON c.department_id = d1.department_id		LEFT JOIN department d2 ON c.department_id2 = d2.department_id		LEFT JOIN department d3 ON c.department_id3 = d3.department_id		JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id		WHERE 			c.csa_department_id = ? AND 			ca.csa_authorize_uid = ? AND 			c.mark_del = '0' ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $unlock_id, $user_code);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$dep1 = $row2['dep_name1'];			$dep2 = $row2['dep_name2'];			$dep3 = $row2['dep_name3'];						if ($period==1) {				$rj_reason = $row2['reject_reason'];			} else if ($period==2) {				$rj_reason = $row2['reject_reason2'];			}?>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">ส่งคืน รายการประเมิน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<div class='well'>			<b>				<?=$dep2?><br>				<?=$dep3?></b>			</div>			<br>						<form method='post' action='csa_approve.php?view_year=<?=$view_year?>' id='f1'>			<div class="form-group">			  <label  class='label1'>ความเห็น / เหตุผลการส่งคืน</label>				<textarea class="form-control" placeholder="โปรดระบุเหตุผล" name='reject_reason' rows='5' required><?=$rj_reason?></textarea>			</div>						
			<input type='hidden' name='confirm_unlock_id' value='<?=$unlock_id?>'>			<input type='hidden' name='confirm_unlock_period' value='<?=$period?>'>			<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_dep_id=<?=$unlock_id?>&view_year=<?=$view_year?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type='submit' name='submit' value='confirm_unlock' class="btn btn-danger"><i class='fa fa-unlock'></i> ยืนยันการส่งคืน</button>			</form>		</div>	</div></div><?		}				}	echo template_footer();	exit;			} else if ($view_id>0 && $period>0) {
	$sql = "SELECT 		c.*,		r.is_other as risk_is_other,		r.risk_type_name,		j.job_function_no,		j.job_function_name,		f1.csa_factor_id AS csa_factor_id1,		f2.csa_factor_id AS csa_factor_id2,		f2.is_other as factor_is_other,		f2.factor as factor_name,		rs.responsibility_desc as responsibility_desc	FROM csa c	LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'	LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'	LEFT JOIN csa_factor f1 ON c.factor = f1.csa_factor_id AND f1.mark_del = '0'	LEFT JOIN csa_factor f2 ON f1.parent_id = f2.csa_factor_id  AND f2.mark_del = '0'	LEFT JOIN csa_responsibility rs ON c.csa_responsibility_id = rs.csa_responsibility_id AND rs.mark_del = '0'	WHERE 		csa_id = ? ";		$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $view_id);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {			$is_confirm = 0;			$csa_dep_id = $row2['csa_department_id'];						$factor1 = $row2['csa_factor_id2'];			$factor2 = $row2['csa_factor_id1'];						$sql = "SELECT 					c.*,					d1.department_name AS dep_name1,					d2.department_name AS dep_name2,					d3.department_name AS dep_name3				FROM csa_department c				LEFT JOIN department d1 ON c.department_id = d1.department_id				LEFT JOIN department d2 ON c.department_id2 = d2.department_id				LEFT JOIN department d3 ON c.department_id3 = d3.department_id				WHERE 					c.csa_department_id = '$csa_dep_id' AND 					c.mark_del = '0' ";			$result1 = mysqli_query($connect, $sql);			if ($row1 = mysqli_fetch_array($result1)) {				$dep1 = $row1['dep_name1'];				$dep2 = $row1['dep_name2'];				$dep3 = $row1['dep_name3'];				$dep_id = $row1['department_id3']; 				$csa_year = $row1['csa_year']; 											if ($period==1) {					$is_confirm = $row1['is_confirm'];				} else if ($period==2) {					$is_confirm = $row1['is_confirm2'];				}							$lock_tag = 'disabled';
								if ($row2['job_function_id']==999999) 					$job_function = 'อื่นๆ : '.$row2['job_function_other'];				else					$job_function = $row2['job_function_no'].' '.$row2['job_function_name'];								if ($row2['risk_is_other']==1) 					$risk_type_name = $row2['risk_type_name'].': '.$row2['risk_type_other'];				else					$risk_type_name = $row2['risk_type_name'];								if ($row2['factor_is_other']==1) 					$factor_name = $row2['factor_name'].': '.$row2['factor_other'];				else					$factor_name = $row2['factor_name'];								$control = '';				$sql="SELECT * FROM csa_control WHERE mark_del = '0' AND csa_control_id IN ($row2[control])  ORDER BY is_other, csa_control_id ";				$result1=mysqli_query($connect, $sql);				while ($row1 = mysqli_fetch_array($result1)) {						if ($row1['is_other']==1) 						$control .= '- '.$row1['control_name'].': '.$row2['control_other'].'<BR>';					else						$control .= '- '.$row1['control_name'].'<BR>';				}?>
<style>.tr_sm tr, .tr_sm td {	padding: 2px !important;}.label1 {	background-color : #fbe0c4;	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}.label2 {	color: #004c85;	font-weight: bold;	width: 100%;	padding: 5px;	font-size: 18px;}</style><link href="jquery-ui-1.12.0/jquery-ui.css" rel="stylesheet"><script src="jquery-ui-1.12.0/jquery-ui.js"></script><script language='JavaScript'>var maxc = 1000000000;
<?	echo "\n risk_mat = {}; \n";		$d = array();	$sql2="SELECT * FROM `csa_risk_matrix` ";	$result3=mysqli_query($connect, $sql2);	while ($row3 = mysqli_fetch_array($result3)) {		$d[$row3['csa_impact_id']][$row3['csa_likelihood_id']] = $row3['csa_risk_level']; 	}?>
risk_mat = [<?	for ($i=1; $i<=5; $i++) {		if ($i==1) 			echo '[';		else 			echo ',[';		for ($j=1; $j<=5; $j++) {			if ($j>1) echo ',';			echo $d[$i][$j];		}		echo "]\n";	}?>];
function risk_level_color(r) {	switch (r) {		case 0: return '';		case 1: return '#00ff00';		case 2: return '#ffff00';		case 3: return '#ff9900';		case 4: return '#ff0000';	}}function risk_level_name(r) {	switch (r) {		case 0: return '';		case 1: return 'ต่ำ';		case 2: return 'ปานกลาง';		case 3: return 'สูง';		case 4: return 'สูงมาก';	}}function risk_level_acceptable(r) {	if  (r>=3) 		return 'ไม่เพียงพอ';	else		return 'เพียงพอ';}function risk_level_acceptable_color(r) {	if  (r>=3) 		return '#ff0000';	else		return '#00ff00';}
function cal_level(w) {	var i = parseInt($('#csa_impact_id'+w).val())-1;	var j = parseInt($('#csa_likelihood_id'+w).val())-1;		if (isNaN(i) || isNaN(j)) {		$('#risk_level_'+w+'_div').css('background-color', '#ffffff');		$('#risk_level_'+w+'_div').html('');		$('#risk_level_'+w+'_txt').val(0);		$('#risk_level_'+w+'_1_div').html('');		$('#risk_level_'+w+'_1_div').css('background-color', '#ffffff');	} else {		lv = risk_mat[i][j];		$('#risk_level_'+w+'_div').css('background-color', risk_level_color(lv));		$('#risk_level_'+w+'_div').html(risk_level_name(lv));		$('#risk_level_'+w+'_txt').val(lv);		$('#risk_level_'+w+'_1_div').html(risk_level_acceptable(lv));		$('#risk_level_'+w+'_1_div').css('background-color', risk_level_acceptable_color(lv));	}	check_action_plan_div();}function check_action_plan_div() {	var i = parseInt($('#csa_impact_id2').val())-1;	var j = parseInt($('#csa_likelihood_id2').val())-1;	if (!isNaN(i) && !isNaN(j) && i>=0 && j>=0) {		lv = risk_mat[i][j];		if (lv>=3) {			$('#action_plan_div').show();		} else {			$('#action_plan_div').hide();		}	}}
function checkform() {	var v = $('input[name=job_function_id]:checked', '#f1').val();	if (v==999999 && $('#job_function_other').val()=='') {		alert('กรุณาระบุ ขอบเขตหน้าที่ ความรับผิดชอบกลุ่มงาน อื่นๆ');		$('#job_function_other').focus();		return false;	}		var v = $('div.checkbox-group.require :checkbox:checked').length;	if (v==0) {		alert('กรุณาระบุ การควบคุมที่มีอยู่');		$('input[name^=csa_control]')[0].focus();		return false;	} else {		var has_other = 0;		$(".csa_control").each(function() {			var is_other = $(this).attr('is_other');			v = $(this).is(":checked");			if (is_other==1 && v) has_other = 1;		});					if (has_other>0 && $('#csa_control_other').val()=='') {			alert('กรุณาระบุ การควบคุมที่มีอยู่อื่นๆ');			$('#csa_control_other').focus();			return false;		}			}	var i1 = parseInt($('#csa_impact_id1').val());	var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());	var l2 = parseInt($('#csa_likelihood_id2').val());		if (i2>i1) {		alert('ผลกระทบหลังการควบคุม ต้องไม่เกินผลกระทบก่อนการควบคุม');		$('#csa_impact_id2').focus();		$('#csa_impact_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_impact_id2').css("border","");	}	if (l2>l1) {		alert('โอกาสหลังการควบคุม ต้องไม่เกินโอกาสก่อนการควบคุม');		$('#csa_likelihood_id2').focus();		$('#csa_likelihood_id2').css("border","solid 1px red");		return false;	} else {		$('#csa_likelihood_id2').css("border","");	}		return true;}
function check_csa_factor_other() {	var has_other = $("#csa_factor2 option:selected").attr("is_other");	if (has_other>0) {		$('#csa_factor_other').show();	} else {		$('#csa_factor_other').hide();	}		}
function check_csa_control_other() {	var has_other = 0;	$(".csa_control").each(function() {		var is_other = $(this).attr('is_other');		v = $(this).is(":checked");		if (is_other==1 && v) has_other = 1;	});			if (has_other>0) {		$('#csa_control_other_div').show();		$("textarea").keyup();	} else {		$('#csa_control_other_div').hide();	}}function month_name(m) {	switch (parseInt(m)) {		case 1: return 'ม.ค.';		case 2: return 'ก.พ.';		case 3: return 'มี.ค.';		case 4: return 'เม.ย.';		case 5: return 'พ.ค.';		case 6: return 'มิ.ย.';		case 7: return 'ก.ค.';		case 8: return 'ส.ค.';		case 9: return 'ก.ย.';		case 10: return 'ต.ค.';		case 11: return 'พ.ย.';		case 12: return 'ธ.ค.';	}}
$(function () {	save_tab();	$('#job_function_id').change(function() {		var j = $(this).val();		if (j==999999) {			$('#job_function_other_div').show();		} else {			$('#job_function_other_div').hide();		}			}).change();			$('#activity_type').change(function() {		var v = $(this).is(':checked');		if (v) {			$('#csa_audit_div').show();		} else {			$('#csa_audit_div').hide();			$('#csa_audit_id').val('');		}	}).change();				$('#csa_impact_id1, #csa_likelihood_id1').change(function() {		cal_level("1");	}).change();	$('#csa_impact_id2, #csa_likelihood_id2').change(function() {		cal_level("2");	}).change();
	var csa_factor_old = parseInt($("#csa_factor_old").val());		$('.csa_control').on('click', function() {		check_csa_control_other();	});	
	var csa_factor_old1 = parseInt($("#csa_factor_old1").val());	var csa_factor_old2 = parseInt($("#csa_factor_old2").val());	$("#csa_risk_type").change(function() {		$("#csa_factor_div1").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');		$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');				var rt = parseInt($("#csa_risk_type").val());		$.post( "jobfunction_content.php", { action: 'risktype', parent:rt, data:csa_factor_old1, lv: 1, is_disable: 'disabled'})		.done(function( data ) {			$("#csa_factor_div1").html(data);			$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- โปรดเลือกตัวเลือกก่อน ---</option></select>');						$("#csa_factor1").change(function() {				$("#csa_factor_div2").html('<select class="form-control" required disabled><option>--- กรุณารอ ---</option></select>');				var d = parseInt($("#csa_factor1").val());				$.post( "jobfunction_content.php", { action: 'risktype', parent:d, data:csa_factor_old2, lv: 2, is_disable: 'disabled'})				.done(function( data ) {					$("#csa_factor_div2").html(data);					$('#csa_factor2').change(function() {						check_csa_factor_other();					}).change();					});			}).change();		});		$('#csa_factor_other').hide();	}).change();			check_csa_factor_other();	check_csa_control_other();		$("textarea").keyup(function(e) {		if ($(this).val()!='') {			while($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {				$(this).height($(this).height()+1);			};		}	}).keyup();		$(".datepicker-th").datepicker({ 		changeMonth: true,		changeYear: true,			yearRange: '-10:+10',		dateFormat: 'yy-mm-dd', 		dayNames: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'],		dayNamesMin: ['อา','จ','อ','พ','พฤ','ศ','ส'],		montdocames: ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'],		monthNamesShort: ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.']	});		$('.key-numeric').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		if (this.value>maxc) this.value=maxc;		$(this).val(function(index, value) {			/*return value			.replace(/\D/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");*/			return value			.replace(/[^\d.]+/g, "")			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");		});			});		$('.key-numeric2').bind("paste",function(e) {		e.preventDefault();	});    $('.key-numeric2').keypress(function(e) {		var verified = (e.which == 8 || e.which == undefined || e.which == 0) ? null : String.fromCharCode(e.which).match(/[^0-9]/);		if (verified) {e.preventDefault();}    });	    $('.key-numeric2').keyup(function () {		if(event.which >= 37 && event.which <= 40) return;		if (this.value != this.value.replace(/[^0-9\.]/g, '')) {		   this.value = this.value.replace(/[^0-9\.]/g, '');		}		$(this).val(function(index, value) {			return value			.replace(/\D/g, "");		});			});	    $('#action_plan_begin_date1, #action_plan_end_date1').change(function () {			if ($("#action_plan_begin_date1").val()!='' && $("#action_plan_end_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var d2 = $("#action_plan_end_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date1").val('');				$("#action_plan_end_date1_div").html('');							}		}				if ($("#action_plan_begin_date1").val()!='') {			var d1 = $("#action_plan_begin_date1").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date1_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date1").val()!='') {			var d2 = $("#action_plan_end_date1").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date1_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}	}).change();	    $('#action_plan_begin_date2, #action_plan_end_date2').change(function () {			if ($("#action_plan_begin_date2").val()!='' && $("#action_plan_end_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var d2 = $("#action_plan_end_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			if (dd2<dd1) {				alert('เกิดข้อผิดพลาด ท่านเลือกวันที่ไม่ถูกต้อง');				$("#action_plan_end_date2").val('');				$("#action_plan_end_date2_div").html('');			}		}				if ($("#action_plan_begin_date2").val()!='') {			var d1 = $("#action_plan_begin_date2").val().split("-");			var dd1 = new Date(d1[0], d1[1] - 1, d1[2]);			$("#action_plan_begin_date2_div").html(d1[2]+' '+month_name(d1[1])+' '+((parseInt(d1[0])+543)));		}		if ($("#action_plan_end_date2").val()!='') {			var d2 = $("#action_plan_end_date2").val().split("-");			var dd2 = new Date(d2[0], d2[1] - 1, d2[2]);			$("#action_plan_end_date2_div").html(d2[2]+' '+month_name(d2[1])+' '+((parseInt(d2[0])+543)));		}			}).change();			$('.action_plan_type').change(function() {		$('#action_plan_div_1').hide();		$('#action_plan_div_2').hide();		$(".action_plan_type").each(function() {			var v = 0;			if($(this).is(':checked'))				v = $(this).val();				if (v==1) {					$('#action_plan_div_1').show();					init_dep();					refresh_dep();				} 				if (v==2) {					$('#action_plan_div_2').show();				}					});		}).change();	});  var dep_data = [];function is_exist_dep(id_) {	for(let i=0;i<dep_data.length;i++){		if(dep_data[i].id===id_){			return true;		}	}	return false;}	function init_dep() {	var v = $('#action_plan_dep_id1').val();	dep_data = JSON.parse(v);}function refresh_dep() {	$('#action_plan_dep_id1_div ul').empty();	$.each(dep_data, function(i, obj) {		$("#action_plan_dep_id1_div ul").append('<li><a href="JavaScript:del_dep('+obj.id+')">'+obj.name+'</a></li>');	});		$('#action_plan_dep_id1').val(JSON.stringify(dep_data));}function del_dep(i) {<? if ($lock_tag=='disabled') echo 'return false;'?> 	jQuery(dep_data).each(function (index){			if(dep_data[index].id == i){				dep_data.splice(index,1); 				return false; 			}	});	refresh_dep();}function add_dep() {	var v = $('#action_plan_dep_id0').val();	if (v!='') {		if (!is_exist_dep(v)) {			var t = $("#action_plan_dep_id0 option:selected").text();			dep_data.push(				{id: v, name: t}			);					refresh_dep();			$('#action_plan_dep_id0').val('');		} else {			alert('เกิดข้อผิดพลาด ท่านเพิ่มฝ่ายงานซ้ำ');			$('#action_plan_dep_id0').focus();			return false;		}	} else {		alert('กรุณาระบุเลือกฝ่ายงานก่อน');		$('#action_plan_dep_id0').focus();		return false;	}}
function toggle_risk_mat() {  if ( $( "#risk_mat" ).first().is( ":hidden" ) ) {    $( "#risk_mat" ).slideDown( "slow" );  } else {    $( "#risk_mat" ).slideUp();  }}
function save_tab() {	if (location.hash) {	  $('a[href=\'' + location.hash + '\']').tab('show');	}	var activeTab = localStorage.getItem('activeTab');	if (activeTab) {	  $('a[href="' + activeTab + '"]').tab('show');	}
	$('body').on('click', 'a[data-toggle=\'tab\']', function (e) {	  e.preventDefault();	  var tab_name = this.getAttribute('href');	  if (history.pushState) {		history.pushState(null, null, tab_name);	  }	  else {		location.hash = tab_name;	  }	  localStorage.setItem('activeTab', tab_name);
	  $(this).tab('show');	  return false;	});	$(window).on('popstate', function () {	  var anchor = location.hash ||		$('a[data-toggle=\'tab\']').first().attr('href');	  $('a[href=\'' + anchor + '\']').tab('show');	});	}
function activaTab(tab){  $('.nav-tabs a[href="#' + tab + '"]').tab('show');};</script>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-doc font-green"></i>					<span class="caption-subject font-green sbold uppercase">รายการประเมิน</span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>&view_dep_id=<?=$csa_dep_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>
			<div class=''>			<b>				<?=$dep1?><br>				<?=$dep2?><br>				<?=$dep3?></b>			</div>			<br><?	if (is_has_audit_history($csa_dep_id)) { ?>			
<div class='row'>	<div class='col-md-8'>						<div class='note note-danger' style='font-size:13px'>	<?=gen_audit_history($csa_dep_id)?>	</div>	</div>	</div>	<?	}?>			<form method='post' action='csa_approve.php?view_id=<?=$view_id?>&view_year=<?=$view_year?>&period=<?=$period?>' id='f1' onsubmit='return checkform()'>
			<div class="form-group">			  <label  class='label1'>ขอบเขตหน้าที่ความรับผิดชอบของกลุ่มงาน</label>			  <select name='job_function_id' id='job_function_id' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?	$seq = 1;	$sql2="SELECT 		d.*,		d1.department_name AS dep1,		d2.department_name AS dep2,		d3.department_name AS dep3	FROM `job_function` d	LEFT JOIN `department` d1 ON  d.department_id = d1.department_id AND d1.mark_del = '0'	LEFT JOIN `department` d2 ON  d.department_id2 = d2.department_id AND d2.mark_del = '0'	LEFT JOIN `department` d3 ON  d.department_id3 = d3.department_id AND d3.mark_del = '0'	WHERE 		d.parent_id = '0' AND		d.mark_del = '0' AND		d.department_id3 = '$dep_id'	ORDER BY 		job_function_no, job_function_id";	$result1=mysqli_query($connect, $sql2);	while ($row1 = mysqli_fetch_array($result1)) {?>			  			<option value='<?=$row1['job_function_id']?>' <?if ($row2['job_function_id']==$row1['job_function_id']) echo 'selected'?>><?=$seq++?> <?=$row1['job_function_name']?></option><?	}?>			<option value='999999' <?if ($row2['job_function_id']==999999) echo 'selected'?>>อื่นๆ โปรดระบุ</option>			  </select>			</div>				<div class="form-group" id='job_function_other_div' style='display:none'>				<input type="text" class="form-control" placeholder="ระบุกรณี อื่นๆ" name='job_function_other' id='job_function_other' value='<?=$row2['job_function_other']?>' <?=$lock_tag?>>			</div>			<div class="form-group">			  <label  class='label1'>ประเด็นที่ตรวจพบ </label><?$sql="SELECT * FROM csa_audit WHERE csa_year = '$csa_year' AND department_id3='$dep_id' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);if (mysqli_num_rows($result1)>0) {?>								<input type='checkbox' name='activity_type' id='activity_type' value='1' <?if ($row2['activity_type']==1) echo 'checked'?>  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='1'>				<div id='csa_audit_div'>				<select name='csa_audit_id' id='csa_audit_id' class="form-control"  <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_audit_id']?>' <?if ($row1['csa_audit_id']==$row2['csa_audit_id']) echo 'selected'?>><?=$row1['audit_desc']?></option><?} ?>				</select>								</div><?} else {?>				<input type='checkbox' name='activity_type' id='activity_type' value='1' disabled  <?=$lock_tag?>> รายการประเมินตามประเด็นที่ตรวจพบ<br>				<input type='hidden' name='activity_audit_require' id='activity_audit_require' value='0'><?} ?>			</div>									<div class="form-group">			  <label  class='label1'>กลยุทธ์องค์กร</label>				<textarea class="form-control" placeholder="กลยุทธ์องค์กร" name='strategy' rows='2' required <?=$lock_tag?>><?=$row2['strategy']?></textarea>			</div>				<div class="form-group">			  <label  class='label1'>กระบวนการปฏิบัติงาน</label>				<textarea class="form-control" placeholder="กระบวนการปฏิบัติงาน" name='process' rows='2' required <?=$lock_tag?>><?=$row2['process']?></textarea>			</div>						<div class="form-group">			  <label  class='label1'>วัตถุประสงค์</label>				<textarea class="form-control" placeholder="วัตถุประสงค์" name='activity_obj' rows='2' required <?=$lock_tag?>><?=$row2['objective']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>เหตุการณ์ความเสี่ยง</label>				<textarea class="form-control" placeholder="เหตุการณ์ความเสี่ยง" name='activity_event' rows='2' required <?=$lock_tag?>><?=$row2['event']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>สาเหตุที่ทำให้เกิดความเสี่ยง</label>				<textarea class="form-control" placeholder="สาเหตุที่ทำให้เกิดความเสี่ยง" name='activity_cause' rows='2' required <?=$lock_tag?>><?=$row2['cause']?></textarea>			</div>									<div class="form-group">			  <label  class='label1'>ประเภทความเสี่ยง</label>			  <select name='csa_risk_type' id='csa_risk_type' class="form-control" required <?=$lock_tag?>>				<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_risk_type WHERE mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<option value='<?=$row1['csa_risk_type_id']?>' <?if ($row2['risk_type']==$row1['csa_risk_type_id']) echo 'selected'?>><?=$row1['risk_type_name']?></option><?}?>			  			  </select>			</div>				<div class="form-group">			  <label  class='label1'>ปัจจัยเสี่ยง</label>			<input type='hidden' id='csa_factor_old1' value='<?=$factor1?>'>			<input type='hidden' id='csa_factor_old2' value='<?=$factor2?>'>			  			  <div id='csa_factor_div1'>			  <select name='csa_factor' id='csa_factor' class="form-control" required>				<option value=''>--- เลือก ---</option>			  </select>			  </div>			  <div id='csa_factor_div2'>			  <select name='csa_factor' id='csa_factor' class="form-control" required>				<option value=''>--- เลือก ---</option>			  </select>			  </div>			</div>						<div class="form-group" id='csa_factor_other' style='display:none'>				<input type="text" class="form-control" placeholder="โปรดระบุปัจจัยเสี่ยงอื่นๆ" name='csa_factor_other' value='<?=$row2['factor_other']?>' <?=$lock_tag?>>			</div>						<div class="form-group">			  <label  class='label1'>การควบคุมที่มีอยู่</label><br>			  <div class="checkbox-group require"><?$control_array = explode(',', $row2['control']);$sql="SELECT * FROM csa_control WHERE mark_del = '0' ORDER BY is_other, csa_control_id ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>			<label style='margin: 0px'><input type='checkbox' name='csa_control[]' class='csa_control' value='<?=$row1['csa_control_id']?>' is_other='<?=$row1['is_other']?>' <?if (in_array($row1['csa_control_id'], $control_array)) echo 'checked'?> <?=$lock_tag?>> <?=$row1['control_name']?></label><br><?}?>			  			  </select>
				</div>			</div>			<div class="form-group" id='csa_control_other_div' style='display:none'>				<textarea class="form-control" placeholder="โปรดระบุการควบคุมที่มีอยู่อื่นๆ" name='csa_control_other' id='csa_control_other' <?=$lock_tag?>><?=$row2['control_other']?></textarea>			</div>						<br>			<br>						<div class='row'>			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>
				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>ก่อน</u> การควบคุม</b><br><br>
				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id1' id='csa_likelihood_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id1']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id1' id='csa_impact_id1' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id1']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_1_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>							</div>				<div class='col-md-1'></div>
			<div class='col-lg-4 col-md-6 col-sm-10 col-xs-12'>				<div class="">					<b style='font-size: 20px'>การประเมินความเสี่ยง <u>หลัง</u> การควบคุม</b><br><br>				<div class="form-group">					<label  class='label2'>โอกาส</label>					<select name='csa_likelihood_id2' id='csa_likelihood_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_likelihood";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_likelihood_id']?>' <?if ($row2['csa_likelihood_id2']==$row1['csa_likelihood_id']) echo 'selected'?>><?=$row1['csa_likelihood_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ผลกระทบ</label>					<select name='csa_impact_id2' id='csa_impact_id2' class="form-control" <?=$lock_tag?>>						<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM csa_impact";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>						<option value='<?=$row1['csa_impact_id']?>' <?if ($row2['csa_impact_id2']==$row1['csa_impact_id']) echo 'selected'?>><?=$row1['csa_impact_name']?></option><?}?>			  					</select>				</div>				<div class="form-group">					<label  class='label2'>ระดับความเสี่ยง</label>					<div class='alert' id='risk_level_2_div' style='background:#ffffff; padding: 10; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>				<div class="form-group">					<label  class='label2'>ผลการประเมินการควบคุมที่มีอยู่</label>					<div class='alert' id='risk_level_2_1_div' style='background:#ffffff; padding: 10px; height: 40px; font-weight: bold; border: 1px solid #eeeeee'></div>				</div>
				</div>										<br>			<br>			</div>			</div>
			<button type='button' class="btn btn-default" data-toggle="modal" href="#basic"><i class='fa fa-search'></i> ดู Matrix</button>			<br>			<br><?$action_plan_type_array = explode(',', $row2['action_plan_type']);$json1 = array();if ($row2['action_plan_dep_id1']!='') {	$sql="SELECT department_id, department_name FROM department WHERE department_level_id = '4' AND mark_del = '0' AND department_id IN (".$row2['action_plan_dep_id1'].")";	$result1=mysqli_query($connect, $sql);	while ($row1 = mysqli_fetch_array($result1)) {		$json1[] = array(			'id'=> $row1['department_id'],			'name'=> $row1['department_name']		);	}}?>						<div id='action_plan_div' style='display:none'>				<hr>				<div style='background: #dddddd; padding: 15px; font-size: 20px'><b>แผนปฏิบัติการ (Action Plan)</b></div><br><br>				<div class="form-group">				  <label  class='label1'>การตอบสนองหรือจัดการความเสี่ยง</label><br>				</div>								<div class='row'>					<div class='col-md-4' style=''>					<div class='bg-blue bg-font-blue margin-bottom-10' style='padding: 10px; '>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='1' <?if (in_array(1, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ดำเนินการโดยฝ่ายงาน</label><br>					</div>					<div id='action_plan_div_1' class='border-blue margin-bottom-10' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">						<div class="row">							<div class="col-md-12"><label class='label1'>ฝ่ายงานผู้รับผิดชอบ</label></div>						</div>						<div class="row">							<div class="col-md-12">								<div id="action_plan_dep_id1_div">									<ul>									</ul>								</div>															<input type='hidden' id='action_plan_dep_id1' name='action_plan_dep_id1' value='<?=json_encode($json1)?>'>							</div>						</div>						<div class="row">						<div class="col-md-10">							<select name='action_plan_dep_id0' id='action_plan_dep_id0' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id1']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>											<div class="col-md-1"><button type='button' class='btn btn-icon-only red' onClick='add_dep()' <?=$lock_tag?>><i class='fa fa-plus'></i></button></div>											</div>											</div>											<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity1' rows='3' <?=$lock_tag?>><?=$row2['action_plan_activity1']?></textarea>						</div>										<div class="form-group">						  <label  class='label1'>ตำแหน่งผู้รับผิดชอบ</label>						  <select name='action_plan_owner_position1' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option>							<option value='1' <?if ($row2['action_plan_owner_position1']==1) echo 'selected'?>>ผู้จัดการ</option>							<option value='2' <?if ($row2['action_plan_owner_position1']==2) echo 'selected'?>>ผู้อำนวยการ</option>							<option value='3' <?if ($row2['action_plan_owner_position1']==3) echo 'selected'?>>สายงาน</option>						  </select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process1' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process1']?></textarea>						</div>											<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date1' id='action_plan_begin_date1' value='<?=$row2['action_plan_begin_date1']?>' <?=$lock_tag?>></div>							</div>						</div>										<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date1_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date1' id='action_plan_end_date1' value='<?=$row2['action_plan_end_date1']?>' <?=$lock_tag?>></div>							</div>						</div>													</div>					</div>					<div class='col-md-1'></div>					<div class='col-md-4'>					<div class='bg-yellow-lemon bg-font-yellow-lemon margin-bottom-10' style='padding: 10px; '>					<label style='margin: 0px; font-size:20px'><input type='checkbox' name='action_plan_type[]' class='action_plan_type' style='zoom: 2;' value='2' <?if (in_array(2, $action_plan_type_array)) echo 'checked'?> <?=$lock_tag?>> ว่าจ้าง Outsource</label><br>					</div>					<div id='action_plan_div_2' class='border-yellow-lemon' style="padding: 20px; border: 2px solid #fff;">						<div class="form-group">							<label  class='label1'>งบประมาณ</label>							<input type="text" class="form-control key-numeric" placeholder="งบประมาณ" name='action_plan_budget2' value='<?=number_filter2($row2['action_plan_budget2'])?>' <?=$lock_tag?>>						</div>										<div class="form-group">							<label  class='label1'>ชื่อแผนปฏิบัติการ</label>							<textarea class="form-control" placeholder="ชื่อแผนปฏิบัติการ" name='action_plan_activity2' rows='3' <?=$lock_tag?>><?=$row2['action_plan_activity2']?></textarea>						</div>								<div class="form-group">						  <label  class='label1'>ฝ่ายงานผู้ว่าจ้าง</label>							<select name='action_plan_dep_id2' class="form-control" <?=$lock_tag?>>							<option value=''>--- เลือก ---</option><?$sql="SELECT * FROM department WHERE department_level_id = '4' AND mark_del = '0' ";$result1=mysqli_query($connect, $sql);while ($row1 = mysqli_fetch_array($result1)) {?>							<option value='<?=$row1['department_id']?>' <?if ($row2['action_plan_dep_id2']==$row1['department_id']) echo 'selected'?>><?=$row1['department_name']?></option><? } ?>											</select>						</div>						<div class="form-group">						  <label  class='label1'>กิจกรรม / ขั้นตอน</label>							<textarea class="form-control" placeholder="กิจกรรม / ขั้นตอน" name='action_plan_process2' rows='2' <?=$lock_tag?>><?=$row2['action_plan_process2']?></textarea>						</div>						<div class="form-group">							<label  class='label1'>วันที่เริ่มต้น</label>							<div class='row'>							<div class='col-md-6' id='action_plan_begin_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่เริ่มต้น" name='action_plan_begin_date2' id='action_plan_begin_date2' value='<?=$row2['action_plan_begin_date2']?>' <?=$lock_tag?>></div>							</div>						</div>						<div class="form-group">							<label  class='label1'>วันที่สิ้นสุด</label>							<div class='row'>							<div class='col-md-6' id='action_plan_end_date2_div'></div>							<div class='col-md-6'><input type="text" class="form-control datepicker-th" readonly placeholder="วันที่สิ้นสุด" name='action_plan_end_date2' id='action_plan_end_date2' value='<?=$row2['action_plan_end_date2']?>' <?=$lock_tag?>></div>							</div>						</div>					</div>					</div>				</div>										<br>				<br>			</div>						<input type='hidden' name='risk_level_1' id='risk_level_1_txt' value=''>			<input type='hidden' name='risk_level_2' id='risk_level_2_txt' value=''>			<input type='hidden' name='update_id' value='<?=$view_id?>'><script language='JavaScript'>function getCellCenter(table, row, column) {  var tableRow = $(table).find('tr')[row];  var tableCell = $(tableRow).find('td')[column];  var offset = $(tableCell).offset();  var width = $(tableCell).innerWidth();  var height = $(tableCell).innerHeight();  return {    x: offset.left + width / 2,    y: offset.top + height / 2  }}function drawArrow(start, end) {  /*var canvas = document.createElement('canvas');*/  var canvas = document.getElementById('canvas1');  canvas.width = $('body').innerWidth();  canvas.height = $('body').innerHeight();  $(canvas).css('position', 'absolute');  $(canvas).css('z-index', '99999');  $(canvas).css('pointer-events', 'none');  $(canvas).css('top', '0');  $(canvas).css('left', '0');  $(canvas).css('opacity', '1');  $('body').append(canvas);    var ctx = canvas.getContext('2d');  ctx.fillStyle = 'white';  ctx.strokeStyle = 'white';    ctx.beginPath();  ctx.moveTo(start.x, start.y);  ctx.lineTo(end.x, end.y);  ctx.lineWidth = 6;  ctx.stroke();    ctx.beginPath();    ctx.arc(start.x, start.y, 8, 0, Math.PI * 2, false);  ctx.lineWidth = 6;  ctx.fill();  /*ctx.stroke();*/  ctx.beginPath();    var angle = Math.atan2(end.y - start.y, end.x - start.x);  ctx.translate(end.x, end.y);  ctx.rotate(angle);  ctx.moveTo(0, 0);  ctx.lineTo(-20, -10);  ctx.lineTo(-20, 10);  ctx.lineTo(0, 0);  ctx.fill();  ctx.setTransform(1, 0, 0, 1, 0, 0);    return canvas;}function drawArrowOnTable(table, startRow, startColumn, endRow, endColumn) {  drawArrow(    getCellCenter($(table), startRow, startColumn),    getCellCenter($(table), endRow, endColumn)  );}function draw_arrow_matrix(y1, x1, y2, x2) {	var start_x = 0;	var start_y = 2;	drawArrowOnTable('#table_mat', start_y+y1, start_x+x1, start_y+y2, start_x+x2);}$(function () {	$('#basic').on('shown.bs.modal', function (e) {		var i1 = parseInt($('#csa_impact_id1').val());		var l1 = parseInt($('#csa_likelihood_id1').val());		var i2 = parseInt($('#csa_impact_id2').val());		var l2 = parseInt($('#csa_likelihood_id2').val());		if (i1>0 && l1>0 && i2>0 && l2>0) {			draw_arrow_matrix(5-i1,l1,5-i2,l2);			$('#canvas1').show();		}	});	$('#basic').on('hide.bs.modal', function (e) {		$('#canvas1').hide();	});});  	</script><div class="modal fade" id="basic" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">	<div class="modal-dialog">		<div class="modal-content">			<div class="modal-header">				<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>				<h4 class="modal-title">Risk Matrix</h4>			</div>			<canvas id="canvas1" style='position:absolute'></canvas>			<div class="modal-body"><?=gen_risk_mat()?></div>			<div class="modal-footer">				<button type="button" class="btn dark btn-outline" data-dismiss="modal">ปิด</button>			</div>		</div>		<!-- /.modal-content -->	</div>	<!-- /.modal-dialog --></div>
						</form>		</div>		<br>
						<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>&view_dep_id=<?=$csa_dep_id?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>	</div></div>
<?						}		}	}	echo template_footer();	exit;	
} else if ($view_dep_id>0 && $period>0) {?>	<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">ส่วนที่ 2 แบบประเมินการควบคุมภายใน ครั้งที่ <?=$period?></span>					<span class="caption-helper"></span>				</div>				<div class="actions">					<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>				</div>			</div>			<br><?		
	$sql = "SELECT 		c.*,		d1.department_name AS dep_name1,		d2.department_name AS dep_name2,		d3.department_name AS dep_name3	FROM csa_department c	LEFT JOIN department d1 ON c.department_id = d1.department_id	LEFT JOIN department d2 ON c.department_id2 = d2.department_id	LEFT JOIN department d3 ON c.department_id3 = d3.department_id	JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id	WHERE 		c.is_enable='1' AND		c.csa_department_id = ? AND 		ca.csa_authorize_uid = ? AND 		c.mark_del = '0' ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('is', $view_dep_id, $user_code);		$stmt->execute();		$result1 = $stmt->get_result();		if ($row1 = mysqli_fetch_assoc($result1)) {						$csa_department_status_id = $row1['csa_department_status_id'];			$dep_id = $row1['department_id3'];			if ($period==1) {				$is_confirm = $row1['is_confirm'];				$rj_date = $row1['reject_date'];				$rj_reason = $row1['reject_reason'];			} else if ($period==2) {				$is_confirm = $row1['is_confirm2'];				$rj_date = $row1['reject_date2'];				$rj_reason = $row1['reject_reason2'];			} 			if ($rj_date!='' && $rj_date!='0000-00-00 00:00:00' && $rj_reason!='') {				$is_reject = 1;				$reject_reason = $rj_reason;			} else {				$is_reject = 0;				$reject_reason = '';			}						$is_finish_all = true;
			if ($is_confirm==1) {?>			<div class='row'>			<div class='col-md-1'><i class='fa fa-check-circle' style='font-size:80px; color: green'></i></div>			<div class='col-md-11'>				<b>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?			} else { ?>			<div class='row'>			<div class='col-md-12'>				<b>				<?=$row1['dep_name2']?><br>				<?=$row1['dep_name3']?></b>			</div>			</div>			<br><?			}?>			<div class="tabbable-custom ">	<ul class="nav nav-tabs " id='myTab'>		<li class="active"><a href="#tab2" data-toggle="tab" aria-expanded="false">กิจกรรมที่ต้องประเมินความเสี่ยง</a></li>				<li class=""><a href="#tab1" data-toggle="tab" aria-expanded="true">กิจกรรม</a></li>		<li class=""><a href="#tab3" data-toggle="tab" aria-expanded="false">ประเด็นที่ตรวจพบ</a></li>				<li class=""><a href="#tab4" data-toggle="tab" aria-expanded="false">ประวัติการเปลี่ยนแปลง</a></li>			</ul>	<div class="tab-content">		<br>		<div class="tab-pane " id="tab1">						<table class='table table-hover'>			<thead>			<tr style='font-weight: bold'>				<td width='3%'>ลำดับ</td>				<td width='52%'>กิจกรรม</td>				<td width='20%'>ประเภทความเสี่ยง</td>				<td width='10%'>ระดับ<br>ความเสี่ยง</td>				<td width='25%'>สถานะ</td>			</tr>			</thead>			<tbody><?				$j_list = array(); 				$i=1;					$sql = "SELECT 					c.*,					r.is_other as risk_is_other,					r.risk_type_name,					j.job_function_no,					j.job_function_name,					a.audit_desc				FROM csa c				LEFT JOIN csa_risk_type r ON c.risk_type = r.csa_risk_type_id AND r.mark_del = '0'				LEFT JOIN job_function j ON c.job_function_id = j.job_function_id AND j.mark_del = '0'				LEFT JOIN csa_audit a ON c.activity_type=1 AND c.csa_audit_id = a.csa_audit_id AND a.mark_del = '0'				WHERE 					c.csa_year = '$view_year' AND 					c.csa_period = '$period' AND 					c.mark_del = '0' AND 					c.csa_department_id = '$row1[csa_department_id]' ";				$result2 = mysqli_query($connect, $sql);				if (mysqli_num_rows($result2)>0) {					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];						if ($row2['job_function_id']==999999) 							$job_function = 'อื่นๆ : '.$row2['job_function_other'];						else							$job_function = $row2['job_function_name'];												if ($row2['risk_is_other']==1) 							$risk_type_name = $row2['risk_type_other'];						else							$risk_type_name = $row2['risk_type_name'];												if ($row2['is_finish']==0) $is_finish_all = false;						$risk_level = risk_level_name($row2['csa_risk_level2']);						$risk_level_bg = risk_level_color($row2['csa_risk_level2']);						if ($row2['activity_type']==1) {							$css = 'bgcolor="#ffdddd"';							$job_function.='<BR>('.$row2['audit_desc'].')';						} else							$css = '';					?>			<tr onClick='document.location="csa_approve.php?view_id=<?=$row2['csa_id']?>&view_year=<?=$view_year?>&period=<?=$period?>"' style='cursor: pointer;' <?=$css?>>				<td><?=$i++?></td>				<td><?=$job_function?></td>				<td><?=$risk_type_name?></td>				<td bgcolor='<?=$risk_level_bg?>' align='center'><?=$risk_level?></td>				<td><font color='<?=csa_status_color($row2['is_finish'])?>' style='font-weight: bold'><?=csa_status($row2['is_finish'])?></font></td>			</tr><?					}				} else {		?>						<tr>				<td colspan='8'>-ยังไม่มีข้อมูล-</td>			</tr><?				}?>			</tbody>			</table>						<div>			<span style='background: #ffdddd; border: 1px solid #000000; width: 20px; display:inline-block;'>&nbsp;</span> = รายการประเมินตามประเด็นที่ตรวจพบ			</div>					</div>				<div class="tab-pane active" id="tab2">		<?$is_pass_all = gen_job_function($dep_id, $view_dep_id, $view_year, $period)?>		<?$is_pass_all2 = gen_audit_table($dep_id, $view_dep_id, $view_year, $period)?><br>		</div>
		<div class="tab-pane" id="tab3">			<?=gen_audit_history($view_dep_id)?>		</div>		<div class="tab-pane" id="tab4">			<?=gen_change_history($view_dep_id)?>				</div>			</div></div>					<? if ($is_reject==1) {?>	
		<div class='row'>		<div class='col-md-8'>							<div class='note note-danger' style='font-size:13px'>		<b>เหตุผลการส่งคืน / สิ่งที่ต้องแก้ไข</b><br>		<?=$reject_reason?>		</div>
<?}?>
		<button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>&period=<?=$period?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button><? if ($is_confirm==0) {		echo 'ยังไม่ได้ยืนยันข้อมูล ';	} else {		echo 'ยืนยันข้อมูลแล้ว ';				if ($is_confirm==1 && $csa_department_status_id<=1) { // ยังไม่อนุมัติ?>			<a href='csa_approve.php?unlock_id=<?=$view_dep_id?>&view_year=<?=$view_year?>&period=<?=$period?>' class="btn btn-danger"><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a><?		} else {			echo 'รายการอนุมัติแล้วไม่สามารถส่งคืนได้';		}	}?>			<br>			<br>			<br>			<br>			<br>		</div>		</div>
<?			}		}?>
			<br>		</div>	</div></div>
<?	echo template_footer();	exit;		} else if ($print_q_id>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_q_id=<?=$print_q_id?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part1($print_q_id)?><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_q_id=<?=$print_q_id?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><?	echo template_footer();	exit;		} else if ($print_s21_id>0 && $period>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_s21_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part2_1($print_s21_id, $period)?><br><br><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s21_id=<?=$print_s21_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a>			<?	echo template_footer();	exit;		} else if ($print_s22_id>0 && $period>0) {?><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s22_id=<?=$print_s22_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a><br><br><?=gen_print_part2_2($print_s22_id, $period)?><br><br><button type='button' class="btn btn-primary" onClick="document.location='csa_approve.php?view_year=<?=$view_year?>'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>			<button type="button" class="btn btn-primary" onClick='window.open ("form_print.php?id=print_area","print_form", "addressbar=no,scrollbars=yes,resizable=no,status=no, fullscreen=no,location=no, toolbar=no, menubar=no,top=0,left=0,width=750,height=750");'><i class="fa fa-print"></i> พิมพ์</button>	<a href='csa_user_report_csv.php?print_s22_id=<?=$print_s22_id?>&period=<?=$period?>' class="btn btn-primary"><i class='fa fa-file-excel-o'></i> Export to Excel</a>			<?	echo template_footer();	exit;		}

if ($view_year==0) {	$view_year=date('Y')+543;}?>
<div class='row'>	<div class='col-md-1'>เลือก ปี</div>	<div class='col-md-2'>		<select name='view_year' class="form-control" onChange='document.location="csa_approve.php?view_year="+this.value'>			<option value='<?=$view_year-2?>'><?=$view_year-2?></option>			<option value='<?=$view_year-1?>'><?=$view_year-1?></option>			<option value='<?=$view_year?>' selected><?=$view_year?></option>			<option value='<?=$view_year+1?>'><?=$view_year+1?></option>			<option value='<?=$view_year+2?>'><?=$view_year+2?></option>		<select>	</div></div><br>
<div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class=" icon-bond font-green"></i>					<span class="caption-subject font-green sbold uppercase">รายการประเมิน ที่รอการพิจารณา</span>					<span class="caption-helper"></span>				</div>				<div class="actions">				</div>			</div>			<br>
<?	if ($view_year>0) { 	?>							<table class='table table-hover'>			<thead>			<tr align='center' style='font-weight: bold; color:#ffffff' bgcolor='#20689f'>				<td width='3%'>ลำดับ</td>				<td width='30%'>สังกัดฝ่ายงาน</td>				<td width='25%'>ส่วนที่ 1 แบบสอบถามการควบคุมภายใน</td>				<td width='2%'></td>				<td width='25%' colspan='2'>ส่วนที่ 2 แบบประเมิน CSA</td>				<td width='15%'>สถานะ</td>			</tr>			</thead>			<tbody><?				/* mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); */		$i=1;		$sql = "SELECT 				c.*,				d1.department_name AS dep_name1,				d2.department_name AS dep_name2,				d3.department_name AS dep_name3,				st.csa_department_status_color,				st.csa_department_status_name			FROM csa_department c			LEFT JOIN department d1 ON c.department_id = d1.department_id			LEFT JOIN department d2 ON c.department_id2 = d2.department_id			LEFT JOIN department d3 ON c.department_id3 = d3.department_id			LEFT JOIN csa_authorize_approver ca ON c.csa_department_id = ca.csa_department_id			LEFT JOIN csa_department_status st ON st.csa_department_status_id = c.csa_department_status_id			WHERE 				c.is_enable='1' AND				c.csa_year = ? AND 				c.mark_del = '0' AND 				ca.csa_authorize_uid = ? ";		$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('is', $view_year, $user_code);			$stmt->execute();			$result1 = $stmt->get_result();			if (mysqli_num_rows($result1)>0) {				while ($row1 = mysqli_fetch_assoc($result1)) {								$q_finish = $row1['q_finish'];					$is_enable_part1 = $row1['is_enable_part1'];					$is_enable_period1 = $row1['is_enable_period1'];					$is_enable_period2 = $row1['is_enable_period2'];					$is_enable_part1_require = intval($row1['is_enable_part1_require']);					$is_enable_period1_require = intval($row1['is_enable_period1_require']);					$is_enable_period2_require = intval($row1['is_enable_period2_require']);					$is_confirm = $row1['is_confirm'];					$is_confirm2 = $row1['is_confirm2'];					$csa_department_status_id = $row1['csa_department_status_id'];					$is_finish_all = true;
									$j_list = array();					$j_detail_list = array();					$is_pass_all = false;					$sql = "SELECT job_function_id FROM csa WHERE mark_del = '0' AND csa_department_id = '$row1[csa_department_id]' ";					$result2 = mysqli_query($connect, $sql);					while ($row2 = mysqli_fetch_array($result2)) {						$j_list[] = $row2['job_function_id'];					}										$cnt_require = 0;					$sql = "SELECT * FROM job_function 					WHERE 						(is_require = '1') AND						mark_del = '0' AND 						department_id3 = '$row1[department_id3]' 					ORDER BY 						job_function_no, job_function_id";					$result2 = mysqli_query($connect, $sql);					if (mysqli_num_rows($result2)>0) {						$is_pass_all = true; 						while ($row2 = mysqli_fetch_array($result2)) {							if (in_array($row2['job_function_id'], $j_list)) { 								$j_detail_list[] = '<font color="green"><i class="fa fa-check"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';							} else {								$j_detail_list[] = '<font color="red"><i class="fa fa-times"></i></font> '.$row2['job_function_no'].' '.$row2['job_function_name'].'<BR>';								$is_pass_all = false;							}							$cnt_require++;						}					}
					$cnt_total = array();					$cnt_finish = array();					$sql = "					SELECT  						SUM(case when is_finish = 1 then 1 else 0 end) AS cnt_finish,						COUNT(*) AS cnt_total,						csa_period					FROM csa c					WHERE 						c.csa_year = '$view_year' AND 						c.mark_del = '0' AND 						c.csa_department_id = '$row1[csa_department_id]' 					GROUP BY 						c.csa_period ";					$result2 = mysqli_query($connect, $sql);					while ($row2 = mysqli_fetch_array($result2)) {						$p = $row2['csa_period'];						$cnt_finish[$p] = $row2['cnt_finish'];						$cnt_total[$p] = $row2['cnt_total'];					}?>			<tr>				<td style='border-right: 1px solid #eeeeee' rowspan='2'><?=$i++?></td>				<td style='border-right: 1px solid #eeeeee' rowspan='2'>					<?=$row1['dep_name2']?><br>					<?=$row1['dep_name3']?>				</td>				<td width='25%' rowspan='2'><?					if ($is_enable_part1==1) { ?>					<? if ($q_finish==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ประเมินครบ<br><br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> ยังประเมินไม่ครบ<br>					<? }?>					<br>					<br><?						if ($csa_department_status_id<2) { ?>												<a href='csa_approve.php?q_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn blue btn-default"><i class='fa fa-search'></i> ทำแบบประเมิน</a><br><br><? 						} ?><?						if ($csa_department_status_id>1) {?>					<a href='csa_approve.php?print_q_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แบบประเมิน</a><? 						} else if ($q_finish==1) {?>					<a href='csa_approve.php?print_q_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แบบประเมิน ฉบับร่าง</a><? 						}?><?											} else {						echo 'ยังไม่เปิดให้ทำประเมิน';					}?>				</td><? if ($is_enable_period1==1){?>								<td width='2%' bgcolor='#20689f' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 1</b></font></td>				<td width='15%'>					<? if ($is_confirm==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ยืนยันแล้ว<br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> อยู่ระหว่างจัดทำ<br>					<? }?>					กิจกรรมทั้งหมด : <?=intval($cnt_total[1])?><br>					กิจกรรมที่บังคับ : <?=$cnt_require?><br>					กิจกรรมที่เสร็จ : <?=intval($cnt_finish[1])?><br><br>				</td>				<td width='10%' style='border-right: 1px solid #eeeeee'>					<a href='csa_approve.php?view_dep_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn blue btn-default"><i class='fa fa-search'></i> แสดงแบบประเมิน</a><br><br>					<? if ($is_confirm==1 && $csa_department_status_id<=1) {?>						<a href='csa_approve.php?unlock_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-danger"><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } else if ($csa_department_status_id>1) {?>						<a href='#' class="btn btn-default" disabled title='รายการได้รับการอนุมัติแล้ว ไม่สามารถส่งคืนได้'><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } ?>										<br>					<br>					<? if ($csa_department_status_id>1) {?>					<a href='csa_approve.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน</a><br>					<a href='csa_approve.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ</a><br>					<? } else if ($is_confirm==1) {?>					<a href='csa_approve.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน ฉบับร่าง</a><br>					<a href='csa_approve.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=1' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ ฉบับร่าง</a><br>					<? }?>				</td><?} else {?>								<td width='2%' bgcolor='#aaaaaa' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 1</b></font></td>				<td width='15%'><br>ยังไม่เปิดให้ทำประเมิน<br><br><br></td>				<td width='10%' style='border-right: 1px solid #eeeeee'></td><?}?>								<td rowspan='2'>					<font color='<?=$row1['csa_department_status_color']?>' style='font-weight: bold'><?=$row1['csa_department_status_name']?></font>					<br>					<br><?/*	if ($q_finish==1 && $is_confirm==1  && $is_confirm2==1 && $csa_department_status_id==1) {			<a href='csa_approve.php?confirm_csa_dep_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>' class="btn btn-success" onClick='return confirm("หากยืนยันแล้วท่านจะไม่สามารถแก้ไขข้อมูลได้อีก ต้องการดำเนินการหรือไม่?")'><i class='fa fa-check'></i> อนุมัติการประเมิน</a> 	} else {				if ($is_confirm==0) {?>			ยังไม่สามารถอนุมัติได้<br>			- การประเมินส่วนที่ 2 ครั้งที่ 1 ยังไม่สมบูรณ์<br><? 		} 		if ($is_confirm2==0) {?>			ยังไม่สามารถอนุมัติได้<br>			- การประเมินส่วนที่ 2 ครั้งที่ 2 ยังไม่สมบูรณ์<br><? 		} 		if ($q_finish==0) {?>			ยังไม่สามารถอนุมัติได้<br>			- ขาดการประเมินส่วนที่ 1<br><? 		}	}*/			$p1 = ($is_enable_part1_require==0) || ($is_enable_part1_require==1 && $q_finish==1);	$p21 = ($is_enable_period1_require==0) || ($is_enable_period1_require==1 && $is_confirm==1);	$p22 = ($is_enable_period2_require==0) || ($is_enable_period2_require==1 && $is_confirm2==1);		//echo "[$csa_department_status_id][$p1][$p21][$p22]";	//echo "[$is_enable_part1_require][$q_finish]";		if ($csa_department_status_id<2 && $p1 && $p21 && $p22) {?>			<a href='csa_approve.php?confirm_csa_dep_id=<?=$row1['csa_department_id']?>&add_year=<?=$view_year?>' class="btn btn-success" onClick='return confirm("หากยืนยันแล้วท่านจะไม่สามารถแก้ไขข้อมูลได้อีก ต้องการดำเนินการหรือไม่?")'><i class='fa fa-check'></i> อนุมัติการประเมิน</a><? 	} else {			if ($p21==false) {?>			ยังไม่สามารถอนุมัติได้<br>			- การประเมินส่วนที่ 2 ครั้งที่ 1 ยังไม่สมบูรณ์<br><? 		} 		if ($p22==false) {?>			ยังไม่สามารถอนุมัติได้<br>			- การประเมินส่วนที่ 2 ครั้งที่ 2 ยังไม่สมบูรณ์<br><? 		} 		if ($p1==false) {?>			ยังไม่สามารถอนุมัติได้<br>			- ขาดการประเมินส่วนที่ 1<br><? 		}	}?>				</td>			</tr>			<tr><? if ($is_enable_period2==1){?>								<td width='2%' bgcolor='#20689f' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 2</b></font></td>				<td width='15%'>					<? if ($is_confirm2==1) {?>					<i class='fa fa-check-circle' style='font-size:20px; color: green'></i> ยืนยันแล้ว<br>					<? } else {?>					<i class='fa fa-warning' style='font-size:20px; color: #bdb000'></i> อยู่ระหว่างจัดทำ<br>					<? }?>					กิจกรรมทั้งหมด : <?=intval($cnt_total[2])?><br>					กิจกรรมที่บังคับ : <?=$cnt_require?><br>					กิจกรรมที่เสร็จ : <?=intval($cnt_finish[2])?><br><br>				</td>				<td width='10%' style='border-right: 1px solid #eeeeee'>					<a href='csa_approve.php?view_dep_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn blue btn-default"><i class='fa fa-search'></i> แสดงแบบประเมิน</a><br><br>					<? if ($is_confirm2==1 && $csa_department_status_id<=1) {?>						<a href='csa_approve.php?unlock_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-danger"><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } else if ($csa_department_status_id>1) {?>						<a href='#' class="btn btn-default" disabled title='รายการได้รับการอนุมัติแล้ว ไม่สามารถส่งคืนได้'><i class='fa fa-unlock'></i> ส่งคืนให้แก้ไข</a>					<? } ?>										<br>					<br>					<? if ($csa_department_status_id>1) {?>					<a href='csa_approve.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน</a><br>					<a href='csa_approve.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ</a><br>					<? } else if ($is_confirm2==1) {?>					<a href='csa_approve.php?print_s21_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์รายงาน ฉบับร่าง</a><br>					<a href='csa_approve.php?print_s22_id=<?=$row1['csa_department_id']?>&view_year=<?=$view_year?>&period=2' class="btn btn-default btn-sm"><i class='fa fa-print'></i> พิมพ์แผนปฏิบัติการ ฉบับร่าง</a><br>					<? }?>				</td><?} else {?>								<td width='2%' bgcolor='#aaaaaa' style='writing-mode: vertical-rl; transform: rotate(180deg); text-align: center'><font color='white'><b>ครั้งที่ 2</b></font></td>				<td width='15%'><br>ยังไม่เปิดให้ทำประเมิน<br><br><br></td>				<td width='10%' style='border-right: 1px solid #eeeeee'></td><?}?>				</tr>			<?				}			} else {		?>						<tr>				<td colspan='5'>-ยังไม่มีข้อมูล-</td>			</tr><?			}?>			</tbody>			</table>
<?		}?>			<br>			<br>			<br>		</div>	</div></div>
<?	}?>	<br><br>
<?echo template_footer();?>