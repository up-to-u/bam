<?include('inc/include.inc.php');echo template_header();$action = $_GET['action'];$edit_id = intval($_GET['edit_id']);$del_id = intval($_GET['del_id']);$update_id = intval($_POST['update_id']);$submit = $_POST['submit'];if ($submit=='update' && $update_id>0) {	$risk_type_no = addslashes($_POST['risk_type_no']);	$risk_type_name = addslashes($_POST['risk_type_name']);	$is_other = intval($_POST['is_other']);	if ($risk_type_name!='') {		$qx = true;			mysqli_autocommit($connect,FALSE);				$sql = "UPDATE csa_risk_type SET		`risk_type_no` = ?, 		`risk_type_name` = ?, 		`is_other` = ?, 		`last_modify` = now() 		WHERE csa_risk_type_id = ? ";		$stmt = $connect->prepare($sql);						if ($stmt) {								$stmt->bind_param('ssii', $risk_type_no, $risk_type_name, $is_other, $update_id);			$stmt->execute();			$q = $stmt->execute();			$qx = ($qx and $q);				if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-ADMIN-RISK-RISKTYPE-UPDATE|csa_risk_type_id|'.$update_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		} 	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}		} else if ($submit=='add') {	$risk_type_no = addslashes($_POST['risk_type_no']);	$risk_type_name = addslashes($_POST['risk_type_name']);	$is_other = intval($_POST['is_other']);	if ($risk_type_name!='') {		$qx = true;			mysqli_autocommit($connect,FALSE);				$sql = "INSERT INTO `csa_risk_type` (`risk_type_no`, `risk_type_name`, `is_other`, `create_date`) VALUES 		(?,?,?,now()) ";				$stmt = $connect->prepare($sql);		if ($stmt) {								$stmt->bind_param('ssi', $risk_type_no, $risk_type_name, $is_other);			$q = $stmt->execute();			$qx = ($qx and $q);				$insert_id = mysqli_insert_id($connect);			if ($qx) {				mysqli_commit($connect);						echo '<div class="container"><b><div class="alert alert-success">ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว</div></b><br></div>';				savelog('CSA-ADMIN-RISK-RISKTYPE-ADD|csa_risk_type_id|'.$insert_id.'|');			} else {				mysqli_rollback($connect);							echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';			}		}	} else {		echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด คุณระบุข้อมูลไม่ครบถ้วน ระบบไม่สามารถบันทึกข้อมูลได้</div></b><br></div>';	}			} else if ($del_id>0) {	$qx = true;		mysqli_autocommit($connect,FALSE);		$sql = "UPDATE csa_risk_type SET `mark_del` = 1, `last_modify` = now() WHERE csa_risk_type_id = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $del_id);		$stmt->execute();		$q = $stmt->execute();		$qx = ($qx and $q);					if ($qx) {			mysqli_commit($connect);					echo '<div class="container"><b><div class="alert alert-success">ระบบได้ลบข้อมูลเรียบร้อยแล้ว</div></b><br></div>';			savelog('CSA-ADMIN-RISK-RISKTYPE-DEL|csa_risk_type_id|'.$del_id.'|');		} else {			mysqli_rollback($connect);						echo '<div class="container"><b><div class="alert alert-danger">เกิดข้อผิดพลาด ระบบไม่สามารถลบข้อมูลได้</div></b><br></div>';		}	}	} else if ($edit_id>0) {	$sql="SELECT * FROM `csa_risk_type` WHERE csa_risk_type_id = ? ";	$stmt = $connect->prepare($sql);	if ($stmt) {							$stmt->bind_param('i', $edit_id);		$stmt->execute();		$result2 = $stmt->get_result();		if ($row2 = mysqli_fetch_assoc($result2)) {?><script language='JavaScript'>function confirm_delete() {	if (confirm("โปรดยืนยันว่าคุณแน่ใจที่จะลบ")) {		document.location = "csa_admin_risk_type.php?del_id=<?=$row2['csa_risk_type_id']?>";	}}$(function () {	var d1 = parseInt($("#d1").val());	var d2 = parseInt($("#d2").val());	var d3 = parseInt($("#d3").val());		$("#department_l1").change(function() {		var d = parseInt($("#department_l1").val());		$.post( "jobfunction_content.php", { action: 'd', parent: d, data:d2, lv: 1 })		.done(function( data ) {			$("#d_lv2").html(data);			$("#d_lv3").html("<div class='form-group' id='d_lv3'><label>กลุ่ม</label><select name='department_id3' id='department_l3' class='form-control' disabled></select></div>");			$("#department_l2").change(function() {				var d = parseInt($("#department_l2").val());				if (d>0) {					$.post( "jobfunction_content.php", { action: 'd', parent:d, data: d3, lv: 2 })					.done(function( data ) {						$("#d_lv3").html(data);					});					}			}).change();						});		}).change();	}); </script><section class="panel">	<header class="panel-heading">		<h2 class="panel-title">แก้ไข ประเภทความเสี่ยง</h2>	</header>	<div class="panel-body">		<form method='post' action='csa_admin_risk_type.php'>		<div class="box-body">		<div class="form-group">		  <label>รหัส</label>		  <input type="text" class="form-control" name='risk_type_no' placeholder="รหัส" maxlength='5' value='<?=$row2['risk_type_no']?>'>		</div>		<div class="form-group">		  <label>ชื่อ ประเภทความเสี่ยง</label>		  <input type="text" class="form-control" name='risk_type_name' required placeholder="ชื่อประเภทความเสี่ยง" value='<?=$row2['risk_type_name']?>'>		</div>	<div class="form-group" id='d_lv3'>	  <label>ข้อกำหนดอื่น</label><br>			<input type='checkbox' name='is_other' value='1' <?if ($row2['is_other']==1) echo 'checked'?>> แสดงตัวเลือกอื่นๆ<br>	</div>	<br>		<input type='hidden' name='update_id' value='<?=$row2['csa_risk_type_id']?>'>		<button type='button' class="btn btn-primary" onClick="document.location='csa_admin_risk_type.php'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>		<button type='submit' name='submit' value='update' class="btn btn-success"><i class='fa fa-save'></i> บันทึก</button>		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;		<button type='button' name='button' class='btn btn-danger' onClick='confirm_delete()' id='confirm_btn'><i class='fa fa-times'></i> ลบ</button>	</form>	</div></section>		  <?		}	}		echo template_footer();	exit;	} else if ($action=='add') {?><script language='JavaScript'>$(function () {}); </script><section class="panel">	<header class="panel-heading">		<h2 class="panel-title">เพิ่ม ประเภทความเสี่ยง</h2>	</header>	<div class="panel-body">	<form method='post' action='csa_admin_risk_type.php'>	<div class="form-group">	  <label>รหัส</label>	  <input type="text" class="form-control" name='risk_type_no' placeholder="รหัส" maxlength='5'>	</div>	<div class="form-group">	  <label>ชื่อ ประเภทความเสี่ยง</label>	  <input type="text" class="form-control" name='risk_type_name' placeholder="ประเภทความเสี่ยง" required>	</div>	<div class="form-group" id='d_lv3'>	  <label>ข้อกำหนดอื่น</label><br>			<input type='checkbox' name='is_other' value='1' <?if ($row2['is_other']==1) echo 'checked'?>> แสดงตัวเลือกอื่นๆ<br>	</div>	<br>	<button type='button' class="btn btn-primary" onClick="document.location='csa_admin_risk_type.php'"><i class='fa fa-arrow-circle-left'></i> ย้อนกลับ</button>	<button type='submit' name='submit' value='add' class="btn btn-danger"><i class='fa fa-plus-circle'></i> เพิ่ม</button>	</form>		</div></section>		  <?	echo template_footer();	exit;} ?><div class="row">	<div class="col-lg-12 col-xs-12 col-sm-12">		<div class="portlet light tasks-widget bordered">			<div class="portlet-title">				<div class="caption">					<i class="icon-grid font-green"></i>					<span class="caption-subject font-green sbold uppercase">ประเภทความเสี่ยง</span>					<span class="caption-helper"></span>				</div>				<div class="actions">				</div>			</div><br> <script language='JavaScript'>$(function () {	$('.csa_editable').on('click', function() {		var id = $(this).attr('did');		document.location="csa_admin_risk_type.php?edit_id="+id;	});		});  </script><style>.csa_editable {	cursor: pointer}</style> <table class='table table-hover'><thead><tr>  <th width='5%'>No.</th>  <th width='5%'>รหัส</th>  <th width='85%'>ประเภทความเสี่ยง</th>  <th width='5%'>Other</th></tr></thead><tbody><?	$i = 1;	$sql2="SELECT 		d.*	FROM `csa_risk_type` d	WHERE 		d.mark_del = '0' 	ORDER BY 		risk_type_no, risk_type_name";	$result2=mysqli_query($connect, $sql2);	while ($row2 = mysqli_fetch_array($result2)) {?><tr>	<td width='5%' did='<?=$row2['csa_risk_type_id']?>' class='csa_editable'><?=$i++?></td>	<td width='5%' did='<?=$row2['csa_risk_type_id']?>' class='csa_editable'><?=$row2['risk_type_no']?></td>	<td width='85' did='<?=$row2['csa_risk_type_id']?>' class='csa_editable'><?=$row2['risk_type_name']?></td>	<td width='5%' did='<?=$row2['csa_risk_type_id']?>' class='csa_editable'><?=($row2['is_other']==1) ? '<i class="fa fa-check"></i>' : ''?></td></tr><?	}	?></tbody></table>			                  	<br>	<button type="submit" class="btn btn-danger" onClick="document.location='csa_admin_risk_type.php?action=add'"><i class='fa fa-plus-circle'></i> เพิ่ม</button>		</div></section>	<?echo template_footer();?>